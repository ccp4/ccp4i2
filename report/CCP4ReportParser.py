from __future__ import print_function

# Top class:
# read xml file
# generate html headers
# get root node
# pass node to container element

# Container class:
# loop over elements
# pass each element to appropriate subclass

# Table class:
# produce table

# Graph class:
# produce graph

# Text class:
# produce text

#Questions: does reading cause formatting straight away?
#Or do we store the content for later? Yes.

try:
    from StringIO import StringIO
except ImportError:
    from io import StringIO
import os
#from lxml import etree
import xml.etree.ElementTree as etree

from lxml import html as lxml_html

from core.CCP4ErrorHandling import *
from core.CCP4Modules import PROJECTSMANAGER

XRTNS = "{http://www.ccp4.ac.uk/xrt}"
CCP4NS = "http://www.ccp4.ac.uk/ccp4ns"
# From http://www.w3.org/QA/2002/04/valid-dtd-list.html
DOCTYPE = '''<?xml version="1.0"?>
    <!DOCTYPE html>
    <html xmlns:xsi="http://www.w3.org/1999/xhtml"></html>
    '''
#DOCTYPE = '''<?xml version="1.0" encoding="utf-8"?>\n<!DOCTYPE html>'''

XHTMLNS = "{http://www.w3.org/1999/xhtml}"
CURRENT_CSS_VERSION = '0.1.0'

USEQTICONS = True

WEBGLSOURCES = [
"glMatrix.js",
"pako-master/dist/pako.min.js",
"mgBase64.js",
"lines-fragment-shader.js",
"lines-vertex-shader.js",
"thick-lines-vertex-shader.js",
"pointspheres-fragment-shader.js",
"pointspheres-vertex-shader.js",
"text-fragment-shader.js",
"triangle-fragment-shader.js",
"triangle-vertex-shader.js",
"render-framebuffer-fragment-shader.js",
"twodshapes-vertex-shader.js",
"twodshapes-fragment-shader.js",
"perfect-sphere-fragment-shader.js",
"shadow-vertex-shader.js",
"shadow-fragment-shader.js",
"triangle-shadow-vertex-shader.js",
"triangle-shadow-fragment-shader.js",
"twodshapes-shadow-vertex-shader.js",
"perfect-sphere-shadow-fragment-shader.js",
"pointspheres-shadow-vertex-shader.js",
"pointspheres-shadow-fragment-shader.js",
"mgMaths.js",
"ener_lib.js",
"peptideMonLib.js",
"mgMiniMol.js",
"mgSecStr.js",
"fontHeight.js",
"mgWebGLReadMap.js",
"mgWebGL.js",
"mgWebGLAtomsToPrimitives.js",
"mgWizard.js",
"jscolor.js",
"CIsoSurface.js",
"symop.js"
]

PNGCACHE = {'DataFile': 'data:image/jpeg;base64,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','UnmergedDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAABmJLR0QA/wD/AP+gvaeTAAAA4klEQVRYw+3XOw6EIBAGYBrOQUPDJai9BzWHoeccFnRcwoLLuJOlIRvX8BJZd/6KyEi+qHGA7JOFIAhBfwBSSi15gcoRIM45yQtUjgNZa9fvgdnRoBDCyW0wiyAEFYN4EsYY1FBKeXm6gUindAaFd5xzMIbnFEpyCajlG3oWSEr50bnicnEMs6NBV/SySpD3/rB/xeXSK1A5AtSyHIIQNCtIa93YsA7/CI8DGWMqXtlJV0EQgqYE3bCF/RlQZhpPSAhCEIIQlICEEEt56s6Q92zQ6kHbtq1tKT1D1mzyx2Q60Au+UDZOsIwHjAAAAABJRU5ErkJggg==', 'PhsDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACYAAAAlCAYAAAAuqZsAAAAACXZwQWcAAAAmAAAAJQAs1IvFAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA6/AAAOwwG7j2XeAAABcklEQVRYw+2YQW7CMBBFcz56gRyBHiFSd+2mXCBXyBGyRqyq7Lsgiy4AVWqWYYcwepZGsqyQmtgBq/VilLEzZL5//thDstP5pH6zrutUXdfKJTaUZS5Bx+5bA+v7Pi5g0TImwBJjSWNJY39ZY03T6GdiLDwaxqqqUsvnpVo8LdRP+xWPxrbtVuV5rsqyjENj8qzV6l19fLZaJg/XGKBgCFAwFkVVCqjNehPPPnYrqLswNgXU7BqbCmpWxnxAzaYxNk8qz6dggjIGcEBhHDlRnJUmqGub5kMYQ08cMaGOLW+NmUyJhQDnxZgJCh9D9FMrMYjGbFAyDyjA+epsEmMkL4pi8LUxps867Pb31ZgwQndwTUu+e9jNwDCqb6gVtptAWPMCdjj2Wg+snoRcGZvzJOLVvby+ad++b/4OnwaQrQN/LHZsPhMmxgwtkYira7xo0CV+yDLRiZS76csYIRMsqxuKsX2zGFxy2H76X5m+Xfxbxi5qKCd4+nUifgAAAABJRU5ErkJggg==', 'PhaserRFileDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA6/AAAOwwG7j2XeAAAAB3RJTUUH4wESDx0elUtjagAAAfZJREFUWMPtVz2O8jAQnVibFIDEFaCjooQjUCNK7gHcgCvQIaWkpOUMHCNwgyBiz7yvihXnP9+y2i0y0ihK7PE8j/1mJh4A0C+Loj8gPYgexJ8E8dVlchs2e573eRCp4/wz6zT7zfM8q98+DgBWRcQZExHnW+oQAMVxTLvdjiaTCfm+3w4MSkREICIgIkcHgwEWiwXCMITWGszs2BhjcDgcCnZNUgnCGFNYLKvn8xki4tgxM6bTKYgIl8sF7/cbbaQUBDMjSZLCTqIowna7BRFhPp+XglBKgYigtUZbobIoVIFgZkRRBCJCEATuQjVRa5LKi6mUqqXnaDTqRN3OFK2i2PP5pP1+T0REq9XKAWCMIQDk+353YLVnVRHe5XKJx+MBZoYxBlpry5a2R9B4MetADIdDXK9XB0CSJDDGOLT+OAgAiOMYYRgiCAL4vo/7/W6pnCTJz0ciy5jj8WiPhJnBzDYaWuufBZHu+PV6YTabgYhwOp2csTJafxRE9vLdbjcQEcbjMaIosuNlINISkE9snUGkIWdmu9hmswERYb1elya4rPOsXZl4ZS1/tmynms0d+Wc6l5mtrVLKlvmm8v5VVcJFpJBw8g7KsmxqJyJ2XlN/UZsx8zuta1rSd6VU49yCv7rj+J8WLt9ltRGv/w3sQfQgKuQfPggtDbWv8v0AAAAASUVORK5CYII=', 'MapCoeffsDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA/klEQVRYw8WWSQ5EIQhEOZL3X3kze9WJsQUew/9t4saJgoISERGZMpccY8pc3ynO0M6Qu9eD1LB3dnfCfHPfiBin500Q+2LUOAn1+eaPjXNTEkPzTnOoHUCUc3WvCoBUkAmuCwCprjAAVE6BeykAGTBWguLHzAegarp2PADamstrl5iQ0GaFTEj4KsJT8v4W7hNAmYZKJqPy6v5Q8EfzRg5EyzGlcNYnc+P+LzS0UkH49lQSg/BkllBxK9NQJLKCQhoQlKw0AtnO2KWmCsDLBXMNNY7BKiprREpQNgBjjEVnueXSgGPjLc2EQl3I8yc6YS0S8uS4UfmacSuBNeMf3zvItJO9s0MAAAAASUVORK5CYII=', 'AsuDataFile': 'data:image/jpeg;base64,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', 'PhaserSolDataFile': 'data:image/jpeg;base64,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', 'MapDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAA/klEQVRYw8WWSQ5EIQhEOZL3X3kze9WJsQUew/9t4saJgoISERGZMpccY8pc3ynO0M6Qu9eD1LB3dnfCfHPfiBin500Q+2LUOAn1+eaPjXNTEkPzTnOoHUCUc3WvCoBUkAmuCwCprjAAVE6BeykAGTBWguLHzAegarp2PADamstrl5iQ0GaFTEj4KsJT8v4W7hNAmYZKJqPy6v5Q8EfzRg5EyzGlcNYnc+P+LzS0UkH49lQSg/BkllBxK9NQJLKCQhoQlKw0AtnO2KWmCsDLBXMNNY7BKiprREpQNgBjjEVnueXSgGPjLc2EQl3I8yc6YS0S8uS4UfmacSuBNeMf3zvItJO9s0MAAAAASUVORK5CYII=', 'CootHistoryDataFile': 'data:image/jpeg;base64,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', 'SeqAlignDataFile': 'data:image/jpeg;base64,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', 'ObsDataFile': 'data:image/jpeg;base64,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', 'SeqDataFile': 'data:image/jpeg;base64,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', 'FreeRDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACEAAAAhCAYAAABX5MJvAAAACXZwQWcAAAAhAAAAIQBVvX55AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA6/AAAOwwG7j2XeAAADe0lEQVRYw+2WWSj0YRTGZ8qEksh2QSlLShl3okmUKM2NLHeyhAuyL41ERFK2UKgRsl8oIkW2hKJQsmbJUhJZsow1PF/n1Mj80/eZMVPfxZyai1ned37nnOc85y/CfxAiI4QRwgihD4iPjw88Pz/j8vISh4eH2N7exu7uLo6Pj3FxccHfGQTi5eUFe3t7GB4eRldXF5qampCRkYGUlBRUVFSgs7MTjY2NKC4uRklJCXp7e7Gzs6MfiPf3d+zv76OlpYX/pKenB93d3cjOzoaJiQlcXV1RWVmJhYUFjIyMoLy8HAEBAfDw8EB6ejo2Nzd/B0FlJ4CioiLExcVhbGwMt7e3uL+/ZyCxWAxfX18sLi5+nrm5uUFzczNsbGzg5OSE2tra30Gcnp6itLQUQUFBGBoaYiiKk5MT5OTkMERoaCjOz881zs3NzUEqlcLCwgKpqam/g5iZmYGXlxciIyM5e3Wsr68jLCwMZmZmiI+Px9vbm8a5qakpuLi4wNbWFoWFhbpDPD4+oq2tDc7OzigrK/s2UwcHB66U8FxraysD+vj4YHJyUneI6+trDAwMsOjW1tY0hEqtsbKyYvGRUNVBFaHfRkdHw93dHfX19VCpVLpDPD09ca+Fl9B7Ep5QlDTCKysrrJWIiAgeYaFW9GZWJMrc3FyIRCJ4enqipqaG21ZdXY2EhATWyPj4OO7u7gznmBsbGwgPD4epqSlPTUdHB7fM398fdnZ2yMzMxMPDg2Fte35+Ht7e3nB0dOTsKc7Oztgpzc3NtRaj1hBqUVpbW0Mmk2Fpaenzc5oY0oilpSUSExMZzCAQ5JZ1dXU8GWlpaTyO6ri6uuLKkEHRZLS3tzOc3iFoU1KWgYGBbEhCi19eXkZwcDDrRS6Xs6l9/f719ZWnSGcIEhu1IjY2Fv39/RpV+FoppVLJAqWXQqFgv6GKHBwcYGJigneLVhBEvbW1xau7qqoKMTExyMrK4kU2OzvLmQphqFo0phKJhNtCa35wcBANDQ1sfuQ/P4YgADIiytzNzQ329va8C/z8/LgdUVFRDCe8lM7RzgkJCWHrplWfnJyMvr4+1o1WmqDLqMe0N/Ly8nj+6QEmKSmJM6XFtLq6+u1l5KrT09PIz89HQUEBRkdHNRagVu2gXtKjGl1KvSUbJsc8Ojr6pyXTHiHX/JsGjE/bRggjxE/jD5WhrMPOUgZ7AAAAAElFTkSuQmCC', 'RefmacKeywordFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAIAAADYYG7QAAAABmJLR0QA/wD/AP+gvaeTAAAD5UlEQVRYhe2YTyg8bxzHn5l+jN3N/pnMborYTSlyclCyLReNXJS9jNjSJq3iyMFByYnk6LKbLVobhVCKoiUtG0o5UJa1ya5dqzgo+2ee72H6jcfM7ozf97J+te/bfP6+5pl5PvM0GIQQ/Cbh+QYQqgAkpwKQnApAcvp9QKlUamhoqLy8HMdxDNHS0lJegP5xu93z8/N56Z1VeCwWyzfDN+EMw5SVleUb40u4yWQKBoNbW1sul0uhUOSbBwCISKPR8PbFxUWYD/2+bZ9vAKH+h0DhcLijo0On02HfpdVqaZoOhUIAgIODg8bGRqVSiQZQFMUwzNvbm7jm1dWVxWJRq9VovEajaWtrk3+pe3p6JHC7urpYlqUoKlfA+Pi4+M1tbm7++xWKx+MS3mg0mkwmE4nEf0p/enr6e6D29vZcrqKiopGREYIg+vv7swYoFIqBgQGxfXh4OGs8QRAyj8zr9apUKkGa3W5fWFhYW1t7eHjgc4+Pj1taWviYmpqajY2NSCQCIQyFQo3/ymw2f35+QggvLy9XVlZ0Oh2fYrPZYrFYTiC32z06Oiq+A5fLlWumzc3N8ZEqlSqVSnH2iYkJtMjq6ipnj0QiqH1zcxNCmBNIr9cLaCoqKgKBgMSQvbi4QONPT08hhCzLVlVVoXaaprl4r9fLGzEMe319lQISyGKxPD8/S9BACDOZjFar5VNmZmYghLu7u4JSOI6Hw2EIocPh4I0NDQ1ckR8Nxvr6+r29PfGaiTuZzWb+8ujoCADgcrkEYSzLut1uAIDP5+ONX4k/XKHe3l7uZZTW7Owsn0KS5MvLC0EQ4mrV1dXRaBS1LC8vcxV+CgQAsFgs3GOW0NnZGZqSdc9zGhwcRC8fHx9lgGianpycxDAMTautrQ0GgxJA6XQaLYKm0zRdV1eX1WU0GvkKMnPI4/EI1pyiKL/fL8HU2dmZdUk8Hg/6QFHZbLafAkEIDw8PSZJE80tKSvhZItb09LS4pVqt/vj4iMfjxcXFYq/T6fwG9P7+vr29LTjCoifG6+trk8mElsAwbGxszOl0rq+vc+OYVyAQELe02+2c12q1ir03NzdfQHd3d1m/1YIjrHhq81IoFPv7+3xkOp0uLS0VxPh8Ps67s7MjcOn1erQRmJqaytpGAIR+dMRiGAYNpmka9RqNRpZlOVcmk6msrES93d3daC5uMBgkOqH3IeEVFGltbUUv+/r6+D2F47jgaIDOUgAASCaTDofDYDAIdrhghU5OTpqampRKpQCFJEmr1ZpIJNBgv9+Pxtze3qLe+/t7tNf5+TnqxWDhp6e0CkByKgDJqQAkpwKQnH4d0B+e8Egqx7yRMwAAAABJRU5ErkJggg==', 'DictDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAADAFBMVEWVDg+NIyO5QkKpRUawRkqySkrIT1K/UlK1VlbJVlYAW8MAXQC1XVeRXlMAX9xfYP/HYWMAYuMSYzbPY2MAZJ8YZcAAaQAAa90Aa/LOa2wAbesAbf28bW3cbW25cGYAcenMcnIAc90Ac+IUddy4dXVed0cAeOgLeOUveNUled4Aev7ienoCe/IMfOtCfLUjfujbfn9If9BVf8NMgYuqgYEAgv82gi7Gg4URhPtphL85iN6piIjDiYrji4tQjk9Uj+ltj47lj5B3kYbAkZHvkZA2kv9glVrwlZRcllxyltRGl//Ql5djmGZOmf+cmf+rmZnzmpvom5tunGvFnJxxoG9zoGBjov+NpdNspv/KpqaTqtfKqqr0ra2Xr9yQsY60sf/DsbH1srKgs9uVtJKYtIiTuJfUubmbupXBurr2u7uyvM+Xvf+mv6TXwsOexP+uxK31xMS8xdj/xcjUycnMzf74zc3R0v7W0tL40tLC1LfP1N7c1NTA1f/O2c2+2sn62trQ3dDb3ejh3d3M3//S4P764uLh4+fZ6d7p6efp6f/s7Oz87Ozl7f7p7dzx7urz8e7t8uzy8/P99PT59u/2+Oz1+fn++/b+/v4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACy64R5AAAAAWJLR0T/pQfyxQAAAAlwSFlzAAAAXwAAAF8AXZndiwAAAAl2cEFnAAAAIAAAACAAh/qcnQAAAVlJREFUOMtjmE4AMAxCBa31rQUVBYn1OBXUZ3ZnJgYUdOM2oSCzojQGnxsmYbhhanX1VJj5BYlAkFnaiqxgojWrgXMXiFmRWFAPsru7IjMRyQ3RTLIVBcFAVkwpkr5MOIchmEk20NZ8erc70Nxpff1wFTCPMiQwyAjwqLZPKpo+vdBIU9+zAyoRA3ekCbOwTa2bR92UJEF5U1cvzTaoAqB3Jk4Fe7OpCUjniwlpqen4tvTkGU4GyXe7dE/3lzEvRoRDr56pslZET0+zVCNUJJhVu9S7Gq5gmr2poqlpdk2YlnFoEBCE+MixaRc4RiJC0lILqEDL1FTcKT0ZBFJ5WRQkOTIQChxERJXU1BTVubqgArmM7JwqE6EKJuTYpVhJKevoWkhHwbWUR6d1gR1ZEl/JbdYwvVGDT0tLInwaZoIp82uIA7H7s8Jjq7CmKP4yAkmuc4jlCxooAABdGhkx5vdmCwAAAABJRU5ErkJggg==', 'PdbDataFile': 'data:image/jpeg;base64,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', 'EnsemblePdbDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAAABmJLR0QA/wD/AP+gvaeTAAAAB3RJTUUH5AIcDwUDziyqsQAAFBFJREFUaN6VmneUXdV1xn/ntlfuq9P7jEYaFdRRQxSVJAJjEweIMTYYYYJtcELigjF2CjasLDs4JqQ4CRCKvYhNbMC4AQZkWyAhVJHEMJIYafpo+ptX5vV37z354z41q4D3WmfNWve+c87+zv52OfuO4BzSsODm15oWf/pPdG8Uq5jFG2pEESqF7CRSQik3jjfQgJUfJJ2YJhIV3PfXT/L63it57mdVqQe/8uAN1750xat87+kQ8CxwJRaQBpLlkQEKgA0IwICwA/dfD+EYBIAU8OeKgs/nI57LEXAc0sAO2HI9bAJQzgXAH+2QvvAsDH8d3mATAgWrlGF6cCu5RA/h6rnUNDaxaM0VRBvXMDU6yb3/fC+D/Qm+fNsTofWXDj3q/MfTG/7dIQXcgcVWCkAOyANFwCorL8ubChB5aHDgEtxxhRB4XWzURCKkdJ1fQ/5ZeD5fnqb+vvKXfGIbhez4cbuUu04gPUtXNuDYeQa6fo1QdPyhFqxiGsOQKFqIomUihCAxOcSfbniRu27fidcrI0Kwbo3gQLLAwZ0FtpFjMVlmkSmDKJUBAGiADt6XSC1/A73kIOYpCiEh8DgOim1jqyqDxWLmoJT3PAyP9YN851wApGORTx/P5FMDn7NLGbNk+xkf7EZTi8xfeTW6OQepBLBlmHRinNo6P1IJ49PGuPaqXXS0DZ1YKgps+pDGfn+e/eatpEphromHMciXLeCUOWAA00i1ky9F9rBqFQQahCAoJRbQLWVxuFjctVPK734BHlkKzt+dhv0MWfShp4gNvnY9ktDMxAHGhrpxSjlqmtupqqskMwA+M4BpKszEoVjSmUlO4bX20fVOnItmGbS1Fk8s1wQ8se5fefqiX/EpsYfAA1+F3UtPO321TK0XgVdIVYO9AAg7DhI4CvwcnnwevnQ15MXv6XuWBXreeoDmpXd824zOnusxGzAr5mP4q0mMH2NkYILE6H6K2THs4gxTx98jX9DIxQ8zOVFg97trGBhbxpplnQTMEywlGmhkw6z+aEX7WC0rtiXprYe+Opc2qMAA0AXLR9lyZ5yNrRDQgFGQ++DRfXDvxZD51jn8VT3HM8K1Kzcrmqfd8FUT8Nlk4++QmHgPw19BITOK40hsW2dm6l1yyR5K+QkqmtcRqupgYLiCsVGLq9YfPLmetxKU9TZb+gTdeo75Sdi+GgrRcjRKAFOIu/ezbqllRE1DFyOWxZOwLQa31kH6G5xbzqLQrf8l2fb9rz/vj86+3C6lvQtXtPJ2SkEzTBTVg6JohGtXoHuiqLqJPxghVFFBqeRQKBiY4UaGEzH2vruP9xZ18V75lDJ1Jf7rP2NkNBAzIFPlOKkBPiAEs1VCLdU1mNEwo11daFB4wIV4XjnLApUtnyXatHZQ91bcLm3LnJ4YYrinE82IEK5bQbBqHh6zktzMMEKoOHYRRQ+j+2oo5QooYUGy2aJ3RT8vBi1+RIqtOOwQUDLKm9hlJy6VRwFIw+b9MC9W4ngum92dzw+G4Z4F0L/9AgDOsoAqZrCKRfyBEI43SHw8iWpEEIqGx6yjVEhQKmSxrRy51BCOXSQ1eYRgdBH52uMMbX6Iy2a3cIXxEXzU0sP/McnkqQ2UMvdPHx7XAtKA6UKOQ4Xcf/4a/nEQ0g1cWM5KZON9uxk68gbJ8U6wpjD8VYCDXcoQDKk4VopM/BiOVaSYnSA1tgcz1IKclePYHQ+QWrCbpDGGB53LuZRmmtHRz9xR42TsR8cNowEYNRQOwsBeeGkepLaB8+Myw67lVM67IIVCtcuRVqyYS+d2paZHQpnpIwsU1UAoGpoRJD3dh13KUcrHMfzV2LkU2pwQvXc9SHLeHiTg4NBMM6tYxRRTdNNNnvyZG9mnUajo0ig7I74d7OS+j38suFM5VFS+CKHVcNtl8HAC5l0PW94XwPTQVuxizomPbGsOVM7/h7q513qQkmy8m+nj+3AcSX5mGFXzYGVSeJY20v/l/yAx5y0AJJIiRQwMLuIiaqllP/uJE8fBcTcRp/lB8RSAXlvWvLaUh9qfKtZr8McO/GShEB/zw+xpyG+Hp9/XBwAMswZV93sU1RNUVANBAc0ToWn+tdRHM/QO58jGj2O1jdP3+e+Q7jh0xvwiRbro4gAHWMc6VrCCfvqxsE4B+H0/MED10XT1D/lqDi4JwAa9TJ8VQpCV5yLQeQCEapbhWHk8Zj2GL0SGEvnUILoqWX/FAtR387x95CjDf/U4mSXvnTXfxmaCCXawgyUsYSUr2c52+ulHnmCyepovaK5v3OTDvKXA1+qFoFYIcByOSMkkZF6E+AcGEGlYixDKlFVM96YmjrRPjxxE0TzMpNP89JUxSiWdsRufJbP0PdezxNlrFClygAPsYQ9LWco85jHE0CkrqOWT1yAgoGUKOpKCdYaOxzTA42G6UKA3ne49Ap/5Hew9l67nLKc/9u2PkhjZcyAzfeTpfHqEUnYKVTMxzDpS0wkGfE8xM+ugq/y5LYuNTZw4b/Imk0zSQism5sn3zTn4XAxumoRbRuGuDASyUFB0cCTFfJ5Bj2dgCm6vgd/1wMwHtsDfzhcs3PTfADJQMQ+QZKa7KWYmyCSOMrbkWYpVU24EUcsWOIcVChTo4jCV2ZdJDQ3ypR9lWHOPe6/RxqFpDCanIBaH0TQcPSTZncgwy1bIIhmXZuTBxX/RIBHQ+cQH9wGAQmYMgNTkQbyBJqgQZKf7yNR1k1l2DLJlCjicl0YSST41xWX3vsraZ0oszDh4j0PsqzCeg/EspPKQysJMCuoPwGgJjuEwAjQ5Vrg6fqxDCpg6j57nBaBqPkC+npnuHihkJlr94VmongDZWB/MOG76t8pDPTcZPXm48V4L8xGLyvJPCk/AeAom/wIyechmIZ+HXA7WFd3oOhf4MDCSn+bO4TcA+Jvz6Xk+ALGBLZiRjn7NCB0QyHWaJ2Rlk0d1v9quOtUlci29bglwWhQ5aQUpCL6wlKYf3MHsnxZYXZoiWlfHsVyOlxyHcDdU2oLjsyAQgGIRBobg8ndgaQ5GyoZtcI28tRZe//559FS4gKian1yy9w3NCK0K167s8Aabd0SjV2Dm57k14rnutjYEn1tC/SM3ou5vI9Z+LQsCUdpWX0oxUo9nlkr7NVD9Bcn8+S4AFAhPQCgLlcAs3Ev9YeAp3Zy9Yc5Hg9St/MMsAJAYfYvGhbdK28rXS2nfEaxetM4fmhVNhncTr9oOJm4dYwAeCB1ZQd2rN1D9448Q8C3EH21mIDfFMaOaFVcdpnH9MHM+b1P5RYecDoUCZDIwkYC1O2F1j0AC7wBxVUVIyYTmWUrbh5qM+lWLApGOjYpqDPnCs+ObH+pj3y/vP78PAEQbL6f7zW+EW5Z85snK1o3rdU8EVdfRpOGGkhN3WxuCvYvoePRBnCMlalrAKoyhy5188++fIVjhJdLeQySQQkqX86oKmuYOIcB2gOo64vFJgpZFpRAQCkMqSXzgtVtKF/81snoJkfrV66RTuO6t555IXdCJAVQjiNesAySFzASlfAK/rw5pZk71dfLABDhxL431Yyyo7+LOm39AyLRAVhIJj6Eop5KoEGcqfwLAtFCJWyVsKdGBMdumI5uhXghumDjA7J4XeHnDPzEzdfjibLL3Q/5I+975G/+l94IAGi/6JIXMeNIqpG5VVc/37VJmw0TiVcaM30BbWfkxuKUO2tv2suHyT7HBc2J2GAi5bkgaN2mUD6YMQNdBMyCQhOPDCp3JOLZjMwPUSonhOPhwo9JEfIDY0B40IxgJ1y7/seGr+l0pN/2ZCwI4+OJmln/0WYCwVUw1+CNzyco+Upn9BIFVBnxtHqwIQcVZK9nlGNEOHAemT3q6EKdO3zDASkO6v8QEboPiYqAVGHUcZnQ/jqKzXffjC7fiMesRioK0ixtyirbgggBckYCocezi3OToLnL2CO0t8PiVsLIBguddIY+b/TuA+jKAUzQ63QLVCswXgnpNY1xKPJbFNLALONB+DfsuuhnLEyZUtRAJ5BIDFPNTvfn06MT7AkhNHMCxC72ByoXfFFpk87zZDe1f/yxsaHm/mRZuE1QtW6GnfL5n+oGhQ0lzf92kqmSkZNKyyACTwMzMMDEpqQzPpphPkJ7qzORnhh+zCqmfC6HseV8APTu/BdC74LbF94/sWbZt9SUHX1i/mNBpWesCs+NlK7TiRvjhk28UxbWAqkMwDw1Sks7nMYFxIO6vYefCWzlSSJAZ24vqlLZ6fDXfSozsLmYS3W/pnoricOfjfAAKufLo5zpJfbLz3bZm8rje+QEkh5tXFwItwCgnWnJCgGpAbi+MPgKrgYwQHJaSAPDqqnsYnns9Zn6KROcPYqOHfvhZxy4cm+x7+YwdlA+mCIwNCYZ7BVPjYFmnn7y4wCwb14EFsBTwn3xjAc5rELwbqifc1Q5LSQG3cJvw16CpHjTNRPdW2I5dTBlm3Vk7XDATny5JNvPcK1d5TdO45dJV/RXGiR7PBQGAW9W0g7MAGXsLK51h6h9Afkfw+o8EPxt07aSXoZq4AVhMHyY51cWR9NhM7Pi2r8cHXtteBGmXq+Q/GMC4fQ9T796dm5y0jldFUzeGwy4NznsZKMs0Nl1HVQqvxOj7VBc/f9hidBuUeqAmKagDvEB/2T6VwBpgTi6GXohjO9aLHQNbfuWFkfmZMafnD7HAH901iT/c9mndE10WO3L/gcWLwS6lGj0eNldXu5HklPJngtiBwTN4eBaNf303Rufvhsi+nqErIWm1YTGuV1QCbUKgC8H+8rM6oEpV6VBKBCYPLyjAJ3Iw+SvYe//7AWi75G5mrbwn6A+1Xm7l449GG9fc5vHXfaS247r4vz9243uzm/cuioQSH29oAJ/vTBoVUBnF4D5qeRyD51A5hA5tAXwbF3LJupuYd9MmQl1HYTRFI+69yFRVdqoqOcehBbdlGtA0kjU1+FMp5oAehnXPQOJTsG858Ma5AMy59D4U4Wk3I3OeMXzVX/aY1QvCNYt9ZqTJ4zjWRq/WeWdOLrmuueK33tZWME03HALkMXiC+XybBnZiM0kJFQcfBk00cYV6BQvb1vHG7HdxnttNfW+eKBDDzRYRxznZYRkEBqSkL5Oh6DgkgAh4JGyUbn8o2w3ja2DZGVFI90TRPdFbrMLMRquYDCqaH7uYwwyZKKrP1HR/rVSqIxMTMDUFpRIgYev+a/lF/jpeo50pLCyKCCQaGhEizGUuF7GAd9jPK7yMIEEQ2FF23J9KyaiULBUCB/eaIaXkgGUxRwiqhKDL9RVzLjz0Yfin9bBxHTx/Mg/UdlzHod9+kcVXPWbOTHWiaj4K6REy00fIVs0hOdGNJ9CAIzPEYjAzA8kkvPzm9fz3T76CuvYoM3/+Q4r+ErZWQiDw4aOJJhaxiBQpXmELlU/3oe5V2IpDO7BICOKAJSVHy5+UkmUQUcArJY24tWMzIFSV9ba9crGiPF7n87WfBBCqvZj567+zLpvo+UuEoHb2Nai6wfTwToq5OOHaZXhDbcj8LjIZ1wK/3RrilV2VTE5vQRy2iL75eZwbfkZh08/xKj4qqKCVVgC2sY2d7OWLvQUuT5z6NKADS3CDbcjnY7hQoMZxqBOCfiFQIhE8lkV7KkUQqHHBVTU4TpU/lzvlAx2XPYA/MrtD84RuL2bGiDZehhntQNW8OFaeUN1KcIo4dgbd2kcmGSMSKuCtXE/CvoZSZhQrmUV9p4nStI3uM4jUQgONDDDADnYQY4rlWyXzX4d6TXMv+lJSLQQ6EG5rwz8zg8+2qRWCgKLg1NQQEoJD6bRbnEt5sjDPS3kKQPWsK7EK8SaB8nFF9RgIjXBNO7onTCbRTzhkAg6x8VGqKizqI/uJRKE6Mk6Sa7G0ZeTSY3h986gY+DCVE1cz6t/FhP8Qx3xHGWEUic2Cl2DtDqhWVQxV5ahtcxQYAsx8npFikUK5nBiVkr5Egu50mmEovgcx08173iCIAUieBFDZ8kfMueS2wYH9P5j2hVvNdOxQXPf46ou5OFZ+go2XdVCybCYnZ2isGaCpcg/RKFRGEpSUeUQiOhFfN611hwlF0vTtdxDbq98efmdv59TVPX02dmTNG/geuUenzVLJ2xY5x/0SLnEz8FCpREJKauvreUtReLtQmK6ENwswsBt+2QU3OfC/x6A5BsPd8KWzUqhQFCqaPoyiyXazYv4toeolm6MNa9o1T5jUxEFmpvtZvWgXa+Y+RWUV+P3gOO5oboZFi2BszMf/PV+NoqhXCk/ptXtvPo4MyzvXvsTDz99geiulQzKXowc4WFb+JkVBSsmMlPTOmkV3IoE/Ht/ih03LgBW4HzN/X+GzqlHpOMQGfwXQO9n74v3zN/zL5V6v1r7wIpOukuYkJuxpn8/yBYOYXq9b0zuOC6S+HgxDpa3Nx9fuHgOK/wz85h64T8Cj/l9g/FjP/NuKjNvzyRigG+AUIe0oGGVOD/X1nWh4pDadfricLRcsJfqk5JGH/me5x6xekynoYvJ47+tHe/1X3f5n31VCwcJlPr+byISAqipobASPJ1w+0xQg64BLdkDlk5AYqqFl62qu9CbcMvixTfC966BHZ2rtUTlWkjIalRKPECRhaww+dyeknr6AjhcsJVuW34VVTJm+UOvn/ZHZpmOXnr7tTx/undN86Bu6zjd13T19rxfa26GhUUNR5iAYY5xG+mjjILv5CTF+6zgwhtutOop7z/Hg1tWj/Pr17/LgDDy1EtriQshOKa/0wpabOU9b+nwUOl0G938P3AbKd088W3y3+/dECaEoEAxCdQReUHR2UsmfsIkIazmMwhMkeZs9CKWANIFgWfEUp/7VRkU77mfroSx37IKfmVK+YMAe532UB/h/dlqZ4ijxf0gAAAAldEVYdGRhdGU6Y3JlYXRlADIwMjAtMDItMjhUMTM6MjU6MzYrMDA6MDCs2KJvAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDIwLTAyLTI4VDEzOjI1OjM2KzAwOjAw3YUa0wAAAABJRU5ErkJggg==', 'MTZDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAADAAAAAwCAYAAABXAvmHAAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAA8AAAAPAB60vuAAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAALASURBVGiB7ZhNaxNBGIAfYzVoRRH8wKJim+pBRDzoTRHxC413/4Y3/4LgL/CgePcitVKUXhRBQcQeBD00bU1RQbFWEbU0VQ/vhEymu7PvpDuxkX0gzGbmnd19knfnY6GgoOC/5SYwZz67UmIOWTHXTd1tqy7rcwO4HBA/5N5An0egH9hqjivAh4SY/VbMhoR+WfQD5YD4tW5FSdmxEljfNXpN4I9b4UuhJg38Ag3nPFeBa07cOLAIXHDq54BvwFHP9Q8Dt4AvwIzbqBGoky4wDLx12qcS4hqIwIuU83z2XL9qyjFznjY0KVQjWaAP2GPaY9IUuJ/UqBXYBmxx6vchEjEFdiDptQQ8SArQCsDyMXjYaY9BFbnHp6SkWYiAm0YVpz0G3vSBlQssArPh96ViHXDGHI+mBWkEPgFfSRaYIWFkyImTyHNXB16lBWknsimSBbqRPvd8QVqBGq2HFmANMMg/zn8IE9iNLLwABoCNxBM4gCwUfwKPfIEhAiVk7If4I9AlU44DP3yBIQLQuvHYc4AqfaBzgQqyMpwOuy8Vm4Hj5ngsK1grMAss0C7wnoy/t0POAeuBCWQI9aIV+I2M+bZA7PRJnbxstALQviqNJVCitWfIzP9mBy01ZEG3HdnDxhA4BuxEZv/nmg6hAmXghPU9b+zNy5KmQ6gAwFnne540x39V+kCYwKQpz5syb4EB4Aiywn2o7RQiMI2MRoPAPLIhz5MqssZ6Ys6vIkRgAXhnjid9gR2inn1tQgSglTZ5p08ZOG2Oe1LgFLAJ2Xe8CemoeS9kcxcZ3tQPmZKLplTNvjahAqOdXERBxwKhKRSDg8jS5DvwOLRz6D8Qg+av/xG4khE7Ary2K1aDwF5TDrH8pbBLHUdgNaTQiuh5AV8KPUMEf2WcYx64A7z0xIyQ/gJswvTXkLlDKygoKOgufwEW1J5iWFCvzwAAAABJRU5ErkJggg==', 'SceneDataFile': 'data:image/jpeg;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAARCQAAEQkBwOWiGAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAHOSURBVFjD7Ve7SgNBFJ3CRhHjA1RE/IGQkOzmwSpI0ggWItraCDZWYhXtBB+NjfgfFoJGQiwEQS0EsbFJr/kEH3ms58TZsAQzSbO5TYqzy94ze+/hzp2ZO8p1XSUJ1RfARyaTGUgkEgu2bYdMgx3HGccYqx2fTqdHTDwBfigejzuM2RAAQxZ4B1ygBiHPwCmwHA6Hh6PR6CTs25Zl3eJd0eNegR0EnKIocBvABWyf//CDCLiI7z2gAHzpMYyZVdqx2wYMWDXw1S74n3Y8YzMDJYODoFGigP0W4zmUbQYB+vbHwjTnFOZnxksjBj0EXfWM4U1PMpmc9iqzqI2XQQtgDB2r2FyG+HjqtQAv2yoSiYz5KrmXGahw3+CcrPsKo5cCmIUVhUo8kRIAHDIDN4ICrmkoCwr4kBZQpiEvKCDPGjgWFHBEAWtSArACV1UsFhsV2ogYM9QwQsmj2FYsfhjxSJQ6jtkKMP05qYaEzZB8S9ahKa0BdQNf74KvdWpK/W05O9g7EAd4L+k+f05P05se8w1cwbal66eVZz3dw8cu/p9lv8H1DpzB/uIT9NeWexcTOJvnPaBDAdncN0x8KpWaMPng/7wENS8m/buhtIBfIEJl7hwqO4QAAAAASUVORK5CYII='}

def MTZToB64Map(fin):
    import tempfile
    import uuid

    with tempfile.TemporaryDirectory() as tempd:

        uuid_str = uuid.uuid4().hex
        tfilename = os.path.join(tempd,uuid_str)

        mean,std_dev = MTZToMap(fin,tfilename)
        b64d = MapToB64Map(tfilename)

    return b64d,mean,std_dev

def MapToB64Map(fin):
    import base64
    with open(fin,"rb") as f:
        d = f.read()
    b64d = base64.b64encode(d)
    return b64d


def MTZToMap(fin,fout):
    import clipper

    mtzin =  clipper.CCP4MTZfile()
    mtzin.open_read(fin);
    mydata = clipper.HKL_info()
    mtzin.import_hkl_info(mydata)

    fphidata = clipper.HKL_data_F_phi_float(mydata)
    mtzin.import_hkl_data(fphidata,"/*/*/[F,PHI]")

    mtzin.close_read()

    mymap = clipper.Xmap_float()
    gs = clipper.Grid_sampling( mydata.spacegroup(), mydata.cell(), mydata.resolution() )

    mymap.init( mydata.spacegroup(), mydata.cell(), gs )

    mymap.fft_from( fphidata )

    mapout =  clipper.CCP4MAPfile()
    mapout.open_write(fout)
    mapout.export_xmap_float( mymap )
    mapout.close_write()

    stats = clipper.Map_stats(mymap)
    mean = stats.mean()
    std_dev = stats.std_dev()

    return mean,std_dev

def escapeI2Quotify(itemparams):
#This horribleness is because we want to pass strings containing quotes without them being magically converted to "&quot;"
    b = [ord(x) for x in itemparams ]
    a  = "String.fromCharCode("
    for c in b: a += str(c)+","
    a = a.rstrip(",") + ")"
    return a


def htmlBase():
  # This is a bad i2 dependence which we are trying to avoid in the Reportparser
  # Needed to support use of images for Reference icon etc
  from core import CCP4Modules
  port = CCP4Modules.HTTPSERVER().port
  if port is None: port = 43434
  htmlBase = 'http://127.0.0.1:'+str(port)+'/report_files/'+CURRENT_CSS_VERSION
  return htmlBase

def htmlDoc(htmlBase=None,cssVersion=None,cssFile=None,jsFile=None,title=None, additionalJsFiles=None, additionalCssFiles=None, requireDataMain=None, additionalScript=None):
  from core import CCP4Utils
  import sys
  if cssFile is None:cssFile = 'xreport.css'
  if jsFile is None: jsFile = 'xreport.js'
  doc = etree.parse(StringIO(DOCTYPE))
  html = doc.getroot()
  if htmlBase is None: htmlBase = '../../report_files'
  
  # Default ot latest htmlBaseVersion or get the latest minor version
  # for the version proposed 
  if cssVersion is not None: cssVersion = getLastestMinorVersion(cssVersion)
  if htmlBase.endswith('report_files'):
    if cssVersion is None: cssVersion = CURRENT_CSS_VERSION
    #print 'htmlDoc cssVersion',cssVersion
    htmlBase = htmlBase + '/'+cssVersion
  head = etree.Element('head')
  if title is not None:
    titleEle =  etree.Element('title')
    titleEle.text=title
    head.append(titleEle)
  
  allJsFiles = [jsFile]
  if additionalJsFiles is not None: allJsFiles += additionalJsFiles
  for aJsFile in allJsFiles:
    script = etree.Element('script')
    script.set('src',htmlBase+'/'+aJsFile)
    head.append(script)

  allCssFiles= [cssFile,'jspimple.css','jquery-ui-1.10.4.custom.min.css']
  if additionalCssFiles is not None: allCssFiles += additionalCssFiles
  for aCssFile in allCssFiles:
    link = etree.Element('link')
    link.set('rel','stylesheet')
    link.set('type','text/css')
    link.set('href',htmlBase+'/'+aCssFile)
    head.append(link)

  for webgl_source in WEBGLSOURCES:
      script = etree.Element('script')
      script.attrib['src'] = htmlBase+'/MGWebGL/'+webgl_source
      script.attrib['type'] = "text/javascript"
      head.append(script)

  if additionalScript is not None:
    script = etree.Element('script')
    script.text = additionalScript
    head.append(script)

  if requireDataMain is not None:
    script = etree.Element('script')
    script.set('src',htmlBase+'/require.min.js')
    script.set('data-main',htmlBase+'/'+requireDataMain)
    head.append(script)

  script = etree.Element('script')
  script.attrib['src'] = htmlBase+'/'+"qwebchannel.js"
  script.attrib['type'] = "text/javascript"
  head.append(script)

  script = etree.Element('script')
  script.attrib['src'] = htmlBase+'/'+"jquery.min.js"
  script.attrib['type'] = "text/javascript"
  head.append(script)

  script = etree.Element('script')
  script.attrib['src'] = htmlBase+'/'+"jquery-ui-1.10.4.custom.min.js"
  script.attrib['type'] = "text/javascript"
  head.append(script)

  mouseOutText = """
        new QWebChannel(qt.webChannelTransport,
                function(channel){
                window.buttonBridge = channel.objects.handler;
        });
        function buttonClicked(name) {
            window.buttonBridge.clicked(name);
        }
  
function onMouseOut(event,id) {
    e = event.toElement || event.relatedTarget;
    if(e == document.getElementById(id) || e.parentNode == document.getElementById(id) || e.parentNode.parentNode == document.getElementById(id)){
        return;
    }
    document.getElementById(id).classList.remove("show");
}
  """

  script = etree.Element('script')
  script.text = mouseOutText
  head.append(script)

  onLoadText = """
     var queue = [];
     var loaded = false;

     function enqueue(callback,fogdiv,clipdiv,mapLoadButton)
     {
         if(!loaded) queue.push([callback,fogdiv,clipdiv,mapLoadButton]);
         else callback(fogdiv,clipdiv,mapLoadButton);
     }

     var getElementsByRegex = function(node,pattern,recurse){
        var arrElements = [];   // to accumulate matching elements
        var re = new RegExp(pattern);   // the regex to match with

        function findRecursively(aNode) { // recursive function to traverse DOM
            if (!aNode) 
                return;
            if (aNode.tagName !== undefined && aNode.tagName.search(re) != -1)
                arrElements.push(aNode);  // FOUND ONE!
            for (var idx in aNode.childNodes) // search children...
                findRecursively(aNode.childNodes[idx]);
        };

        findRecursively(node); // initiate recursive matching
        return arrElements; // return matching elements
    };
    function loadData(gl,pdbatoms,enerLib,bruteForceHB,wizard){
        var ribbons = [];
        //FIXME - This is hackery ... need more wizards to be written.
        if(wizard.startsWith("Site and ribbons by ")){
           ribbons = wizardSiteAndRibbonsByChain(pdbatoms,enerLib,bruteForceHB);
        } else if(wizard.startsWith("colour chains")) {
           ribbons = wizardRibbonsByChain(pdbatoms,enerLib,bruteForceHB);
        } else {
           ribbons = wizardBonds(pdbatoms,enerLib,bruteForceHB);
        }
        //ribbons = wizardWorms(pdbatoms,enerLib,bruteForceHB);

        var appendStart = new Date().getTime();
        for(var i=0;i<ribbons.length;i++){
            // FIXME - Should be done in wizardBonds call????
            ribbons[i]["symmetry"] = pdbatoms["symmetry"];
            gl.appendOtherData(ribbons[i],true);
        }
        console.log("Time to do appendData(actual): "+(new Date().getTime()-appendStart));
        gl.buildBuffers();
        console.log("Time to done buildBuffers after append : "+(new Date().getTime()-appendStart));
        gl.drawScene();

        var hier = pdbatoms["atoms"];
        gl.setOrigin(hier[0].centre());
        console.log(hier[0].centre());

    }

    function _base64ToArrayBuffer(base64) {
        var binary_string =  window.atob(base64);
        var len = binary_string.length;
        var bytes = new Uint8Array( len );
        for (var i = 0; i < len; i++)        {
            bytes[i] = binary_string.charCodeAt(i);
        }
        return bytes.buffer;
    }

    function doParseAndLoad(gl,enerLib,xmlDoc,maploadButton){
        var extent = 0.0;
            var ccp4i2_header = xmlDoc.getElementsByTagName("ccp4i2_header")[0];
            var projectId = "";
            var jobNumber = "";
            if(ccp4i2_header.getElementsByTagName("projectId").length>0&&ccp4i2_header.getElementsByTagName("jobNumber").length>0){
                projectId = ccp4i2_header.getElementsByTagName("projectId")[0].innerHTML;
                jobNumber = ccp4i2_header.getElementsByTagName("jobNumber")[0].innerHTML;
            }
            var atoms_ids = {};
            if(xmlDoc.getElementsByTagName("ccp4i2_body").length>0){
                var ccp4i2_body = xmlDoc.getElementsByTagName("ccp4i2_body")[0];
                if(ccp4i2_body.getElementsByTagName("data").length>0){
                    var data = ccp4i2_body.getElementsByTagName("data")[0];
                    var molData = data.getElementsByTagName("MolData");
                    for (var i=0; i < molData.length; i++) {
                        var customResCIFFiles = molData[i].getElementsByTagName("customResCIFFiles");
                        for(var k=0;k<customResCIFFiles.length;k++){
                            var cifmonomers = customResCIFFiles[k].getElementsByTagName("cifmonomer");
                            for(var l=0;l<cifmonomers.length;l++){
                                console.log("Have a cifmonomer");
                                var name = cifmonomers[l].getElementsByTagName("name");
                                var ciffiledatanodes = cifmonomers[l].getElementsByTagName("filedata");
                                if(name.length>0&&ciffiledatanodes.length>0){
                                    console.log("Have some text");
                                    var nameText = getNodeText(name[0]);
                                    var cifText = getNodeText(ciffiledatanodes[0]);
                                    console.log(nameText);
                                    console.log(cifText);
                                    enerLib.addCIFAtomTypes(nameText,cifText);
                                    enerLib.addCIFBondTypes(nameText,cifText);
                                }
                            }
                        }
                        var modid = molData[i].getAttribute("id");
                        var fileDatas = molData[i].getElementsByTagName("filedata");
                        var fileData;
                        for(var ifd=0;ifd<fileDatas.length;ifd++){
                            console.log(ifd);
                            if(fileDatas[ifd].parentNode===molData[i]){
                                fileData = fileDatas[ifd];
                                break;
                            }
                        }
                        var pdbatoms;
                        try {
                            pdbatoms = parsePDB(fileData.innerHTML.split(String.fromCharCode(10)));
                        } catch(e) {
                            console.log("Failed to parse as PDB, try MMCIF");
                            try {
                                pdbatoms = parseMMCIF(fileData.innerHTML.split(String.fromCharCode(10)));
                            } catch(e) {
                                console.log("Failed to parse as PDB or MMCIF, this is probably a bug.");
                                return;
                            }
                        }
                        var hier = pdbatoms["atoms"];
                        atoms_ids[modid] = pdbatoms;
                        var molDisp = molData[i].getElementsByTagName("MolDisp");
                        for (var j=0; j < molDisp.length; j++) {
                            var selection = molDisp[j].getElementsByTagName("select")[0].innerHTML;
                            var style = molDisp[j].getElementsByTagName("style")[0].innerHTML;
                            if(true){
                                var model = hier[0]; //FIXME - Loop over models?
                                var selAtoms = model.getAtoms(selection);
                                //FIXME - Now what do I do?
                                if(style==="BALLSTICK"||style==="BONDS"||style==="THINBONDS"||style==="FATBONDS"||style==="SPHERES"||style==="CYLINDERS"){
                                    //FIXME - pick up the colour scheme ....
                                    var colourScheme = new ColourScheme(pdbatoms);
                                    var atomColours = colourScheme.colourByAtomType();
                                    var contactsAndSingletons = model.getBondsContactsAndSingletons(selAtoms);
                                    var contacts = contactsAndSingletons["contacts"];
                                    var singletons = contactsAndSingletons["singletons"];
                                    if(style==="BONDS"||style==="FATBONDS"){
                                        var singletonPrimitiveInfo = singletonsToLinesInfo(singletons,4,atomColours);
                                        gl.appendOtherData(singletonPrimitiveInfo,true);
                                        var ligandAtoms =  model.getAtoms(selection+" and ligands");
                                        var multipleBonds = getMultipleBonds(ligandAtoms,enerLib,4,atomColours,"LINES");
                                        for(var imbo=0;imbo<multipleBonds.length;imbo++){
                                            gl.appendOtherData(multipleBonds[imbo]);
                                        }
                                        if(ligandAtoms.length<selAtoms.length){
                                            var linePrimitiveInfo = contactsToLinesInfo(contacts,4,atomColours);
                                            gl.appendOtherData(linePrimitiveInfo,true);
                                        }
                                    } else if(style==="THINBONDS"){
                                        var singletonPrimitiveInfo = singletonsToLinesInfo(singletons,2,atomColours);
                                        gl.appendOtherData(singletonPrimitiveInfo,true);
                                        var ligandAtoms =  model.getAtoms(selection+" and ligands");
                                        var multipleBonds = getMultipleBonds(ligandAtoms,enerLib,2,atomColours,"LINES");
                                        for(var imbo=0;imbo<multipleBonds.length;imbo++){
                                            gl.appendOtherData(multipleBonds[imbo]);
                                        }
                                        if(ligandAtoms.length<selAtoms.length){
                                            var linePrimitiveInfo = contactsToLinesInfo(contacts,2,atomColours);
                                            gl.appendOtherData(linePrimitiveInfo,true);
                                        }
                                    } else if(style==="BALLSTICK"){
                                        var spheres = atomsToSpheresInfo(selAtoms,0.4,atomColours);
                                        gl.appendOtherData(spheres,true);
                                        var ligandAtoms =  model.getAtoms(selection+" and ligands");
                                        var multipleBonds = getMultipleBonds(ligandAtoms,enerLib,0.2,atomColours,"CYLINDERS");
                                        for(var imbo=0;imbo<multipleBonds.length;imbo++){
                                            gl.appendOtherData(multipleBonds[imbo]);
                                        }
                                        if(ligandAtoms.length<selAtoms.length){
                                            var cylinderPrimitiveInfo = contactsToCylindersInfo(contacts,0.2,atomColours);
                                            gl.appendOtherData(cylinderPrimitiveInfo,true);
                                        }
                                    } else if(style==="CYLINDERS"){
                                        var spheres = atomsToSpheresInfo(selAtoms,0.2,atomColours);
                                        gl.appendOtherData(spheres,true);
                                        var ligandAtoms =  model.getAtoms(selection+" and ligands");
                                        var multipleBonds = getMultipleBonds(ligandAtoms,enerLib,0.2,atomColours,"CYLINDERS");
                                        for(var imbo=0;imbo<multipleBonds.length;imbo++){
                                            gl.appendOtherData(multipleBonds[imbo]);
                                        }
                                        if(ligandAtoms.length<selAtoms.length){
                                            var cylinderPrimitiveInfo = contactsToCylindersInfo(contacts,0.2,atomColours);
                                            gl.appendOtherData(cylinderPrimitiveInfo,true);
                                        }
                                    } else if(style==="SPHERES"){
                                        var spheres = atomsToSpheresInfo(selAtoms,1.0,atomColours);
                                        gl.appendOtherData(spheres,true);
                                    }
                                } else if(style==="SPLINE"||style==="WORM"){
                                    var flagBulge = true;
                                    CalcSecStructure(hier,flagBulge);
                                    //FIXME - pick up the colour scheme ....
                                    var colourScheme = new ColourScheme(pdbatoms);
                                    //var atomColours = colourScheme.colourByAtomType();
                                    var atomColours = colourScheme.colourBySecondaryStructure({"strand":[0.0,0.0,1.0,1.0],"helix":[1.0,0.0,0.0,1.0]});
                                    //FIXME - ignores selection. Can we select in spline yet?
                                    var coloured_splines_info;
                                    if(pdbatoms["models"].length>0){
                                        for(var modidx=0;modidx<pdbatoms["models"].length;modidx++){
                                            if(style==="SPLINE"){
                                                coloured_splines_info = GetSplinesColoured(pdbatoms,atomColours,false,pdbatoms["models"][modidx]);
                                            } else {
                                                coloured_splines_info = GetWormColoured(pdbatoms,atomColours,false,pdbatoms["models"][modidx]);
                                            }
                                            for(var i=0;i<coloured_splines_info.length;i++){
                                                gl.appendOtherData(coloured_splines_info[i],true);
                                            }
                                        }
                                    } else {
                                        if(style==="SPLINE"){
                                            coloured_splines_info = GetSplinesColoured(pdbatoms,atomColours);
                                        } else {
                                            coloured_splines_info = GetWormColoured(pdbatoms,atomColours);
                                        }
                                        for(var i=0;i<coloured_splines_info.length;i++){
                                            gl.appendOtherData(coloured_splines_info[i],true);
                                        }
                                    }
                                }
                            }
                        }
                    }
                    document.getElementById(maploadButton).onclick = function loadMaps(){
                        console.log("Clicked map load")
                        var mapData = data.getElementsByTagName("MapData");
                        var clients =  [];
                        for (var i=0; i < mapData.length; i++) {
                            var filedata = mapData[i].getElementsByTagName("filedata")[0];
                            console.log(mapData[i]);
                            var theData = getNodeText(filedata);
                            //basename of file
                            theData = theData.split(/[\\\\/]/).pop();
                            console.log(theData);
                            clients.push(new XMLHttpRequest());
                            clients[i].mapData = mapData[i];
                            console.log("%%%%%%%%%%%%%%%%%%%%%");
                            console.log("Create a client");
                            console.log("%%%%%%%%%%%%%%%%%%%%%");
                            clients[i].onreadystatechange = function() {
                                if (this.readyState == 4 && this.status == 200) {
                                    console.log("OK!");
                                    console.log(this.mapData);
                                    //Remove 1st and last quote and an EOL/EOF ?
                                    loadMapsData(this.mapData,this.responseText.substr(1,this.responseText.length-2));
                                } 
                            }
                            clients[i].open("GET", \""""+htmlBase.rstrip("/report_files/0.1.0")+"""/database/?getProjectJobFile?projectId="+projectId+"?fileName="+theData+"?jobNumber="+jobNumber, true);
                            
                            clients[i].send(null);
                        }
                    }
                    function loadMapsData(thisMapData,theData){

                        console.log("####################");
                        console.log("loadMapsData");
                        console.log("####################");
 
                        var isDiffNode = thisMapData.getElementsByTagName("isDifferenceMap")[0];
                        var isDiff = false;
                        if(typeof(isDiffNode)==='undefined'){
                        } else {
                            var isDiffText = getNodeText(isDiffNode);
                            if(isDiffText==="True"||isDiffText==="true"||isDiffText==="1"){
                                isDiff = true;
                            }
                        }

                        var mapDisp = thisMapData.getElementsByTagName("MapDisp");
                        var sigma;
                        var units = thisMapData.getElementsByTagName("contourUnits")[0].innerHTML;
                        var contourMult = 1.0;

                        var sigmaNode = thisMapData.getElementsByTagName("sigma")[0];
                        if(typeof(sigmaNode)==='undefined'){
                        } else {
                            var sigmaText = getNodeText(sigmaNode);
                            sigma = parseFloat(sigmaText);
                        }

                        var unitsNode = thisMapData.getElementsByTagName("contourUnits")[0];
                        if(typeof(unitsNode)==='undefined'){
                        } else {
                            var unitsText = getNodeText(unitsNode);
                            if(unitsText==="sigma"){
                                contourMult = sigma;
                            }
                        }

                        var contents = _base64ToArrayBuffer(theData);
                        var map = readMapFromArrayBuffer(contents);
                        var mapGrid = mapToMapGrid(map);

                        for (var j=0; j < mapDisp.length; j++) {
                            if(isDiff){
                                var contourLevel = contourMult * parseFloat(mapDisp[j].getElementsByTagName("contourLevel")[0].innerHTML);
                                var mapTriangleData = {"mapColours": [[0.0,1.0,0.0,1.0]], "mapContourLevels":[contourLevel], "mapGrids":[mapGrid],"col_tri":[[]], "norm_tri":[[]], "vert_tri":[[]], "idx_tri":[[]] , "prim_types":[[]] };
                                gl.appendOtherDataIfReady(mapTriangleData);
                                var contourLevel = -contourMult * parseFloat(mapDisp[j].getElementsByTagName("contourLevel")[0].innerHTML);
                                var mapTriangleData = {"mapColours": [[1.0,0.0,0.0,1.0]], "mapContourLevels":[contourLevel], "mapGrids":[mapGrid],"col_tri":[[]], "norm_tri":[[]], "vert_tri":[[]], "idx_tri":[[]] , "prim_types":[[]] };
                                gl.appendOtherDataIfReady(mapTriangleData);
                            } else {
                                var contourLevel = contourMult * parseFloat(mapDisp[j].getElementsByTagName("contourLevel")[0].innerHTML);
                                var mapTriangleData = {"mapColours": [[0.0,0.0,1.0,1.0]], "mapContourLevels":[contourLevel], "mapGrids":[mapGrid],"col_tri":[[]], "norm_tri":[[]], "vert_tri":[[]], "idx_tri":[[]] , "prim_types":[[]] };
                                gl.appendOtherDataIfReady(mapTriangleData);
                            }
                        }
                    }
                }
                if(ccp4i2_body.getElementsByTagName("wizard").length>0){
                    var wizard = ccp4i2_body.getElementsByTagName("wizard")[0];
                    var template = wizard.getElementsByTagName("template")[0].innerHTML.split(":")[1];
                    var parameters = wizard.getElementsByTagName("parameters")[0];
                    var molIds = getElementsByRegex(parameters,'^MolData.*');
                    for (var i=0; i < molIds.length; i++) {
                        loadData(gl,atoms_ids[molIds[i].innerHTML],enerLib,true,template);
                    }
                }
                gl.buildBuffers();
                gl.drawScene();
                gl.setOrigin(hier[0].centre());

                var atoms = hier[0].getAllAtoms();
                var minX = 1e+8;
                var minY = 1e+8;
                var minZ = 1e+8;
                var maxX = 1e-8;
                var maxY = 1e-8;
                var maxZ = 1e-8;
                for(var iat=0;iat<atoms.length;iat++){
                    var x = atoms[iat].x();
                    var y = atoms[iat].y();
                    var z = atoms[iat].z();
                    if(x>maxX) maxX = x;
                    if(y>maxY) maxY = y;
                    if(z>maxZ) maxZ = z;
                    if(x<minX) minX = x;
                    if(y<minY) minY = y;
                    if(z<minZ) minZ = z;
                }
                extent = 0.0;
                if((maxX-minX)>extent) extent = maxX-minX;
                if((maxY-minY)>extent) extent = maxY-minY;
                if((maxZ-minZ)>extent) extent = maxZ-minZ;
                gl.setFog([-0.25*extent,0.75*extent]);
                gl.set_clip_range(-0.25*extent,extent*.25,true);

                if(ccp4i2_body.getElementsByTagName("View").length>0){
                    var View = ccp4i2_body.getElementsByTagName("View")[0];
                }
            } else {
                console.log("no ccp4i2_body");
            }
            //addSymmetry(pdbatoms);
            return extent;
            }

    window.onload = function()
    {
        loaded = true;
        for(var i = 0; i < queue.length; i++)
        {
            queue[i][0](queue[i][1],queue[i][2],queue[i][3]);
        }
    }
    
  """

  script = etree.Element('script')
  script.text = onLoadText
  head.append(script)

  html.append(head)

  body = etree.Element('body')
  html.append(body)
  return doc

def testPathExists(self,relPath):
  return True

def getLastestMinorVersion(baseIn):
  import glob
  from core import CCP4Utils
  testSplit = baseIn.split('.')
  globList = glob.glob(os.path.join(CCP4Utils.getCCP4I2Dir(),'docs','report_files','*'))
  lastMinor = -1
  for path in globList:
    v = os.path.split(path)[1].split('.')
    if v[0] == testSplit[0] and  v[1] == testSplit[1]:
      minor = int(v[2])
      lastMinor = max(lastMinor,minor)
  if lastMinor>=0:
    return testSplit[0]+'.'+testSplit[1]+'.'+str(lastMinor)
  else:
    return None

def toBoolean(text):
  try:
    i = int(text)
    return bool(i)
  except:
    return bool(text)

def getChildObject(child,xmlnode,jobInfo={},report=None):
        if   child.tag == XRTNS+"table":
          obj = Table( child, xmlnode ) 
        elif child.tag == XRTNS+"graphgroup":
          obj = GraphGroup( child, xmlnode, jobInfo  ) 
        elif child.tag == XRTNS+"graph":
          obj = Graph( child, xmlnode, jobInfo  ) 
        elif child.tag == XRTNS+"objectgallery":
           obj = ObjectGallery( child, xmlnode, jobInfo  )
        elif child.tag == XRTNS+"results":
          obj = Results(  child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"fold":
          obj = Fold(  child, xmlnode ) 
        elif child.tag == XRTNS+"text":
          obj = Text( child, xmlnode ) 
        elif child.tag == XRTNS+"status":
          obj = Status( child, xmlnode ) 
        elif child.tag == XRTNS+"if":
          obj = IfContainer(  child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"ifnot":
          obj = IfContainer(  child, xmlnode,jobInfo, False ) 
        elif child.tag == XRTNS+"loop":
          obj = Loop(  child, xmlnode,jobInfo  ) 
        elif child.tag == XRTNS+"copy":
          obj = Copy( child, xmlnode ) 
        elif child.tag == XRTNS+"inputdata":
          obj = InputData( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"outputdata":
          obj = OutputData( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"importedfiles":
          obj = ImportedFiles( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"title":
          obj = Title( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"jobdetails":
          obj = JobDetails( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"logfiles":
          obj = JobLogFiles( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"picture":
          obj = Picture(  child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"launch":
          obj = Launch( child, xmlnode, jobInfo ) 
        elif child.tag == XRTNS+"drilldown":
          obj = DrillDown( jobInfo ) 
        elif child.tag == XRTNS+"comment":
          obj = None
        else:
          obj = Generic( child, xmlnode )
        return obj
      
def findChildren(obj,cls,id=None):
    retList = []
    if not hasattr(obj,'children'): return retList
    for child in obj.children:
      #print 'findChildren',child, isinstance(child,cls),isinstance(child,Container)
      if isinstance(child,cls):
        retList.append(child)
      elif isinstance(child,Container):
        retList.extend(findChildren(child,cls,id))
    return retList

def applySelect(xrtnode,xmlnode,jobInfo={}):
  # Test all nodes in xrtnode for a 'select' attribute
  # Find the value in xmlnode and copy into xrtnode node.text and remove the select attribute
  # Currently this used to process the plotting input
  if xrtnode.get('select') is not None:
    if xmlnode is not None:
      values = xmlnode.findall(xrtnode.get('select'))
      if len(values)>0:
        xrtnode.text = str(values[0].text)
      else:
        xrtnode.text = 'NO DATA AVAILABLE'
    del xrtnode.attrib['select']
  elif xrtnode.get('database') is not None:
    pathList = xrtnode.get('database').split('/')
    while pathList.count('')>0: pathList.remove('')
    data = jobInfo.get(pathList[0],{})
    for path in pathList[1:]: data = data.get(path,{})
    if not isinstance(data,dict):
      if isinstance(data,list):
        #I think the length should always be greater than 0, but a Keith refmac job in 09/02/2022 created a situation where it was not.
        if len(data)>0:
            xrtnode.text = str(data[0])
      else:
        xrtnode.text = str(data)
    del xrtnode.attrib['database']
  for child in xrtnode:
    applySelect(child,xmlnode,jobInfo)
  return xrtnode

def saveToFile(tree,fileName):
    text = etree.tostring(tree, xml_declaration=True)
    f = open(fileName,'w')
    f.write(text)
    f.close()

def findallEval( srcexpr, xmlnode ):
  """Evaluate a python expression containing findall elements deliminated by {}. The findall expressions are evaluated and return strings which are substituted into the expression. The expression is evaluated and the result returned."""
  tgtexpr = ""
  for i in range(srcexpr.count('{')):
    i0 = srcexpr.find('{')
    if i0 < 0: break
    i1 = srcexpr.find('}',i0)
    if i1 < 0: break
    tgtexpr += srcexpr[:i0]
    xp = srcexpr[i0+1:i1]
    nodes = xmlnode.findall( xp )
    tgtexpr += '"""'
    for node in nodes:
      tgtexpr += node.text
    tgtexpr += '"""'
    srcexpr = srcexpr[i1+1:]
  tgtexpr += srcexpr
  return eval( tgtexpr )


"""
class SearchableElement(etree.ElementBase):
   def select(self,path):
     l = self.findall(path)
     if len(l)>0:
       if '@' in path:
         return l[0]
       else:
         return l[0].text
     else:
       return ''
   def ifselect(self,path,default=False):
     l = self.findall(path)
     if len(l)>0:
       return toBoolean(l[0].text)
     else:
       return default
   def haspath(self,path):
     l = self.findall(path)
     if len(l)>0:
       return True
     else:
       return False
   def findall0(self,path):
     l = self.findall(path)
     if len(l)>0:
       return l[0]
     else:
       None
   def findall1(self,path):
     l = self.findall(path)
     if len(l)>0:
       return l[0]
     else:
       return PARSER().makeelement("dummy")
"""

     

def PARSER():
  if sys.version_info > (3,0):
        I2XmlParser.insts = etree.XMLParser(encoding='utf-8')
  else:
        I2XmlParser.insts = etree.XMLParser()
  return I2XmlParser.insts

class I2XmlParser:
  insts = None
  
class ReportClass(object):
    def __init__(self, *arg, **kw):
        super(ReportClass,self).__init__()
        self.id = kw.get('id', None)
        self.label = kw.get('label',None)
        self.title = kw.get('title',None)
        self.class_ =  kw.get('class_',None)
        self.style =  kw.get('style', None)
        self.parent = kw.get('parent',None)
        self.outputXml = kw.get('outputXml',False)
        self.internalId = kw.get('internalId',None)
        if self.internalId is None:
            report = self.getReport()
            if report is not None:
                className = type(self).__name__
                instanceCount = len(findChildren(report,type(self)))
                self.internalId = className+'_'+str(instanceCount)
            else:
                className = type(self).__name__
                self.internalId = className + '_' + str(Report.elementCount)
                Report.elementCount += 1
    def getReport(self):
        if hasattr(self,'parent') and self.parent is not None: return self.parent.getReport()
        return None
    def data_id(self):
        return 'data_'+self.internalId
    def data_url(self):
        return './tables_as_xml_files/'+self.data_id()+'.xml'
    def as_data_etree(self):
        root = etree.Element(
          'CCP4i2Report{}'.format(type(self).__name__),
          key=self.internalId,
        )
        root.set('class',self.class_ if self.class_ is not None else '')
        root.set('style',self.style if self.style is not None else '')
        root.text = self.text if (hasattr(self, 'text') and self.text is not None) else ''
        root.tail = self.tail if (hasattr(self, 'tail') and self.tail is not None) else ''
        return root

# Container class - base class for reports and folds
class Container(ReportClass):
  tag = 'container'
  ERROR_CODES = { 1 : { 'severity': SEVERITY_WARNING, 'description' : 'Failed to interpret xrt node tag' },
                  2 : { 'description' : 'Can not create IfContainer instance without xrtnode argument (it should not be used in Python mode)' },
                  3 : { 'description' : 'Can not create Loop instance without xrtnode argument (it should not be used in Python mode)' },
                  4 : { 'description' : 'Unable to create RTF file - unable to import PyQt4' }
                  }
  def __init__( self,  xrtnode=None, xmlnode=None, jobInfo = {} , **kw ):
    super(Container,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo = jobInfo, **kw)
    if getattr(self,'errReport',None) is None: self.errReport = CException()
    self.children = []
    self.jobInfo = {}
    self.jobInfo.update(jobInfo)
    self.xrtnode = xrtnode
    self.xmlnode= xmlnode
    self.text = ''
    self.tail = ''
    self._scriptErrorReport = None
    if xrtnode is not None: self.interpretXrt(xrtnode=xrtnode)

  def interpretXrt(self,xrtnode=None):
    if xrtnode is not None:
      if xrtnode.tag in [ XRTNS+'remove', 'remove']:
        self.tag = XRTNS+'remove'
      else:
        self.tag = XHTMLNS+'root'
        # Initialising 'ifContainer' may skip initialising children if the tag is changed to dummy      
        for child in xrtnode:
          obj = getChildObject(child,self.xmlnode,self.jobInfo)
          if obj is None:
            self.errReport.append(self.__class__,1,str(child.tag))
          else:
            self.children.append( obj )       
      self.text = xrtnode.text
      self.tail = xrtnode.tail
    else:
      self.text = kw.get('text',None)
      self.tail = kw.get('tail',None)
    if self.text is None: self.text = ''
    if self.tail is None: self.tail = ''

  def append(self,child):
    if isinstance(child,str):
      self.children.append(Generic(xmlnode=self.xmlnode,text=child))
    else:
      self.children.append(child)
      
  def insert(self,indx,child):
    if isinstance(child,str):
      self.children.insert(indx,Generic(xmlnode=self.xmlnode,text=child))
    else:
      self.children.insert(indx,child)
  

  def __len__(self):
    return len(self.children)

  def addObjectOfClass(self, classOfObject, xrtnode=None,xmlnode=None,jobInfo=None,**kw):
    if xrtnode is None: xrtnode=self.xrtnode
    if xmlnode is None: xmlnode = self.xmlnode
    if jobInfo is None: jobInfo = self.jobInfo
    obj = classOfObject(xrtnode=xrtnode, xmlnode = xmlnode, jobInfo = jobInfo, parent=self, **kw)
    self.children.append(obj)
    return obj

  def addText(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      """This adds plain text to a report. Tags are converted to references. append is also available."""
      return self.addObjectOfClass(Text, xrtnode, xmlnode, jobInfo, **kw)

  def addPre(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Pre, xrtnode, xmlnode, jobInfo, **kw)

  def addGraph(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Graph, xrtnode, xmlnode, jobInfo, **kw)

  def addProgress(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Progress, xrtnode, xmlnode, jobInfo, **kw)

  def addFlotGraph(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(FlotGraph, xrtnode, xmlnode, jobInfo, **kw)

  def addGraphGroup(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(GraphGroup, xrtnode, xmlnode, jobInfo, **kw)

  def addFlotGraphGroup(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(FlotGraphGroup, xrtnode, xmlnode, jobInfo, **kw)

  def addDrawnDiv(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(DrawnDiv, xrtnode, xmlnode, jobInfo, **kw)

  def addObjectGallery(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(ObjectGallery, xrtnode, xmlnode, jobInfo, **kw)

  def addGraphLineChooser(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(GraphLineChooser, xrtnode, xmlnode, jobInfo, **kw)

  def addPictureGroup(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(PictureGroup, xrtnode, xmlnode, jobInfo, **kw)

  def addDiv(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Div, xrtnode, xmlnode, jobInfo, **kw)

  def addTable(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Table, xrtnode, xmlnode, jobInfo, **kw)

  def addPicture(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Picture, xrtnode, xmlnode, jobInfo, **kw)

  def addTitle(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Title, xrtnode, xmlnode, jobInfo, **kw)

  def addLaunch(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Launch, xrtnode, xmlnode, jobInfo, **kw)

  def addDownload(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Download, xrtnode, xmlnode, jobInfo, **kw)

  def addCopyToClipboard(self,xrtnode=None,xmlnode=None,jobInfo=None,text="",label="",**kw):
      return self.addObjectOfClass(CopyToClipboard, text=text,label=label, **kw)

  def addResults(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Results, xrtnode, xmlnode, jobInfo, **kw)

  def addFold(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Fold, xrtnode, xmlnode, jobInfo, **kw)

  def addCopy(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Copy, xrtnode, xmlnode, jobInfo, **kw)
  
  def addHelp(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
      return self.addObjectOfClass(Help, xrtnode, xmlnode, jobInfo, **kw)

  def getPictures(self):
    rv = []
    for child in self.children:
      if isinstance(child,Picture):
        rv.append(child.picDefFile.__str__())
      elif isinstance(child,(Container,Loop)):
        rv.extend(child.getPictures())
    #print 'Container.getPictures',rv
    return rv
  
  def as_html( self ):
    s = ""
    if self.text:
      s += self.text
    for child in self.children:
      s += child.as_html() + "\n"
    if self.tail:
      s += self.tail
    return s

  def as_data_etree(self):
    root = super().as_data_etree()
    for child in self.children:
      if hasattr(child, 'as_data_etree'):
        root.append(child.as_data_etree())
      else:
        print('No as_data_etree on ', type(child).__name__)
    return root

  def as_etree(self):
    # Test if marked for removal or tag is not str (probably <!-- --> comment)
    if self.tag == XRTNS+'remove' or not isinstance(self.tag,str): return None
    root = etree.Element(self.tag)
    root.text = self.text
    root.tail = self.tail
    if self.id is not None: root.set('id',self.id)
    if self.class_ is not None: root.set('class',self.class_)
    if self.style is not None: root.set('style',self.style)
    for child in self.children:
      #print('Container.as_etree',child,type(child))
      try:
          tree = child.as_etree()
          #print 'Container.as_etree',child,tree,tree.tag,len(tree)
          if tree is not None:
            if str(tree.tag) in ['root',XHTMLNS+'root']:
              #print 'Container.as_etree add root',len(root),root.
              root.extend(tree)
              
            elif tree.tag == XRTNS+'dummy':
              # Dont output tags around this (always Text?) element
              # Need to put the text content in either self.text or preceeding siblings tail
              if len(root)>=1:
                root[-1].tail += child.getText()
              else:
                root.text+= child.getText()
            else:
              root.append(tree)
      except:
          raise
          root.append(etree.fromstring(child))
    return root

  def graph_data_as_rtf(self,fileName=None):
    try:
      from PySide2 import QtGui, QtWidgets,QtCore
    except:
      raise CException(self.__class__,4,fileName)

    document = QtGui.QTextDocument()
    graphList = findChildren(self,Graph)
    for graph in graphList:
      table = graph.data_as_rtf(document=document)

    writer = QtGui.QTextDocumentWriter()
    writer.setFormat(QtCore.QByteArray('ODF'))
    writer.setFileName(fileName)
    writer.write(document)

  def errorReport(self):
    err = CException()
    err.extend(self.errReport)
    for child in self.children:
      if getattr(child,'errReport',None) is not None:
        err.extend(child.errorReport())
    return err

  def loadXmlFile(self,fileName):
    from core import CCP4Utils
    text = CCP4Utils.readFile(fileName)
    ele = etree.fromstring(text)
    return ele

  def scriptErrorReport(self):
    from core import CCP4ErrorHandling,CCP4File
    if self._scriptErrorReport is None:
      self._scriptErrorReport = CCP4ErrorHandling.CErrorReport()
      root = self.jobInfo.get('fileroot',None)
      print('scriptErrorReport root',root)
      if root is not None:
        filePath = os.path.join(root,'diagnostic.xml')
        if os.path.exists(filePath):
          i2xml = CCP4File.CI2XmlDataFile(filePath)
          self._scriptErrorReport.setEtree(i2xml.getBodyEtree())
    return self._scriptErrorReport

  
# If class - container for conditional content
class IfContainer( Container ):
  def __init__( self,  xrtnode=None, xmlnode=None , jobInfo={}, target = True, **kw ):
    if xrtnode is None:
      raise CException(self.__class__,2)
    #print 'ReportParser IfContainer',xmlnode.findall( xrtnode.get( "select" ) ),type(xmlnode.findall( xrtnode.get( "select" ) ))
    if xmlnode is not None and len(xmlnode.findall( xrtnode.get( "select" ) )) != 1:
      # Failed to find the 'if' parameter in the output so do not put anything in report
      Container.__init__ ( self, etree.Element(XRTNS+"remove"), xmlnode, jobInfo, **kw )
      return
    try:
      value = toBoolean(xmlnode.findall( xrtnode.get( "select" ) )[0].text)
    except:
      Container.__init__ ( self,  etree.Element(XRTNS+"remove"), xmlnode, jobInfo , **kw )
      return
    #print 'ReportParser IfContainer from program output:',value,'target:',target
    if value == target:
      Container.__init__ ( self, xrtnode, xmlnode, jobInfo )
    else:
      Container.__init__ ( self, etree.Element(XRTNS+"remove"), xmlnode, jobInfo, **kw  )

class Loop(ReportClass):

  def __init__( self,  xrtnode=None, xmlnode=None, jobInfo={}, **kw):
    super(Loop,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
    if xrtnode is None:
      raise CException(self.__class__,3)    
    import copy
    self.children = []
    self.text = xrtnode.text
    self.tail = xrtnode.tail
    selectStr = xrtnode.get('select')
    #print 'Loop.init',selectStr
    if selectStr is not None and xmlnode is not None:
      selectedNodes = xmlnode.findall( selectStr )
      #print 'Loop.init selectedNodes',selectedNodes
      for node in selectedNodes:
        for child in xrtnode:
          childCopy = copy.deepcopy(child)
          obj = getChildObject(childCopy,node,jobInfo)
          if obj is not None: self.children.append( obj )
          #self.children[-1].text = xrtnode.text
          #self.children[-1].tail = xrtnode.tail

      
  def as_etree(self):
    root = etree.Element('root')
    root.text = self.text
    root.tail = self.tail
    if self.id is not None: root.set('id',self.id)
    if self.class_ is not None: root.set('class',self.class_)
    for child in self.children:
      tree = child.as_etree()
      if str(tree.tag) in ['root',XHTMLNS+'root']:
        root.extend(tree)
      elif tree.tag == XRTNS+'dummy':
        # Dont output tags around this (always Text?) element
        # Need to put the text content in either self.text or preceeding siblings tail
        if len(root)>=1:
          root[-1].tail += child.getText()
        else:
          root.text+= child.getText()
      else:
        root.append(tree)
    return root

  def getPictures(self):
    rv = []
    for child in self.children:
      if isinstance(child,Picture):
        rv.append(child.picDefFile.__str__())
      elif isinstance(child,(Container,Loop)):
        rv.extend(child.getPictures())
    #print 'Loop.getPictures',rv
    return rv

# Report class - container for ccp4 html report
class Report( Container ):
    TASKNAME = ''
    TASKVERSION = '0.0.0'
    RUNNING = False
    WATCHED_FILE = None
    FAILED = False
    USEPROGRAMXML = True
    SEPARATEDATA=False
    elementCount = 1
    ERROR_CODES = {0 : { 'severity' : SEVERITY_OK, 'description' : 'OK' },
                   101 : {'description' : 'Import xrt file does not exist'},
                   102 : {'description' : 'Failed to read import xrt file'},
                   103 : {'description' : 'Failed to find insert xrt element in program file'},
                   104 : {'description' : 'Failed to find insert element in imported xrt file'},
                   105 : {'description' : 'Failed loading job info for jobId'},
                   106 : {'description' : 'Failed loading XML file'},
                   107 : {'description' : 'Failed creating csv file'},
                   108 : {'description' : 'Failed creating xml data file'}, }
   
    def __init__(self, xrtnode=None, xmlnode=None, jobInfo = {}, **kw ):
        Container.__init__(self, xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
        self.tag = 'report'
        self.pictureQueue = None
        self.standardise = kw.get('standardise',False)
        self.jobNumber = kw.get('jobNumber',None)
        self.projectId = kw.get('projectId',None)
        self.jobStatus = kw.get('jobStatus',None)
        self.cssFile = kw.get('cssFile',None)
        self.jsFile = kw.get('jsFile',None)
        self.additionalCssFiles = kw.get('additionalCssFiles',None)
        self.additionalJsFiles = kw.get('additionalJsFiles',None)
        self.additionalScript = kw.get('additionalScript',None)
        self.requireDataMain = kw.get('requireDataMain','mosflmApp')
        self.referenceList = []
        self.htmlBase =  kw.get('htmlBase',None)
        self.cssVersion =  kw.get('cssVersion',None)
        if 'jobId' in kw:
            try:
                from report import CCP4ReportGenerator
                jobInfo = CCP4ReportGenerator.getReportJobInfo(kw['jobId'])
                self.jobInfo.update(jobInfo)
            except:
                self.errReport.append(self.__class__,105,kw['jobId'])
                return
        if xmlnode is None and 'xmlFile' in kw:
            try:
                text = open( kw['xmlFile'] ).read()
                self.xmlnode = etree.fromstring( text, PARSER() )
            except Exception as e:
                self.errReport.append(self.__class__,106, 'Reading file: '+str(kw['xmlFile'])+'\n'+str(e))
                return
        if xrtnode is not None:
            xrtnode = self.removeComments(xrtnode)
            if xmlnode is not None: xrtnode = self.makeInserts(xrtnode, xmlnode)
            if self.standardise and str(xrtnode.tag) == 'report':
                xrtnode = self.standardiseXrtReport(xrtnode)
            Container.interpretXrt(self,xrtnode=xrtnode)
        #self._makeMgPicture = None

    def getJobFolder(self):
        return self.jobInfo.get('fileroot')

    def removeComments(self,xrtnode):
        for ele in xrtnode.iterfind('.//'+XRTNS+'comment'):
            #print 'Removing comment',ele.text
            ele.getparent().remove(ele)
        return xrtnode
      
    def makeInserts(self,xrtnode, xmlnode):
        for insertEle in xrtnode.iterfind('.//'+XRTNS+'insertXrt'):
            ele = None
            if insertEle.get('filename') is not None:
                from core import CCP4Utils
                fileName = insertEle.get('filename')
                if fileName[0:8] == '$CCP4I2/':
                    fileName = os.path.join(CCP4Utils.getCCP4I2Dir(),fileName[8:])
                #print 'Report.makeInserts fileName',fileName
                if not os.path.exists(fileName):
                    self.errReport.append(self.__class__,101,fileName)
                else:
                    try:
                        ele = etree.fromstring( open(fileName ).read(), PARSER() )
                    except:
                        self.errReport.append(self.__class__,102,fileName)
                    else:
                        # Look for sub-element of the inserted file
                        if insertEle.get('select') is not None:
                            path = insertEle.get('select')
                            ele0 = ele.find(path)
                            if ele0 is None:
                                self.errReport.append(self.__class__,104,'file: '+str(fileName)+' findall: '+str(path))
                            else:
                                ele = ele0
            # This is looking in the program output for xrt - dubious.
            elif insertEle.get('select') is not None:
                path = insertEle.get('select')
                ele = xmlnode.find(path)
                if ele is None:
                    self.errReport.append(self.__class__,103,path)
            if ele is not None:      
                for child in ele.getchildren(): insertEle.addnext(child)
                insertEle.getparent().remove(insertEle)
            #print etree.tostring(xrtnode,pretty_print=True)
        return xrtnode

    def containsPictures(self):
        #print 'Report.containsPictures',self._makeMgPicture
        #if self._makeMgPicture is None or len(self._makeMgPicture.pictureQueue)==0:
        if self.pictureQueue is None:
            self.pictureQueue = self.getPictures()
        if len(self.pictureQueue) == 0:
            return False
        else:
            return True

    def makeMgPicture(self):
        if self._makeMgPicture is None:
            import CCP4MakeMgPicture
            self._makeMgPicture = CCP4MakeMgPicture.CMakeMgPicture(jobInfo=self.jobInfo)
        return self._makeMgPicture

    def standardisePythonReport(self):
        self.children.insert(0,Title(jobInfo = self.jobInfo))
        for cls in (InputData,OutputData,JobDetails,JobLogFiles):
            add = True
            for child in self.children:
                if isinstance(child,cls):
                    add = False
                    break
            if add: self.children.append(cls(jobInfo=self.jobInfo))
        # If there is not list of references try adding the default for the task
        if len(self.referenceList)==0: self.addTaskReferences()
        if len(self.referenceList)>0:
            fold = Fold(label='Bibliographic references',brief='Biblio',jobInfo=self.jobInfo)
            fold.children.extend(self.referenceList)
            if isinstance(self.children[-1],JobDetails):
                self.children.insert(-1,fold)
            else:
                self.children.append(fold)
    
               
    def standardiseXrtReport(self,report):
        #if report.find(XRTNS+'title') is None:
        #  titleEle = etree.Element(XRTNS+'title')
        #  report.insert(0,titleEle)      
        if report.find(XRTNS+'inputdata') is None:
            inEle = etree.Element(XRTNS+'inputdata')
            report.append(inEle)
        if report.find(XRTNS+'outputdata') is None:
            outEle = etree.Element(XRTNS+'outputdata')
            report.append(outEle)
        #if report.find(XRTNS+'drilldown') is None:
        #  jobEle = etree.Element(XRTNS+'drilldown')
        #  report.append(jobEle)
        if report.find(XRTNS+'jobdetails') is None:
            jobEle = etree.Element(XRTNS+'jobdetails')
            report.append(jobEle)
        return report

    def as_html_file(self,fileName,pretty_print=True,htmlBase=None,cssVersion=None):
        from core import CCP4Utils
        text = self.as_html(htmlBase=htmlBase,cssVersion=cssVersion)
        if pretty_print:
            try:
                from bs4 import BeautifulSoup # No bs4 in ccp4 so this will not work
                soup=BeautifulSoup(text)
                prettyHTML=soup.prettify()
                CCP4Utils.saveFile(fileName=fileName,text=prettyHTML)
            except:
                CCP4Utils.saveFile(fileName=fileName,text=text)
        else:
            CCP4Utils.saveFile(fileName=fileName,text=text)

    def as_html(self, htmlBase=None,cssVersion=None):
        import sys

        def remove_namespace(doc,namespace,newname,toplevel="XXXXX_UNLIKELY_XXXXX"):
            """Remove namespace in the passed document in place."""
            ns = u'{%s}' % namespace
            nsl = len(ns)
            for elem in doc.iter():
                attribNew = {}
                for k,v in elem.attrib.items():
                    if type(k) is str and k.startswith(ns):
                        attribNew[newname+":"+k[nsl:]] = v
                    else:
                        attribNew[k] = v
                elem.attrib = attribNew
                if elem.tag.startswith(ns):
                    elem.tag = elem.tag[nsl:]
                    if elem.tag == toplevel:
                        elem.attrib["xmlns:"+newname] = namespace
 
        tree = self.as_etree(htmlBase,cssVersion=cssVersion)
        remove_namespace(tree, u"http://www.w3.org/2000/svg","svg","svg")
        remove_namespace(tree, u"http://www.w3.org/1999/xlink","xlink")
        text = b'<!DOCTYPE html>\n'
        try:
            text += etree.tostring(tree.getroot(), short_empty_elements=False, method="html")
        except:
            exc_type, exc_value, exc_tb = sys.exc_info()[:3]
            sys.stderr.write(str(exc_type) + '\n')
            sys.stderr.write(str(exc_value) + '\n')
            import traceback
            traceback.print_stack()
        return text

    def as_data_etree(self):
        if self.standardise: self.standardisePythonReport()
        root = super().as_data_etree()
        return root

    def as_etree(self, htmlBase=None,cssVersion=None):
        if self.standardise: self.standardisePythonReport()
        if cssVersion is None: cssVersion = self.cssVersion
        if htmlBase is not None:
            doc = htmlDoc(htmlBase=htmlBase,cssFile=self.cssFile,jsFile=self.jsFile,cssVersion=cssVersion,title=self.getTitle(),additionalJsFiles=self.additionalJsFiles, additionalCssFiles=self.additionalCssFiles, requireDataMain=self.requireDataMain,additionalScript=self.additionalScript)
        elif self.jobNumber is not None:
            nSub = self.jobNumber.count('.')
            htmlBase = '../..'
            for n in range(nSub): htmlBase = htmlBase + '/..'
            htmlBase = htmlBase + '/report_files'
            doc = htmlDoc(htmlBase=htmlBase,cssFile=self.cssFile,jsFile=self.jsFile,cssVersion=cssVersion,title=self.getTitle(),additionalJsFiles=self.additionalJsFiles, additionalCssFiles=self.additionalCssFiles, requireDataMain=self.requireDataMain,additionalScript=self.additionalScript)
        else:
            doc = htmlDoc(cssFile=self.cssFile,jsFile=self.jsFile,cssVersion=cssVersion,title=self.getTitle(), additionalJsFiles=self.additionalJsFiles, additionalCssFiles=self.additionalCssFiles, requireDataMain=self.requireDataMain, additionalScript=self.additionalScript)
        body = doc.getroot().findall('./body')[0]
        #print 'Report.as_etree',self,etree.tostring(Container.as_etree(self),pretty_print=True)
        tree = Container.as_etree(self)
        body.text = tree.text
        body.tail = tree.tail
        body.extend(tree)
        if self.style is not None: body.set('style',self.style)
        if self.standardise: self.addLinks(body)
        return doc

    def addLinks(self,body):
        links = etree.Element('div')
        #links.set('class','links')
        #eleTree = etree.parse(StringIO('<ccp4:ccp4_data xmlns:ccp4="'+CCP4NS+'"></ccp4:ccp4_data>'))
        #links = eleTree.getroot()
        links.set('id','navbar')
        #links.set('type','CLinksInReport')
        #links.set('style','display:none;')
        linkList =  [ ['inputData','Input data'],['outputData','Output data'] ]
        folds = findChildren(self,Fold)
        for item in folds: linkList.append([item.label,item.label])
        drillDownList = findChildren(self,DrillDown)
        if len(drillDownList)>0: linkList.append(['Show Sub-Jobs','Show Sub-Jobs'])
        linkList.append(['jobDetails','Job details'])
        #print 'addLinks linkList',linkList
        for href,label in linkList:
            print(href)
            anchor = etree.Element('a')
            anchor.set('href','#'+href)
            anchor.text = label
            links.append(anchor)   
        title = body.find("h4")
        #print 'addLinks title',title
        """
        if title is None:
          body.insert(0,links)
        else:
          body.insert(2,links)
        """

    def getTitle(self):
        if 'jobnumber' in self.jobInfo and 'tasktitle' in self.jobInfo:
            title = self.jobInfo['jobnumber']+' '+self.jobInfo['tasktitle']
        else:
            title =  'CCP4 Report'

    def makeCSVFiles(self,directory=None):
        from core import CCP4Utils
        if directory is None: directory = os.getcwd()
        graphList = findChildren(self,Graph)
        flotGraphList = findChildren(self,FlotGraph)
        tableList = findChildren(self,Table)
        for name,objList in [ ['graph',graphList],['table',tableList],['flotgraph',flotGraphList]]:
          for obj in objList:
            if getattr(obj,'outputCsv',True):
              title = str(obj.id)
              if obj.title is not None: title = title +'_'+CCP4Utils.safeOneWord(obj.title)
              fileName = os.path.normpath(os.path.join(directory,title+'.csv'))
              #print 'Report.makeCSVFiles fileName',fileName
              self.errReport.extend(obj.data_as_csv(fileName=fileName))
    
    def makeXMLFiles(self,directory=None):
        from core import CCP4Utils
        if directory is None: directory = os.getcwd()
        for ofClass in [Table, FlotGraph, FlotGraphGroup, Progress, Text, Pre]:
            objList = findChildren(self, ofClass)
            for obj in objList:
                if getattr(obj,'outputXml',False):
                    if ofClass == FlotGraphGroup:
                        fileRoot = os.path.normpath(os.path.join(directory,obj.data_url()))
                        self.errReport.extend(obj.data_as_xmls(fileRoot=fileRoot))
                    else:
                        fileName = os.path.normpath(os.path.join(directory,obj.data_url()))
                        #print 'Report.makeXMLFiles fileName',fileName
                        self.errReport.extend(obj.data_as_xml(fileName=fileName))

    def clearXMLFiles(self,directory=None):
        from core import CCP4Utils
        if directory is None: directory = os.getcwd()
        for ofClass in [Table, FlotGraph, Progress, Pre]:
            objList = findChildren(self, ofClass)
            for obj in objList:
                if getattr(obj,'outputXml',False):
                    fileName = os.path.normpath(os.path.join(directory,obj.data_url()))
                    os.remove(fileName)
                    #print 'Report.makeXMLFiles fileName',fileName

    def addReference(self,xrtnode=None,xmlnode=None,jobInfo=None,**kw):
        if xmlnode is None: xmlnode = self.xmlnode
        if jobInfo is None: jobInfo = self.jobInfo
        if not hasattr(self,'referenceList'): self.referenceList = [ ReferenceGroup() ]
        obj = Reference(xrtnode=xrtnode, xmlnode = xmlnode, jobInfo = jobInfo, **kw)
        self.referenceList[-1].append(obj)
        return obj

    def addTaskReferences(self,taskName=None,drillDown=True):
        if taskName is None: taskName = self.TASKNAME
        if not hasattr(self,'referenceList'): self.referenceList = [ ]
        from core import CCP4TaskManager
        helpFileList =  CCP4TaskManager.TASKMANAGER().searchReferenceFile(name=taskName,drillDown=drillDown)
        #print 'Report.addTaskReferences',helpFileList
        for helpFile in helpFileList:
            self.referenceList.append(ReferenceGroup())
            self.referenceList[-1].loadFromMedLine(fileName=helpFile)

    def getReport(self):
        return self

    def newPageOrNewData(self):
        # MN This function returns the string "NEWPAGE" if it has generated new
        # HTML code, or "NEWDATA" if it has generated only new data to be supplied to existing
        # widgets on the GUI.  Code that uses this call will decide whether to force an HTML reload
        # or simply cause a loaded report  to reload its data.
        if not self.SEPARATEDATA:
            #print 'Newpage because not SEPARATEDATA'
            return "NEWPAGE"
        if not hasattr(self, 'jobStatus'):
            #print 'Newpage because not has jobStatus'
            return "NEWPAGE"
        if not hasattr(self.jobStatus, 'lower'):
            #print 'Newpage because not lowerable jobStatus'
            return "NEWPAGE"
        if not self.jobStatus.lower()=='running':
            #print 'Newpage because not running'
            return "NEWPAGE"
        #Here we look to see if data files for *ALL* report element for which data are separated
        #already have data files...this would imply that we should return newdata
        try:
            flotGraphs = findChildren(self, FlotGraph)
            #flotGraphGroups = findChildren(self, FlotGraphGroup)
            tables = findChildren(self, Table)
            progresses = findChildren(self, Progress)
            pres = findChildren(self, Pre)
            #texts = findChildren(self, Text)
            xmlSeparableItems = progresses+flotGraphs+tables+pres#+texts
            result="NEWDATA"
            import os
            for xmlSeparableItem in xmlSeparableItems:
                if not xmlSeparableItem.outputXml:
                    #print 'Newpage because ',xmlSeparableItem,'is not outputXML'
                    result="NEWPAGE"
                    continue
                xmlPath = os.path.normpath(os.path.join(self.jobInfo['fileroot'],xmlSeparableItem.data_url()))
                if not os.path.isfile(xmlPath):
                    #print 'Newpage because ',xmlPath,'does not exist'
                    result="NEWPAGE"
                    continue
            return result
        except:
            return "NEWPAGE"

    def showWarnings(self):
        """
        Deal with any Warnings blocks created by CPluginScript.createWarningsXML
        """
        xmlnode = self.xmlnode

        warningsNodes = xmlnode.findall('Warnings')
        if len(warningsNodes)>0:

            haveWarnings = False
            for wsN in warningsNodes:
                logFileNodes = wsN.findall("logFile")
                for lfN in logFileNodes:
                    fileWarningsNode = lfN.findall("warning")
                    if len(fileWarningsNode)>0:
                        haveWarnings = True
                        break
                if haveWarnings: break

            if haveWarnings:
                warningsFold = self.addFold(label='Warnings', initiallyOpen=False,brief='Warnings')
                topDiv = warningsFold.addDiv(style='border:0px solid blue; overflow:auto;')

                for wsN in warningsNodes:
                    logFileNodes = wsN.findall("logFile")
                    for lfN in logFileNodes:
                        fileWarningsNode = lfN.findall("warning")
                        if len(fileWarningsNode)>0:
                            logFileDiv = topDiv.addDiv(style='border:0px solid black; position: relative; float: left;')
                            logFileDiv.append("<h4>"+lfN.findall("fileName")[0].text+"</h4>")
                            for wN in fileWarningsNode:
                                textNode = wN.findall("text")[0]
                                typeNode = wN.findall("type")[0]
                                if typeNode.text == "ERROR":
                                    clearDiv = logFileDiv.addDiv(style="color:red;")
                                    logFileDiv.append("<pre>"+textNode.text+"</pre>")
                                elif typeNode.text == "WARNING":
                                    clearDiv = logFileDiv.addDiv()
                                    logFileDiv.append("<pre>"+textNode.text+"</pre>")
                                elif typeNode.text == "ATTENTION":
                                    clearDiv = logFileDiv.addDiv()
                                    logFileDiv.append("<pre>"+textNode.text+"</pre>")

class Results(Container):
  def as_etree(self, htmlBase=None):
    root = etree.Element('root')
    anchor = etree.Element('a')
    anchor.set('name','results')
    root.append(anchor)
    head = etree.Element('h5')
    if self.id is not None: head.set('id',self.id)
    if self.class_ is not None:
      head.set('class',self.class_)
    else:
      head.set('class','section')
      #Substituted .style for .class_ below....looked like a typo MN
      #if self.style is not None: head.set('style',self.class_)
    if self.style is not None: head.set('style',self.style)
    
    head.text = 'Results'
    root.append(head)
    root.extend(Container.as_etree(self))
    return root

class DrillDown(ReportClass):
  
  def __init__(self,jobInfo,**kw):
    super(DrillDown,self).__init__(**kw)
    self.jobInfo = jobInfo
    #print 'DrillDown jobInfo',jobInfo
  
  def as_etree(self):
    # Check that ther are some sub-directories
    # Beware fileroot has fragment of file name on end of directory path
    jobDir = self.jobInfo.get('fileroot',None)
    if jobDir is not None: jobDir = os.path.split(jobDir)[0]  
    subJobs = self.getSubJobs(jobDir)
    #print 'DrillDown.as_etree subJobs',subJobs
    if len(subJobs)==0: return  etree.Element('root')
    
    # make a folder
    '''
    fold = foldTitleLine('Show Sub-Jobs')
    if fold.tag == 'root':
      root.extend(fold)
    else:
      root.append(fold)
    div = root.find('div')
    '''
    div = etree.Element('div')
    div.set('class','sub-job-list')
    if self.id is not None: div.set('id',self.id)
    if self.class_ is not None: div.set('class',self.class_)
    h4 = etree.Element('h4')
    h4.text = 'Sub-Jobs'
    div.append(h4)
    
    try:
      from core import CCP4TaskManager
      ifi2 = True
    except:
      ifi2 = False

    
    for job in subJobs:
       # jobs is list of subJobNumber,jobId,pluginName,reportFile,subJobs
      text = str(job[0])+': '
      if job[1] is not None:
        if ifi2:
          text = text + CCP4TaskManager.TASKMANAGER().getTitle(job[2])
          
        else:
          text = text + job[2]         
      fold = foldLinkLine(text,job[3],'jobId'+str(job[1]))
      div.extend(fold)

      '''
      # Simple link mode
      div = root.find('div')
      a =  etree.Element('a')
      a.set('href',job[3])
      a.set('id','jobId'+str(job[1]))
      a.text= text
      div.append(a)
      div.append(etree.Element('br'))
      '''   
      
      '''
      # Alternative 'button' mode
      obj = etree.Element('object')
      obj.set('class','qt_object_subjob')
      obj.set('type','x-ccp4-widget/CSubJobButton')
      #obj.set('id',self.id+'_'+str(job[0]))
      div.append(obj)

      for key,value in [['label',text],['jobId',str(self.jobInfo.get('jobid',None))],['subJobNumber',job[0]],['link',job[2]]:
        p = etree.Element('param')
        p.set('name',key)
        p.set('value',value)
        obj.append(p)
      '''
    return div

  def getSubJobs(self,jobDir):
    import glob
    from core import CCP4File
    if jobDir is None: return []
    globDirs = glob.glob(os.path.join(jobDir,'job_*'))
    def sortSubJobsKey(inp):
      return int(inp.split('_')[-1])
    sortedDirs = sorted(globDirs,key=sortSubJobsKey)
    retSubJobs = []
    for path in sortedDirs:
      subJobs = self.getSubJobs(path)
      parsFile = glob.glob(os.path.join(path,'*.params.xml'))
      if len(parsFile)>0:
        # Get taskName from file 
        f = CCP4File.CI2XmlDataFile(fullPath=parsFile[0])
        pluginName = str(f.header.get('pluginName'))
        jobId = int(f.header.get('jobId'))
      else:
        pluginName = None
        jobId = None
      '''
      reportFile =  glob.glob(os.path.join(path,'*.report.html'))
      if len(reportFile) == 0:
        reportFile = None
      else:
        reportFile = reportFile[0]
      '''
      reportFile = parsFile[0][0:-10]+'report.html'
      
      retSubJobs.append([os.path.split(path)[-1].split('_')[-1],jobId,pluginName,reportFile,subJobs])
      
    return retSubJobs


def foldTitleLine(label, initiallyOpen, brief = None):
  root = etree.Element('root')
  anchor = etree.Element('a')
  anchor.set('name',label)
  root.append(anchor)
  span = etree.Element('span')
  span.set('class','folder')
  if brief is not None: span.set('title',brief)
  span.set('onclick',"toggleview(this)")
  if initiallyOpen:
      span.text = u"\u25BC"+ " "+label
  else:
      span.text = u"\u25B6"+ " "+label
  root.append(span)
  div = etree.Element('div')
  if initiallyOpen:
      div.set('class','hidesection displayed')
  else:
      div.set('class','hidesection hidden')
  root.append(div)
  return root

def foldLinkLine(label,href,id):
  '''
  root = etree.Element('root')
  anchor = etree.Element('a')
  anchor.set('name',label)
  root.append(anchor)
  span = etree.Element('span')
  span.set('class','folder_link')
  a =  etree.Element('a')
  a.set('href',href)
  a.set('id',id)
  a.text = 'Show '+label
  span.append(a)
  root.append(span)
  return root
  '''

  '''
  Aiming for..
  <span class="folder" onclick="togglesubjob(this)">Show 1: Model building - Buccaneer</span>
  <div id="jobId613" class="subjob"></div>
  '''
  root = etree.Element('root')
  span = etree.Element('span')
  span.set('class','folder')
  span.set('onclick',"togglesubjob(this)")
  span.text = 'Show '+label
  root.append(span)
  div = etree.Element('div')
  div.set('id',id)
  div.set('class','subjob')
  root.append(div)
  return root
    
# Fold class - container for a hidden report within a report
class Fold( Container ):
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
    super(Fold,self).__init__(xrtnode=xrtnode,xmlnode=xmlnode,jobInfo=jobInfo, **kw )
    if xrtnode is not None:
      self.label = xrtnode.get('label','Show details')
      self.brief = xrtnode.get('brief',None)
    else:
      self.label = kw.get('label','Fold')
      self.brief = kw.get('brief',None)
    self.initiallyOpen = kw.get('initiallyOpen',False)

  def as_html( self ):
    return """<span class='folder' onclick='toggleview(this)'>Show details</span><div class='hidesection'>\n{0}</div>\n""".format(Container.as_html(self))

  def as_data_etree(self):
    if self.brief is None or len(self.brief) == 0:
      self.brief = self.label
    root = super().as_data_etree()
    root.set('label', self.label)
    root.set('initiallyOpen', str(self.initiallyOpen))
    root.set('brief', self.brief)
    return root

  def as_etree(self):
    root = foldTitleLine(self.label, self.initiallyOpen, self.brief)
    root.find('div').extend(Container.as_etree(self))
    return root

class Text(ReportClass):
  tag='span'
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {},  **kw ):
    super(Text,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo,  **kw)
    self.text = ""
    self.tail = ""
    #print 'Text.init',xrtnode.get( "if" ),xrtnode.get( "select" ),xrtnode.text,xrtnode.tail
    if xrtnode is not None and len(xrtnode)>0:
      if xrtnode.get( "if" ) is not None and (xmlnode is None or not bool(xmlnode.findall( xrtnode.get("if")))):
          return
      if xrtnode.text: self.text += xrtnode.text
      #print 'Text.init self.text',self.text
      if xrtnode.tail: self.tail += xrtnode.tail 
      if xrtnode.get( "select" ) and xmlnode is not None:
        nodes = xmlnode.findall( xrtnode.get( "select" ) )
        for node in nodes: 
          self.text += node.text
    elif kw.get('text',None) is not None:
      self.text += kw['text']
      #print 'Text.__init__',text
    elif kw.get('select',None) is not None and xmlnode is not None:
      nodes = xmlnode.findall( kw['select'] )
      for node in nodes: 
          self.text += node.text
  
  def as_html( self ):
    return self.text

  def as_data_etree(self):
    root = super().as_data_etree()
    return root

  def as_etree(self):
    # Tag as dummy so parent container will strip the tags
    if self.outputXml:
        return  etree.fromstring('<span data-url="'+self.data_url()+'"></span>')
    else:
        return self.data_as_xml()
      
  def data_as_xml(self, fileName=None):
    # Tag as dummy so parent container will strip the tags

    if self.text is not None:
        root = etree.Element("div")
    else:
        root = etree.Element(self.tag)

    if self.style is not None: root.set('style',self.style)
    if self.class_ is not None: root.set('class',self.class_)
    try:
      if self.text is not None: 
          #This is a hack to deal with libxml2 crash with "some" strings on macOS. SJM 01/09/2023
          ts = self.text.split("\n")
          for t in ts:
              el = etree.Element(self.tag)
              if self.style is None: el.set('style',"line-height: normal; margin: 0px 0px 0px 0px;")
              el.text = t
              root.append(el)
    except:
      print('Failed creating XML for:',self.text)
    try:
      if self.tail is not None: root.tail = self.tail
    except:
      print('Failed creating XML for:',self.tail)
    #print 'Text.as_etree',root.text,root.tail
    
    if fileName is not None:
        with open(fileName,'w') as outputFile:
            if sys.version_info > (3,0):
                outputFile.write(etree.tostring(root).decode())
            else:
                outputFile.write(etree.tostring(root))
    
    return root

  def getText(self):
    if len(self.text)==0 or len(self.tail)==0 or self.text[-1]==' ' or self.tail[0]==' ':
      return self.text + self.tail
    else:
      return self.text + ' ' + self.tail

class Pre(Text):
    tag='pre'

# Status class
class Status(Container):

  def as_html( self ):
    return "<div width='100%' style='background-color:#80FF80;'><h1>"+self.text+"</h1></div>"

  def as_etree(self):
    div = etree.Element('div')
    if self.id is not None: div.set('id',self.id)
    if self.class_ is not None: div.set('class',self.class_)
    #div.set('width','100%')
    if self.style is not None:
      div.set('style',self.style)
    else:
      div.set('style','background-color:#80FF80;')
    div.extend(self.text)
    return div
    

# Copy class
class Copy(ReportClass):
  def __init__( self, xrtnode=None, xmlnode=None, **kw ):
    super(Copy,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, **kw)
    self.text = ""
    self.root = etree.Element('root')
    if xmlnode is not None:
       if xrtnode is not None:
          self.root.extend(xmlnode.findall( xrtnode.get( "select" ) ))
       elif kw.get('select',False):
          self.root.extend(xmlnode.findall(kw.get('select',False)))

     
    #print 'Copy __init__ root',self.root.tag

  def as_html( self ):
    text = ''
    for node in self.root.iterChildren(): 
      text += etree.tostring( node )
    return text

  def as_etree(self):
    return self.root



class Generic(ReportClass):

  ERROR_CODES = { 1 : { 'description' : 'Can not interpret text' },
                  2 : { 'description' : 'Error substituting values into generic item' }  }
  def __init__(self,xrtnode=None,xmlnode=None,jobInfo={},text=None,defaultTag='p',**kw):
    super().__init__()
    self.id = kw.get('id',None)
    self.class_ = kw.get('class_',None)
    self.xmltree = None

    if xrtnode is None and text is not None:
      try:
        if sys.version_info > (3,0):
            xrtnode = etree.fromstring(text.encode('utf-8'))
        else:
            xrtnode = etree.fromstring(text,PARSER())
      except:
        try:
            if sys.version_info > (3,0) and type(text) == bytes:
                xrtnode = etree.fromstring('<'+defaultTag+'>'+text.encode('utf-8')+'</'+defaultTag+'>')
            else:
                xrtnode = etree.fromstring('<'+defaultTag+'>'+text+'</'+defaultTag+'>')
        except:
          raise
          raise CException(self.__class__,1,str(text))

    if xrtnode is not None:
      try:
        self.xmltree = applySelect(xrtnode,xmlnode,jobInfo)
      except:
        if text is not None:
          self.errReport.append(self.__class__,2,str(text))

  def as_data_etree(self):
    root = super().as_data_etree()
    root.append(self.xmltree)
    return root

  def as_etree(self):
    if self.id is not None: self.xmltree.set('id',self.id)
    if self.class_ is not None: self.xmltree.set('class',self.class_)
    return self.xmltree

# Table class
class BaseTable(ReportClass):
  tableCount = 0
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo={}, **kw ):
    super(BaseTable,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, **kw)
    BaseTable.tableCount += 1
    self.id = kw.get('id','table_'+str( BaseTable.tableCount))
    self.coldata = []
    self.coltitle = []
    self.colsubtitle = []
    self.colTips = []
    self.xmldata = []
    self.help = None
    self.download  = None
    self.outputCsv = kw.get('outputCsv',True)
    downloadable = kw.get('downloadable',False)
    
    if downloadable:
      if self.title is not None:
        self.download = Download(jobInfo=jobInfo,dataName=self.id+'_'+self.title)
      else:
        self.download = Download(jobInfo=jobInfo,dataName=self.id)
    if xrtnode is not None:
      self.excludeIfDataMissing = xrtnode.get('excludeIfDataMissing',False)
      if xmlnode is not None:
        self.xmldata = xmlnode.findall( xrtnode.get( "select" ) )
      self.transpose = ( xrtnode.get( "transpose" ) != None )
      if xrtnode.get( "help" ) is not None:
        self.help =   Help(ref = xrtnode.get( "help" ))
    else:
      self.excludeIfDataMissing = kw.get('excludeIfDataMissing',False)
      if xmlnode is not None:
        if kw.get('select',None) is not None:
          self.xmldata = []
          tableEleList = []
          for p in kw['select'].split("|"):
             self.xmldata.extend(xmlnode.findall(p.strip()))
        elif kw.get('selectNodes',None) is not None:
          self.xmldata = kw['selectNodes']
        else:
          self.xmldata = [ xmlnode ]
      self.transpose = kw.get('transpose',False)
      if kw.get('help',None) is not None:
        self.help = Help(ref = kw['help'])
    # assemble column data

    if xrtnode is not None:
      for col in xrtnode:
        if col.tag == XRTNS+"data":
          colttl1 = col.get( "title" )
          colttl2 = col.get( "subtitle" )
          colexpr = col.get( "expr" )
          colsel  = col.get( "select" )
          self.addData(xmldata=self.xmldata,title=colttl1,subtitle=colttl2,expr=colexpr,select=colsel)
    
  def addData(self,xmldata=None,title=None,subtitle=None,expr=None,function=None,select=None,data=[], tip=None):
    if tip is not None:
        self.colTips.append(tip)
    else:
        self.colTips += [None]
    colvals = []
    if xmldata is not None:
      if not isinstance(xmldata,list): xmldata = [xmldata ]
    else:
      xmldata = self.xmldata
    if select != None:         # select the values from the xml
      for x in xmldata:
        for selitem in x.findall( select ):
          if selitem.text is None:
            val = '-'
          else:
            val = selitem.text.strip()
            if expr != None:  # allow an expression to be applied to the data
              try:
                val = eval( expr, {"x":float(val)} )
              except:
                val = '-'
            if function is not None:
              val = function(val)
          colvals.append(val)
    else:                      # allow a list of values to be given
        colvals.extend(data)
    if self.excludeIfDataMissing and len(colvals)==0:
      pass
    else:
      self.coldata.append(colvals)
      maxlen = max( [ len(col) for col in self.coldata ] )
      for i in range(len(self.coldata)):
        while len(self.coldata[i]) < maxlen:
          self.coldata[i].append(None)
      self.coltitle.append(title)
      self.colsubtitle.append(subtitle)

  def as_html( self ):
    # check for subheads
    hassubhead = sum( [ x != None for x in self.colsubtitle ] ) > 0
    # deal with normal and transpose tables in turn
    if not self.transpose:
      # Normal tables
      s = "<table><thead>\n"
      # column headers
      s += "<tr>"
      for i in range(len(self.coltitle)):
        if self.coltitle[i] != None:
          span = 1
          while i+span < len(self.coltitle):
            if self.coltitle[i+span] != None:
              break
            span += 1
          text = self.coltitle[i] if self.coltitle[i] else ""
          colTip = ""
          if i>=0 and i<len(self.colTips) and self.colTips[i] is not None:
              colTip = "title='{0}'".format(self.colTips[i])
          if span > 1:
            s += "<th colspan='{0}' {1}>{2}</th>".format(span, colTip, text)
          else:
            s += "<th {0}>{1}</th>".format(colTip, text)
      # column subheaders
      if hassubhead:
        s += "</tr>\n<tr>"
        for i in range(len(self.colsubtitle)):
          if self.coltitle[i] != None or self.colsubtitle[i] != None:
            span = 1
            while i+span < len(self.colsubtitle):
              if self.coltitle[i+span] != None or self.colsubtitle[i+span] != None:
                break
              span += 1
            text = self.colsubtitle[i] if self.colsubtitle[i] else ""
            colTip = ""
            if i>=0 and i<len(self.colTips) and self.colTips[i] is not None:
                colTip = "title='{0}'".format(self.colTips[i])
            if span > 1:
              s += "<th colspan='{0}' {1}>{2}</th>".format(span, colTip, text)
            else:
              s += "<th>{0}</th>".format(text)
      s += "</tr>\n</thead>\n"
      # column data
      s += "<tbody>\n"
      for i in range(len(self.coldata[0])):
        s += "<tr>"
        for col in self.coldata:
          colTip = ""
          if col>=0 and col<len(self.colTips) and self.colTips[col] is not None:
            colTip = "title='{0}'".format(self.colTips[col])
          s += "<td {0}>{1}</td>".format(colTip, col[i])
        s += "</tr>\n"
      s += "</tbody></table>\n"
    else:
      # Transpose tables
      s = "<table><tbody>\n"
      # column headers
      for i in range(len(self.coldata)):
        s += "<tr>"
        colTip = ""
        if col>=0 and col<len(self.colTips) and self.colTips[col] is not None:
          colTip = "title='{0}'".format(self.colTips[col])
        if self.coltitle[i] != None:
          s += "<th {0}>{1}</th>".format(colTip, self.coltitle[i])
        else:
          s += "<th {0}></th>".format(colTip)
        if hassubhead:
          if self.colsubtitle[i] != None:
            s += "<th>{0}</th>".format(self.colsubtitle[i])
          else:
            s += "<th></th>"
        for j in range(len(self.coldata[i])):
          s += "<td {0}>{0}</td>".format(colTip, self.coldata[i][j])
        s += "</tr>\n"
      s += "</tbody></table>\n"
    return s

  def as_etree(self):
    # check for subheads
    hassubhead = sum( [ x != None for x in self.colsubtitle ] ) > 0
    table = etree.Element('table')
    if self.id is not None: table.set('id',self.id)
    if self.class_ is not None: table.set('class',self.class_)
    if self.style is not None: table.set('style',self.style)
    
    # deal with normal and transpose tables in turn
    if not self.transpose:
      head = etree.Element('thead')
      table.append(head)
      headtr = etree.Element('tr')
      for i in range(len(self.coltitle)):
        if self.coltitle[i] != None:
          span = 1
          while i+span < len(self.coltitle):
            if self.coltitle[i+span] != None:
              break
            span += 1
          th =  etree.Element('th')
          th.text = self.coltitle[i] if self.coltitle[i] else ""
          if span > 1: th.set('colspan',str(span))
          headtr.append(th)
      head.append(headtr)
      tbody = etree.Element('tbody')
      tbody.set('class','fancy')
      for i in range(len(self.coldata[0])):
        tr= etree.Element('tr')
        for col in self.coldata:
          td = etree.Element('td')
          td.text = str(col[i])
          tr.append(td)
        tbody.append(tr)
      table.append(tbody)
    else:
      tbody = etree.Element('tbody')
      tbody.set('class','fancy')
      for i in range(len(self.coldata)):
        tr = etree.Element('tr')
        tbody.append(tr)
        th = etree.Element('th')
        if self.coltitle[i] != None: th.text = str(self.coltitle[i])
        tr.append(th)
        if hassubhead:
          th1 = etree.Element('th')
          if self.colsubtitle[i] != None: th1.text = self.colsubtitle[i]
          tr.append(th1)
        for j in range(len(self.coldata[i])):
          td = etree.Element('td')
          td.text = str(self.coldata[i][j])
          tr.append(td)
      table.append(tbody)

    root = etree.Element('root')
    if self.help is None and self.download is None:
      root.append(table)
    else:
      
      #This is not working well
      div = etree.Element('div')
      div.set('id',self.id)
      root.append(div)
      div.append(table)
      if self.help is not None:
        div.append(self.help.as_etree())
      if self.download is not None:
        div.append(self.download.as_etree())
      '''
      tab = etree.Element('table')
      tab.append(etree.Element('tr'))
      tab.append(etree.Element('tr'))
      tab[0].append(etree.Element('td'))
      tab[0][0].set('colspan','2')
      tab[1].append(etree.Element('td'))
      tab[1].append(etree.Element('td'))
      tab[0][0].append(table)
      if self.help is not None:
        tab[1][0].append(self.help.as_etree())
      if self.download is not None:
        tab[1][1].append(self.download.as_etree())
      root.append(tab)
      '''
    return root


  def data_as_csv(self,fileName=None):
    import csv
    if len(self.coldata)==0: return CErrorReport()
    try:
       if sys.version_info > (3,0):
           f = open(fileName, 'w', newline='')
       else:
           f = open(fileName,'wb')
    except:
      return CErrorReport(Report,107,str(fileName))
    try:
      writer = csv.writer(f)
      if self.transpose:
        iRow=0
        for row in self.coldata:
            if len(self.coltitle)>0:
              if iRow < len(self.coltitle): outputRow = [self.coltitle[iRow]] + row
              else: outputRow = [" "] + row
            else: outputRow = row
            writer.writerow(outputRow)
            iRow += 1
      else:
        if len(self.coltitle)>0:
          writer.writerow(self.coltitle)
        nc = len(self.coldata)
        nr = len(self.coldata[0])
        for n in range(nr):
          row = []
          for col in self.coldata:
            row.append(col[n])
          writer.writerow(row)
    except:
      return CErrorReport(Report,107,str(fileName))
    try:
      f.close()
    except:
      return CErrorReport(Report,107,str(fileName))
    return CErrorReport()

  def data_as_xml(self,fileName=None):
    import csv
    if len(self.coldata)==0: return CErrorReport()
    try:
      f = open(fileName,'wb')
    except:
      return CErrorReport(Report,107,str(fileName))
    try:
      dataAsEtree = self.data_as_etree()
      #As it comes out here, the data tag is in ccp4 namespace (i.e. ccp4_data:data)
      rootNode = etree.Element('CCP4ApplicationOutput')
      for childTable in dataAsEtree:
          childTable.tag = 'CCP4Table'
          rootNode.append(childTable)
      dataAsText = etree.tostring(rootNode)
      f.write(dataAsText)
    except:
      print('Failed to select data')
      return CErrorReport(Report,107,str(fileName))
    try:
      f.close()
    except:
      return CErrorReport(Report,107,str(fileName))
    return CErrorReport()

# JavaScript-Enhances Table class
class Table(BaseTable):

  def __init__( self, xrtnode=None, xmlnode=None, jobInfo={}, **kw ):
    super(Table,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw )
    #self.internalId = kw.get("internalId", "tabletable_{0}_{1}".format(jobInfo.get('jobid','xxx'),BaseTable.tableCount))

  def as_data_etree(self):
    root = super().as_data_etree()
    root.set('transpose', 'True' if self.transpose else 'False')
    for child in self.data_as_etree().findall('.//table'):
      root.append(child)
    return root

  def as_etree(self):
    # check for subheads
    hassubhead = sum( [ x != None for x in self.colsubtitle ] ) > 0
    
    root = etree.Element('root')

    # deal with normal and transpose tables in turn
    if True:
      styleDict = {'height':'100%', 'width':'100%','margin':'0px','padding':'0px','display':'inline-block','margin-top':'1px'}
      styleStr = ';'.join([key + ':'+styleDict[key] for key in styleDict]) + ';'
      
      
      if self.outputXml:
          drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = self.data_url(), data_is_urls=True,renderer='CCP4i2Widgets.CCP4TableRenderer', require='CCP4i2Widgets', initiallyDrawn='True')
      else:
          drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = 'data_'+self.internalId, data_is_urls=False, renderer='CCP4i2Widgets.CCP4TableRenderer', require='CCP4i2Widgets', initiallyDrawn='True')
      root.append(self.data_as_etree())
      surroundingDiv = etree.SubElement(root,'div')
      surroundingDiv.append(drawnDiv.as_etree())
      surroundingDiv.set('id',self.id)

    if self.help is None and self.download is None:
      pass
    else:
      #This is not working well (<- *not* written by me SJM 05/12/2014)
      if self.help is not None:
        surroundingDiv.append(self.help.as_etree())
      if self.download is not None:
        surroundingDiv.append(self.download.as_etree())
    return root

  def data_as_etree(self,fileName=None):

    hassubhead = sum( [ x != None for x in self.colsubtitle ] ) > 0
    eleTree = etree.parse(StringIO('<script></script>'))
    ccp4_data = eleTree.getroot()
    ccp4_data.set('id','data_'+self.internalId)
    ccp4_data.set('type','application/xml')

    table = etree.Element('table')
    if not self.transpose:
      head = etree.Element('thead')
      table.append(head)
      headtr = etree.Element('tr')
      for i in range(len(self.coltitle)):
        if self.coltitle[i] != None:
          span = 1
          while i+span < len(self.coltitle):
            if self.coltitle[i+span] != None:
              break
            span += 1
          th =  etree.Element('th')
          if i >=0 and i<len(self.colTips) and self.colTips[i] is not None: th.set('title', self.colTips[i])
          th.text = self.coltitle[i] if self.coltitle[i] else ""
          if span > 1: th.set('colspan',str(span))
          headtr.append(th)
      head.append(headtr)
      tbody = etree.Element('tbody')
      if len(self.coldata) > 0:
        for i in range(len(self.coldata[0])):
          tr= etree.Element('tr')
          for col in self.coldata:
            td = etree.Element('td')
            if i >=0 and i<len(self.colTips) and self.colTips[i] is not None: td.set('title', self.colTips[i])
            td.text = str(col[i])
            tr.append(td)
          tbody.append(tr)
      table.append(tbody)
      if hasattr(self,"class_") and self.class_ is not None:
          table.set('class',self.class_)
    else:
      tbody = etree.Element('tbody')
      for i in range(len(self.coldata)):
        tr = etree.Element('tr')
        tbody.append(tr)
        th = etree.Element('th')
        if self.coltitle[i] != None: th.text = str(self.coltitle[i])
        if i >=0 and i<len(self.colTips) and self.colTips[i] is not None: th.set('title', self.colTips[i])
        tr.append(th)
        if hassubhead:
          th1 = etree.Element('th')
          if self.colsubtitle[i] != None: th1.text = self.colsubtitle[i]
          tr.append(th1)
        for j in range(len(self.coldata[i])):
          td = etree.Element('td')
          if i >=0 and i<len(self.colTips) and self.colTips[i] is not None: td.set('title', self.colTips[i])
          td.text = str(self.coldata[i][j])
          tr.append(td)
      table.append(tbody)
      if hasattr(self,"class_") and self.class_ is not None:
          table.set('class',self.class_+' transpose')
      else:
          table.set('class','transpose')

    ccp4_data.append(table)
      
    #print etree.tostring(ccp4_data,encoding='utf-8')
    return ccp4_data

class Div(Container):
  tag='div'
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
    super(Div,self).__init__( xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw )

class Progress(ReportClass):
    tag='progress'
    def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
        super(Progress,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw )
        self.value = 0
        self.label = kw.get('label','')
        self.outputXml = kw.get('outputXml', False)
        self.initiallyDrawn = kw.get('initiallyDrawn',True)
        if 'value' in kw: self.value = kw['value']
        self.max = 100
        if 'max' in kw: self.max = kw['max']
    
    def as_etree(self):
        #print '\n\n** In Progress.as_etree'
        # Tag as dummy so parent container will strip the tags
        styleDict = {'height':'50px', 'width':'250px','margin':'0px','padding':'0px','display':'inline-block','border':'1px solid black','margin-top':'0px'}
        if self.style is not None:
            styleBits = self.style.split(';')
            extraStyleDict = {}
            for styleBit in styleBits:
                stylePair = styleBit.split(':')
                if len(stylePair) == 2: extraStyleDict[stylePair[0].strip()] = stylePair[1].strip()
            styleDict.update(extraStyleDict)
        styleStr = ';'.join([key + ':'+styleDict[key] for key in styleDict]) + ';'
        
        root = etree.Element('div',style=styleStr)
        progressElement = etree.Element('progress', value=str(self.value), max=str(self.max), style=styleStr)
        if self.outputXml:
            drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = self.data_url(), data_is_urls=True, renderer='CCP4i2Widgets.CCP4i2HTMLChunk', require='CCP4i2Widgets', initiallyDrawn=str(self.initiallyDrawn))
        else:
            t = etree.tostring(progressElement)
            if hasattr(t,"decode"):
                t = t.decode()
            drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = t, data_is_urls=False, renderer='CCP4i2Widgets.CCP4i2HTMLChunk', require='CCP4i2Widgets', initiallyDrawn=str(self.initiallyDrawn))

            #print etree.tostring(drawnDiv.as_etree(), pretty_print=True)
        root.append(drawnDiv.as_etree())

        if self.style is not None: root.set("style",styleStr)
        #print 'Text.as_etree',root.text,root.tail
        return root
            
    def data_as_xml(self,fileName=None):
      dataAsEtree = etree.Element('span')
      dataAsEtree.text = self.label
      dataAsEtree.append(etree.Element('progress', value=str(self.value), max=str(self.max), style=self.style))
      rootNode = etree.Element('CCP4ApplicationOutput')
      rootNode.append(dataAsEtree)
      dataAsText = etree.tostring(rootNode)
      with open(fileName,'wb') as f:
        f.write(dataAsText)
      return CErrorReport()

class PictureGroup(Container):
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
    super(PictureGroup,self).__int__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
    self.help = None
    self.launch = None
    Container.__init__( self, xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw )

    
class GraphGroup(Container):
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
    super(GraphGroup,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw )
    self.help = None
    #print 'GraphGroup.__init__',self.children

    if kw.get('launcher',None) is not None:
      ele = etree.Element('launch')
      ele.set('label',kw['launcher'])
      ele.set('exe','loggraph')
      self.launch = Launch(ele,jobInfo=jobInfo)
    else:
      self.launch = None

    if xrtnode is not None:
      help = xrtnode.find(XRTNS+'help')
      if help is not None:
        self.help = Help(help,mode='graph')
        if xrtnode is not None: xrtnode.remove(help)
    elif 'help' in kw:
      self.help = Help(ref=kw['help'])

  def as_etree(self):
    root = etree.Element('root')
    
    # Beware children could include Loop or other non-Graph elements
    graphObjList = []
    for child in self.children:
      if isinstance(child,Graph):
        #child.launch = None
        child.help = None
        graphObjList.append(child)
      
      elif isinstance(child,(Container,Loop)):
        #print 'GraphGroup.as_etree grandChildren',child,child.children
        for grandChild in child.children:
          if isinstance(grandChild,Graph):
            graphObjList.append(grandChild)
    #print 'GraphGroup.as_etree graphObjList',graphObjList
    if len(graphObjList)==0: return root

    if self.launch is None:
      loggraphObj = etree.Element('object')
      loggraphObj.set('type','x-ccp4-widget/LogGraph')
      loggraphObj.set('class','loggraph')
      if self.style is not None:
        loggraphObj.set('style',self.style)
      if graphObjList[0].id is not None:
        loggraphObj.set('id',graphObjList[0].id)
      root.append(loggraphObj)
      
    for graphObj in graphObjList:
      #print '    ',graphObj.title     
      param = etree.Element('param')
      param.set('name','ccp4_data_id')
      param.set('value','data_'+graphObj.internalId)
      if self.launch is None:
        loggraphObj.append(param)
      else:
        self.launch.appendDataId('data_'+graphObj.id)

      root.append(graphObj.data_as_etree())
    
    #if self.help is not None or self.launch is not None:
    if self.help is not None:
      h = self.help.as_etree()
      if h.tag == 'root':
        root.extend(h)
      else:
        root.append(h)    
    
  
    return root

class FlotGraphGroup(Container):
    def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
        super(FlotGraphGroup,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
        self.help = None
        self.launch = None
        self.launchOnly = False
        #print 'GraphGroup.__init__',self.children
        
        self.launch = None
        ele = etree.Element('launch')
        if kw.get('launcher',None) is not None:
            self.launchOnly = True
            ele.set('label',kw['launcher'])
            ele.set('exe','loggraph')
            if kw.get('withLaunch',True):
              self.launch = Launch(ele,jobInfo=jobInfo)
 
        if xrtnode is not None:
            help = xrtnode.find(XRTNS+'help')
            if help is not None:
                self.help = Help(help,mode='graph')
                if xrtnode is not None: xrtnode.remove(help)
        elif 'help' in kw:
            self.help = Help(ref=kw['help'])
    
    
    def as_etree(self):
        root = etree.Element('root')
        
        # Beware children could include Loop or other non-Graph elements
        graphObjList = []
        for child in self.children:
            if isinstance(child,FlotGraph):
                #child.launch = None
                child.help = None
                graphObjList.append(child)
            
            elif isinstance(child,(Container,Loop)):
                #print 'GraphGroup.as_etree grandChildren',child,child.children
                for grandChild in child.children:
                    if isinstance(grandChild,FlotGraph):
                        graphObjList.append(grandChild)
        #print 'GraphGroup.as_etree graphObjList',graphObjList
        if len(graphObjList)==0: return root
            
        dataList = ",".join(['data_'+graphObj.internalId for graphObj in graphObjList])
        for graphObj in graphObjList:
            #print '    ',graphObj.title
            if self.launch is not None:
                param = etree.Element('param')
                param.set('name','ccp4_data_id')
                param.set('value','data_'+graphObj.internalId)
                self.launch.appendDataId('data_'+graphObj.id)
            root.append(graphObj.data_as_etree())
            
        
        styleDict = {'height':'250px', 'width':'250px','margin':'0px','padding':'0px','display':'inline-block','border':'1px solid black','margin-top':'1px'}
        if self.style is not None:
            styleBits = self.style.split(';')
            extraStyleDict = {}
            for styleBit in styleBits:
                stylePair = styleBit.split(':')
                if len(stylePair) == 2: extraStyleDict[stylePair[0].strip()] = stylePair[1].strip()
            styleDict.update(extraStyleDict)
        styleStr = ';'.join([key + ':'+styleDict[key] for key in styleDict]) + ';'
        
        launchButtonLocation = root
        if not self.launchOnly:
            surroundingDiv = etree.SubElement(root,'div',style=styleStr)
            launchButtonLocation = surroundingDiv
            #Here I shring the Flot Div if I am going to append a launch button
            if self.launch is not None:
                heightPx = int(styleDict['height'][:-2])
                heightPx -= 30;
                styleDict['height'] = str(heightPx) + 'px'
            if 'border-width' in styleDict: del styleDict['border-width']
            if 'border-style' in styleDict: del styleDict['border-style']
            if 'border-color' in styleDict: del styleDict['border-color']
            styleDict['margin-top'] = '0px'
            styleDict['margin'] = '0px'
            styleDict['padding'] = '0px'
            styleDict['border'] = '0px solid white'
            
            styleStr = ';'.join([key + ':'+styleDict[key] for key in styleDict]) + ';'
            drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = dataList, renderer='CCP4i2Widgets.CCP4FlotRenderer', require='CCP4i2Widgets', initiallyDrawn='True')
            #print etree.tostring(drawnDiv.as_etree(), pretty_print=True)
            surroundingDiv.append(drawnDiv.as_etree())

        if self.launch:
            l = self.launch.as_etree()
            if l.tag == 'root':
                launchButtonLocation.extend(l)
            else:
                launchButtonLocation.append(l)

        #if self.help is not None or self.launch is not None:
        if self.help is not None:
            h = self.help.as_etree()
            if h.tag == 'root':
                root.extend(h)
            else:
                root.append(h)    
        
        
        return root
    
    def data_as_xmls(self,fileRoot=None):
        # Beware children could include Loop or other non-Graph elements
        graphObjList = []
        for child in self.children:
            if isinstance(child,FlotGraph):
                graphObjList.append(child)

class DrawnDiv(Container):
    drawnDivCount=0
    def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
        super(DrawnDiv,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
        self.help = None
        DrawnDiv.drawnDivCount += 1
        self.id = kw.get('id','drawnDiv_'+str(DrawnDiv.drawnDivCount))
        self.data_is_urls = kw.get('data_is_urls',False)
        
        if xrtnode is not None:
            help = xrtnode.find(XRTNS+'help')
            if help is not None:
                self.help = Help(help,mode='gallery')
                if xrtnode is not None: xrtnode.remove(help)
        elif 'help' in kw:
            self.help = Help(ref=kw['help'])
        
        self.height = kw.get('height', '250px')
        self.width = kw.get('width', '250px')
        self.style = kw.get('style', 'margin:0px;padding:0px;display:inline-block;') + 'height:'+self.height+';width:'+self.width+';'
        self.data_data = kw.get('data', 'None')
        self.data_renderer = kw.get('renderer', 'None')
        self.data_require = kw.get('require', 'None')
        self.data_initially_drawn = kw.get('initiallyDrawn', False)
        
    def as_etree(self):
        rootDiv = etree.Element('div')
        rootDiv.set('style',self.style)
        try:
          from core import CCP4Modules
          preferences = CCP4Modules.PREFERENCES()
          rootDiv.set('data-app-font-size',str(preferences.GUI_FONT_SIZE)+'px')
        except:
          pass
        rootDiv.set('data-data',self.data_data)
        rootDiv.set('data-renderer',self.data_renderer)
        rootDiv.set('data-height',self.height)
        rootDiv.set('data-width',self.width)
        rootDiv.set('data-widget-type','CCP4i2DrawnDiv')
        rootDiv.set('data-is-urls',str(self.data_is_urls))
        rootDiv.set('id', self.id)

        if self.data_require is not None: rootDiv.set('data-require',self.data_require)
        rootDiv.set('data-initially-drawn',str(self.data_initially_drawn))
        rootDiv.text=''
        return rootDiv

class ObjectGallery(Container):
    galleryCount = 0
    def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
        super(ObjectGallery,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
        self.help = None
        ObjectGallery.galleryCount += 1
        self.id = kw.get('id','gallery_'+str(ObjectGallery.galleryCount))
       
        if xrtnode is not None:
            help = xrtnode.find(XRTNS+'help')
            if help is not None:
                self.help = Help(help,mode='gallery')
                if xrtnode is not None: xrtnode.remove(help)
        elif 'help' in kw:
            self.help = Help(ref=kw['help'])

        self.tableWidth = kw.get('tableWidth', '7em')
        self.contentWidth = kw.get('contentWidth', '250px')
        self.height = kw.get('height', '250px')
        self.style = kw.get('style', 'padding:0px;overflow:auto;display:inline-block;margin:1px;')
        
    def as_etree(self):
        rootElement = etree.Element('root')
        rootDiv = etree.SubElement(rootElement, 'div', style=self.style)
        rootDiv.set('class','ObjectGallery')
        listDiv = etree.SubElement(rootDiv, 'div', style='width:'+self.tableWidth+';height:'+self.height+';overflow:auto;float:left;margin:0px;')
        contentDiv = etree.SubElement(rootDiv, 'div', style = 'width:'+self.contentWidth+';height:'+self.height+';overflow:auto;padding:0px;border-width:0px;margin:0px;float:left;' )

        tableElement = etree.SubElement(listDiv,'table',style='width:'+self.tableWidth+';')
        bodyElement = etree.SubElement(tableElement,'tbody')
        bodyElement.set('class','fancy')
        for iChild, child in enumerate(self.children):
            #Make an entry for each child in the list
            rowElement = etree.SubElement(bodyElement,'tr')

            cellElement = etree.SubElement(rowElement,'td',onclick='galleryListObjClicked(this)')
            cellElement.set('value',self.id+'_item_'+str(iChild))
            
            if iChild == 0: cellElement.set('class','galleryListObj Selected')
            else: cellElement.set('class','galleryListObj NotSelected')
            
            cellElement.text = 'Item '+str(iChild)
            if hasattr(child,'title') and child.title: cellElement.text = child.title
            if hasattr(child,'label') and child.label: cellElement.text = child.label
            
            #and make a Div for each child of the contentDiv
            correspondingDiv = etree.SubElement(contentDiv,'div',style = 'width:'+self.contentWidth+';height:'+self.height+';padding:0px;margin:0px;overflow:auto;',id=self.id+'_item_'+str(iChild)+'_div')

            if iChild == 0: correspondingDiv.set('class','galleryDivObj displayed')
            
            else: correspondingDiv.set('class','galleryDivObj hidden')

            correspondingDiv.append(child.as_etree())

        return rootElement

class GraphLineChooser(Container):
    graphLineChooserCount = 0
    def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
        super(GraphLineChooser,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
        self.help = None
        GraphLineChooser.graphLineChooserCount += 1
        self.id = kw.get('id','graphLineChooser_'+str(GraphLineChooser.graphLineChooserCount))
        
        if xrtnode is not None:
            help = xrtnode.find(XRTNS+'help')
            if help is not None:
                self.help = Help(help,mode='gallery')
                if xrtnode is not None: xrtnode.remove(help)
        elif 'help' in kw:
            self.help = Help(ref=kw['help'])
        
        self.height = kw.get('height', '250px')
        self.tableWidth = kw.get('tableWidth', '200px')
        self.contentWidth = kw.get('contentWidth', '200px')
        if 'px' in self.tableWidth and 'px' in self.contentWidth:
            totalWidth = str(int(self.tableWidth[:-2]) + int(self.contentWidth[:-2]))+'px'
        self.style = kw.get('style', 'margin:0px;padding:0px;display:inline-block;') + 'height:'+self.height+'; width:'+totalWidth+';'

    def as_etree(self):
        rootDiv = etree.Element('div', style=self.style, id=self.id)
        rootDiv.set('data-widget-type','CCP4i2LineChooser')
        rootDiv.set('data-table-width', self.tableWidth)
        rootDiv.set('data-content-width', self.contentWidth)
        rootDiv.set('data-height', self.height)
        self.children[0].makeTableText()
        rootDiv.set('data-data',etree.tostring(self.children[0].data_as_etree()))
        return rootDiv

# Graph class
class Graph(ReportClass):

  tableCount = 0
  ERROR_CODES = { 1 : { 'description' : 'Plot definition text unreadable. Maybe invalid XML?' },
                  2 : { 'description' : 'Plot definition file unreadable. Maybe invalid XML?' },
                  3 : { 'description' : 'Unable to create RTF file - unable to import PyQt4 ' } }

  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {}, **kw ):
    super(Graph,self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
    self.id = kw.get('id','graph_'+str(BaseTable.tableCount))
    #self.internalId = kw.get("internalId","table_{0}_{1}".format(jobInfo.get('jobid','xxx'),BaseTable.tableCount))
    BaseTable.tableCount += 1
    self.coldata = []
    self.coltitle = []
    self.plots = []
    self.title = None
    self.tableText = ''
    self.headerText = ''
    self.launch = None
    self.headerSeparator = None
    self.pimpleData = None
    self.outputCsv =  kw.get('outputCsv',True)

    # Find title
    if xrtnode is not None:
      if xrtnode.find(XRTNS+'title') is not None:
        #print 'Graph.__init__',xrtnode.find(XRTNS+'title'),xrtnode.find(XRTNS+'title').get('select')
        if xrtnode.find(XRTNS+'title').get('select') is not None and xmlnode is not None:
          xmlEleList = xmlnode.findall(xrtnode.find(XRTNS+'title').get('select'))
          #print 'Graph.__init__ xmlEleList',xmlEleList
          if len(xmlEleList)>0:
            if isinstance(xmlEleList[0],str):
              self.title = xmlEleList[0]
            else:
              self.title = xmlEleList[0].text
          else:
            self.title = None
        else:
          self.title = xrtnode.find('title').text
      else:
        self.title = xrtnode.get('title',None)
    elif 'title' in kw:
      self.title = kw['title']
      
    if kw.get('launcher',None) is not None:
      ele = etree.Element('launch')
      ele.set('label',kw.get('launcher','More graphs'))
      ele.set('exe','loggraph')
      self.launch = Launch(ele,jobInfo=jobInfo,ccp4_data_id='data_'+self.internalId)
    

    if xrtnode is not None:
      help = xrtnode.find(XRTNS+'help')
    else:
      help = kw.get('help',None)
    if help is not None:
      self.help = Help(help,mode='graph')
    else:
      self.help = None

    if xrtnode is not None:
      if  xrtnode.get( "select" ) is not None and xmlnode is not None:
        # Make list of selectd xml nodes
        self.xmldata = xmlnode.findall( xrtnode.get( "select" ) )
    elif 'select' in kw and xmlnode is not None:
       self.xmldata = []
       for p in kw['select'].split("|"):
           self.xmldata.extend(xmlnode.findall(p.strip()))
    elif 'selectNodes' in kw and xmlnode is not None:
       self.xmldata = kw['selectNodes']
    else:
      # or put current xml node in a list
      self.xmldata = []
      if xmlnode is not None: self.xmldata.append( xmlnode )
      
   # assemble column data
    if xrtnode is not None:
      for node in xrtnode:
        if node.tag == XRTNS+"data":       
          self.addData(xmldata=self.xmldata,title=node.get('title'),select=node.get('select'),expr=node.get('expr'))
       # Handle table as a block in the xml file
        elif node.tag == XRTNS+"table":
          self.addTable(xmldata=self.xmldata,select=node.get('select'),headers=node.find( XRTNS+'headers'))


    # get plot definitions
    if xrtnode is not None:
      for node in xrtnode:
        if node.tag == XRTNS+"plot":
          self.addPlot(xrtnode=node,xmlnode=xmlnode,select=node.get('select'))

  def addPimpleData(self,xmlnode=None,select=None,usePlotly=False):
    if xmlnode is None: xmlnode = self.xmlnode
    if select is not None: xmlnode=xmlnode.findall0(select)
    self.pimpleData = etree.Element('pimple_data')
    if usePlotly: self.pimpleData.set('usePlotly','True')
    from copy import deepcopy
    for key in ['headers','data','plot']:
      eleList = xmlnode.findall(key)
      for ele in eleList:
        #print('addPimpleData',key,ele.get('id'))
        self.pimpleData.append(deepcopy(ele))
    for attr in list(xmlnode.attrib.keys()):
      #print('addPimpleData',attr,xmlnode.get(attr))
      self.pimpleData.set(attr,xmlnode.get(attr))
    
  def addData(self,xmldata=None,title=None,select=None,expr=None,data=[]):  
    colvals = []
    if len(data)>0:
      colvals.extend(data)
    elif select:
      if xmldata is None: xmldata = self.xmldata
      for x in xmldata:
        selectedList = x.findall(select)
        for selitem in selectedList:
          if selitem.text is None:
            val = '-'
          else:
            val = selitem.text.strip()
            if expr is not None:  # allow an expression to be applied to the data
              try:
                val = eval( expr, {"x":float(val)} )
              except:
                val = '-'
          colvals.append(val)
    self.coldata.append(colvals)
    self.coltitle.append(title)
        
  def addTable(self,xmlnode=None,**kw):
    if xmlnode is None:
      if len(self.xmldata)>0:
        xmlnode = self.xmldata[0]
      else:
        return
    if kw.get('select',None) is not None and xmlnode is not None:
      tableEleList = xmlnode.findall(kw['select'])
      if len(tableEleList)>0: self.tableText = tableEleList[0].text
    
    if kw.get('headers',None) is not None and xmlnode is not None:
      headersEleList = xmlnode.findall(kw['headers'])
      #print 'Graph.addTable headersEleList',headersEleList
      if len(headersEleList)>0:
         self.headerText = headersEleList[0].text
         self.headerSeparator = headersEleList[0].get('separator',None)
         
  def addPlot(self,xrtnode=None,xmlnode=None,**kw):
    if xmlnode is None:
      if len(self.xmldata)>0: xmlnode = self.xmldata[0]   
    if xrtnode is None:
      #try:
      if kw.get('plotFile',None):
        from core import CCP4Utils
        try:
          text = CCP4Utils.readFile(kw['plotFile'])
          import re
          #text = re.sub('<xrt:','<'+XRTNS,text)
          #text = re.sub('</xrt:','</'+XRTNS,text)
          text = re.sub('<xrt:','<',text)
          text = re.sub('</xrt:','</',text)
          #print 'addPlot plot',text
          xrtnode = etree.fromstring(text)
        except:
          raise CException(self.__class__,1,str(kw['plotFile']))
      if kw.get('plot',None) is not None:
        print(kw['plot'])
        import re
        #text = re.sub('<xrt:','<'+XRTNS,kw['plot'])
        #text = re.sub('</xrt:','</'+XRTNS,text)
        if sys.version_info > (3,0) and hasattr(kw['plot'],"decode"):
            text = re.sub('<xrt:','<',kw['plot'].decode())
        else:
            text = re.sub('<xrt:','<',kw['plot'])
        text = re.sub('</xrt:','</',text)
        xrtnode = etree.fromstring(text)
      #except:
      #  raise CException(self.__class__,1,str(text))

    if xrtnode is not None and kw.get('select',None) is None:
      # Just copy plot directives from xrt - substitute infor any 'select' attribute
      xrtnode.tag = 'plot'
      xrtnode = applySelect(xrtnode,xmlnode)
      self.plots.append( xrtnode )
    elif xmlnode is not None and kw.get('select',None) is not None:
      # Copy plot directives from xml
      plotEleList = xmlnode.findall(kw['select'])
      for plotEle in plotEleList:
        plotEle.tag = 'plot'
        self.plots.append( plotEle )

  def addPlotObject(self):
    plot = Plot()
    self.plots.append(plot)
    return plot


  def makeTableText(self):
    # pad data arrays to a uniform length   
    if len(self.coldata)>0:
      maxlen = max( [ len(data) for data in self.coldata ] )
      for i in range(len(self.coldata)):
        while len(self.coldata[i]) < maxlen:
          self.coldata[i].append(None)     
      # Convert to single text block
      text = ''
      for i in range(len(self.coldata[0])):
        for col in self.coldata:
          if col[i] is None:
            text += '- '
          else:
           text += str(col[i]) + ' '
        text += "\n"
      self.tableText = text
      # Headers to single text block
      for head in self.coltitle: self.headerText += head + ' '
    self.coldata = []
    self.coltitle = []
 
  def as_html( self ):
    s = "<object type='x-ccp4-widget/LogGraph' id='{0}'><param name='ccp4_data_id' value = 'data_{0}'/></object>\n<ccp4_data id='data_{0}' title='{1}' style='display:none;'>\n".format(self.id,self.title)
    s += "<headers>\n"
    for head in self.coltitle:
      s += head + " "
    s += "\n</headers>\n<data>\n"
    for i in range(len(self.coldata[0])):
      for col in self.coldata:
        s += "{0} ".format(col[i])
      s += "\n"
    s += "</data>\n"
    for plot in self.plots:
      s += "<plot "
      for attr in plot:
        s += "{0}='{1}' ".format(attr[0],attr[1])
      s += "/>\n"
    s += "</ccp4_data>\n"
    return s

  def as_etree(self):

    self.makeTableText()
    root = etree.Element('root')

    if not self.launch:
      obj = etree.Element('object')
      obj.set('type','x-ccp4-widget/LogGraph')
      if self.class_ is not None:
        obj.set('class',self.class_)
      else:
        obj.set('class','loggraph')
      if self.id is not None: obj.set('id',self.id)
      if self.style is not None: obj.set('style',self.style)
      root.append(obj)
      param = etree.Element('param')
      param.set('name','ccp4_data_id')
      param.set('value','data_'+self.internalId)
      obj.append(param)
    else:
      l = self.launch.as_etree()
      if l.tag == 'root':
        root.extend(l)
      else:
        root.append(l)     
    

    root.append(self.data_as_etree())
    
    #if self.help is not None or self.launch is not None:
    if self.help is not None:
      h = self.help.as_etree()
      if h.tag == 'root':
        root.extend(h)
      else:
        root.append(h)

    return root

  def data_as_etree(self):
    eleTree = etree.parse(StringIO('<ccp4:ccp4_data xmlns:ccp4="'+CCP4NS+'"></ccp4:ccp4_data>'))
    ccp4_data = eleTree.getroot()
    if self.title is not None: ccp4_data.set('title',self.title)
    #ccp4_data = etree.Element('ccp4_data')
    ccp4_data.set('id','data_'+self.internalId)
    ccp4_data.set('style','display:none;')

    if self.pimpleData is not None:
      import copy
      #print 'Graph.data_as_etree',self.pimpleData,len(self.pimpleData),self.pimpleData.get('title')
      for item in self.pimpleData:
        ccp4_data.append(copy.deepcopy(item))
      if self.pimpleData.get('title') is not None: ccp4_data.set('title',self.pimpleData.get('title'))
      if self.pimpleData.get('usePlotly') is not None: ccp4_data.set('usePlotly',self.pimpleData.get('usePlotly'))
    else:
      header = etree.Element('headers')
      header.text = self.headerText
      if self.headerSeparator is not None: header.set('separator',self.headerSeparator)
      ccp4_data.append(header)

      data = etree.Element('data')
      data.text = self.tableText
      ccp4_data.append(data)

      #print 'data_as_etree',self.plots
      for plot in self.plots:
        if isinstance(plot,Plot):
          ccp4_data.append(plot.as_etree())
        else:
         ccp4_data.append(plot)

    return ccp4_data

  def getListOfRows(self):
    rowdatalist = []
    if len(self.coldata)>0:
      rowdatalist = self.coldata
    elif len(self.tableText)>0:
      for row in self.tableText.split('\n'):
        rowdata = []
        for item in row.split(): rowdata.append(item)
        if len(rowdata)>0: rowdatalist.append(rowdata)
    elif self.pimpleData is not None:    
      dataEleList = self.pimpleData.findall('./data')
      #print 'Graph.getListOfRows dataEleList',dataEleList
      if len(dataEleList)>0:
        for row in dataEleList[0].text.split('\n'):
          rowdata = []
          for item in row.split(): rowdata.append(item)
          if len(rowdata)>0: rowdatalist.append(rowdata)
      # Do we have some column headers - should be space separated words
      headerEleList = self.pimpleData.findall('./headers')
      if len(headerEleList)>0:
        separator = headerEleList[0].get('separator',' ')
        headerList = headerEleList[0].text.split(separator)
        if len(rowdatalist)>0 and len(rowdatalist[0])==len(headerList):
          rowdatalist.insert(0,headerList)      
    return rowdatalist
      

  def data_as_rtf(self,document=None):
    try:
      from PySide2 import QtGui, QtWidgets
    except:
      raise CException(self.__class__,3)

    # Is there some table data to output
    #print 'data_as_rtf coldata',len(self.coldata),'tableText',self.tableText    
    if document is None:
      document = QtGui.QTextDocument()
    cursor = QtGui.QTextCursor(document)
    table = cursor.insertTable(len(coldata),len(coldata[0]))
    #print 'data_as_rtf columns,rows',table.rows(),table.columns(),'should be',len(coldata),len(coldata[0])
    coldata = self.getListOfRows()
    ir = -1
    for col in coldata:
      ir += 1
      ic = -1
      for item in col:
        ic += 1
        #print 'data_as_rtf ir,ic,item',ir,ic,item
        cell = table.cellAt(ir,ic)
        cell.firstCursorPosition().insertText(str(item))
    return table

  def data_as_csv(self,fileName=None):
    rowList = self.getListOfRows()
    if len(rowList)==0: return CErrorReport(Report,107,fileName)
    import csv
    try:
      f = open(fileName,'wb')
    except:
      return CErrorReport(Report,107,fileName)
    try:
      writer = csv.writer(f)
      if len(self.coltitle)>0:
        writer.writerow(self.coltitle)
      for row in rowList: writer.writerow(row)
    except Exception as e:
      return CErrorReport(Report,107,fileName)
    try:
      f.close()
    except:
      return CErrorReport(Report,107,fileName)
    
    return CErrorReport()

  def data_as_xml(self,fileName=None):
    rowList = self.getListOfRows()
    if len(rowList)==0: return CErrorReport(Report,108,fileName)
    try:
      f = open(fileName,'wb')
    except:
      return CErrorReport(Report,108,fileName)
    try:
      dataAsEtree = self.data_as_etree()
      #As it comes out here, the data tag is in ccp4 namespace (i.e. ccp4_data:data)
      dataAsEtree.tag = 'CCP4Table'
      rootNode = etree.Element('CCP4ApplicationOutput')
      rootNode.append(dataAsEtree)
      dataAsText = etree.tostring(rootNode)
      f.write(dataAsText)
    except Exception as e:
      return CErrorReport(Report,108,fileName)
    try:
      f.close()
    except:
      return CErrorReport(Report,108,fileName)
    
    return CErrorReport()

# Graph class
class FlotGraph(Graph):

    def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {}, **kw ):
        super(FlotGraph, self).__init__(xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw)
        self.initiallyDrawn = kw.get('initiallyDrawn',True)
        
        #if kw.get('launcher',None) is not None:
        self.launch = None
        self.launchOnly = False
        self.flot_id = kw.get ( 'internalId', None )
        ele = etree.Element('launch')
        if  kw.get('launcher',None) is not None:
          self.launchOnly = True
          ele.set('label',kw.get('launcher','More graphs'))
          ele.set('exe','loggraph')
          if kw.get('withLaunch',True):
            self.launch = Launch(ele,jobInfo=jobInfo,ccp4_data_id='data_'+self.internalId)

    def as_etree(self):
        self.makeTableText()
        root = etree.Element('root')
        
        styleDict = {'height':'250px', 'width':'250px','margin':'0px','padding':'0px','display':'inline-block','border':'1px solid black','margin-top':'1px'}
        if self.style is not None:
            styleBits = self.style.split(';')
            extraStyleDict = {}
            for styleBit in styleBits:
                stylePair = styleBit.split(':')
                if len(stylePair) == 2: extraStyleDict[stylePair[0].strip()] = stylePair[1].strip()
            styleDict.update(extraStyleDict)
        styleStr = ';'.join([key + ':'+styleDict[key] for key in styleDict]) + ';'
        launchButtonLocation = root
        if not self.launchOnly:
            surroundingDiv = etree.SubElement(root,'div',style=styleStr)
            launchButtonLocation = surroundingDiv
            #Here I shring the Flot Div if I am going to append a launch button
            if self.launch is not None:
                heightPx = int(styleDict['height'][:-2])
                heightPx -= 30;
                styleDict['height'] = str(heightPx) + 'px'
            if 'border-width' in styleDict: del styleDict['border-width']
            if 'border-style' in styleDict: del styleDict['border-style']
            if 'border-color' in styleDict: del styleDict['border-color']
            styleDict['margin-top'] = '0px'
            styleDict['margin'] = '0px'
            styleDict['padding'] = '0px'
            styleDict['border'] = '0px solid white'
            
            styleStr = ';'.join([key + ':'+styleDict[key] for key in styleDict]) + ';'
            
            if self.flot_id :
            
                if self.outputXml:
                    drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = self.data_url(), data_is_urls=True, renderer='CCP4i2Widgets.CCP4FlotRenderer', require='CCP4i2Widgets', initiallyDrawn=str(self.initiallyDrawn), id=self.flot_id )
                else:
                    drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = self.data_id(), data_is_urls=False, renderer='CCP4i2Widgets.CCP4FlotRenderer', require='CCP4i2Widgets', initiallyDrawn=str(self.initiallyDrawn), id=self.flot_id )
            else :

                if self.outputXml:
                    drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = self.data_url(), data_is_urls=True, renderer='CCP4i2Widgets.CCP4FlotRenderer', require='CCP4i2Widgets', initiallyDrawn=str(self.initiallyDrawn))
                else:
                    drawnDiv = DrawnDiv(style = styleStr, height=styleDict['height'], width=styleDict['width'], data = self.data_id(), data_is_urls=False, renderer='CCP4i2Widgets.CCP4FlotRenderer', require='CCP4i2Widgets', initiallyDrawn=str(self.initiallyDrawn))
            

            #print etree.tostring(drawnDiv.as_etree(), pretty_print=True)
            surroundingDiv.append(drawnDiv.as_etree())
        if self.launch is not None:
            l = self.launch.as_etree()
            if l.tag == 'root':
                launchButtonLocation.extend(l)
            else:
                launchButtonLocation.append(l)
        
        if not self.outputXml: root.append(self.data_as_etree())

        #if self.help is not None or self.launch is not None:
        if self.help is not None:
            h = self.help.as_etree()
            if h.tag == 'root':
                root.extend(h)
            else:
                root.append(h)
        
        
        return root

    def as_data_etree(self):
      self.makeTableText()
      root = super().as_data_etree()
      root.append(self.data_as_etree())
      return root

    
    
class GenericElement(ReportClass):
  def __init__(self,tag=None,text=None,**kw):
    super().__init__()
    self.tag = tag
    self.id = kw.get('id',None)
    self.class_ = kw.get('class_',None)
    self.text = text
    self.attributes = kw
    self.children = []
    #print 'GenericElement.init', self.tag , self.text

  def append(self,name,text=None,**kw):
    if isinstance(name,GenericElement):
      self.children.append(name)
    else:
      self.children.append(GenericElement(name,text,**kw))
    return self.children[-1]

  def set(self,key,value):
    self.attributes[key] = value

  def as_data_etree(self):
    root = super().as_data_etree()
    root.append(self.as_etree())
    return root

  def as_etree(self):
    #print 'GenericElement.as_etree',self.tag,self.text,self.attributes
    ele = etree.Element(self.tag)
    if self.id is not None: ele.set('id',self.id)
    if self.class_ is not None: ele.set('class',self.class_)
    if self.text is not None: ele.text = self.text
    for key,value in list(self.attributes.items()):
      ele.set(key,str(value).strip())
    for obj in self.children:
      ele.append(obj.as_etree())
    return ele
 

def parse_from_unicode(unicode_str):
    from lxml import etree as lxml_etree
    utf8_parser = lxml_etree.XMLParser(encoding='utf-8')
    s = unicode_str.encode('utf-8')
    return lxml_etree.fromstring(s, parser=utf8_parser)

class Plot(GenericElement):

  ERROR_CODES = { 101 : { 'severity': SEVERITY_WARNING , 'description' : 'Failed loading Plot schema' },
                  102 : {  'description' : 'Failed validation' },
                  }

  def __init__(self,text=None,**kw):
    GenericElement.__init__(self,tag='plot',text=text,**kw)

  def validate(self):
    from core import CCP4Utils
    import os
    from lxml import etree as lxml_etree
    try:
      schemafile = os.path.join(CCP4Utils.getCCP4I2Dir(),'pimple','CCP4ApplicationOutput.xsd')
      schematree = parse_from_unicode(open(schemafile).read())
      schema = lxml_etree.XMLSchema(schematree)
    except:
      raise
      return CErrorReport(self.__class__,101,schemafile)

    print("SCHEMA",schema)

    tree = self.as_etree()
    
    table = etree.Element('CCP4Table')
    table.append(tree)
    output = etree.Element('CCP4ApplicationOutput')
    output.append(table)
    valid = schema.validate(lxml_etree.fromstring(etree.tostring(output)))
    if not valid:
      log = str(schema.error_log)
      #print 'validate log',log
      err = CErrorReport()
      err.append(self.__class__,102,log)
      return err
    else:
      return CErrorReport()
    
  def as_etree(self):
    tree = GenericElement.as_etree(self)
    return tree
    
    
class IODataList(ReportClass):
  OBJ_WIDTH = '600'
  OBJ_HEIGHT = '30'

  def __init__(self, xrtnode=None, xmlnode=None, jobInfo = {}, **kw):
    #print 'IODataList.__init__',xrtnode, xmlnode
    super().__init__()
    self.jobInfo = {}
    self.jobInfo.update(jobInfo)
  

  def as_etree0(self,role=None):

    import json
    import collections

    root = etree.Element('div')
    root.set('class','datalist')

    if role not in self.jobInfo: return root
 
    for fileInfo in self.jobInfo[role]:
      
      print(fileInfo)

      outerDiv = etree.Element('div')
      outerDiv.set('class','dataline')
      obj = etree.Element('div')
      obj.set('class','alignright')

      obj.set('type','x-ccp4-widget/C'+fileInfo['filetypeclass'])
      obj.set('id','input_file_'+str(fileInfo['fileId']))

      params = {}
      for key1,key2 in [['filename','baseName'],['relpath','relPath'],['projectid','project']]:
          if fileInfo.get(key1,None) is not None:
              params[key2] = str(fileInfo[key1])

      params['dbFileId'] = str(fileInfo['fileId'])
      params['filetypeclass'] = str(fileInfo['filetypeclass'])

      if fileInfo['annotation'] is None:
          if not fileInfo['filetypeclass']:
              obj.text = fileInfo['jobparamname']
          else:
              obj.text = fileInfo['filetypeclass']
      else:
          obj.text = str(fileInfo['annotation'])

      print(params)
      """
#TODO - Quite a lot!
PhaserRFileDataFile
AsuDataFile
PhaserSolDataFile
MapDataFile
CootHistoryDataFile
SeqAlignDataFile
SeqDataFile
MTZDataFile
DictDataFile
EnsemblePdbDataFile
RefmacKeywordFile
SceneDataFile
      """

      if True and "project" in params and "relPath" in params and "baseName" in params:

          projectDir = PROJECTSMANAGER().db().getProjectInfo(projectId=params['project'],mode='projectdirectory')
          filePath = os.path.join(projectDir,params['relPath'],params['baseName'])

          launchImage = etree.Element('img')
          launchImage.set('class','alignleft')
          if fileInfo['filetypeclass'] in PNGCACHE:
              launchImage.set('src',PNGCACHE[fileInfo['filetypeclass']])
          else:
              launchImage.set('src',PNGCACHE['DataFile'])
          launchImage.set('width',str(int(IODataList.OBJ_HEIGHT)-2))
          launchImage.set('height',str(int(IODataList.OBJ_HEIGHT)-2))
          launchImage.set('draggable',"true")
          launchImage.set('id',params['dbFileId'])
          launchImage.set('filepath',filePath)
          outerDiv.append(launchImage)
          menu = etree.Element('ul')
          menu.set('class','menu')
          menu.set('id',"menu"+params['dbFileId'])
          outerDiv.append(menu)
          menuparams = {}
          if fileInfo['filetypeclass'] == "PdbDataFile":
              menuparams = collections.OrderedDict([('quick_view',"Quick view"),('view_text',"View as text"),('view_CCP4mg',"View in CCP4MG"),('view_Coot',"View in Coot"),('view_PdbView',"View in PdbView"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "AsuContentSeqList":
              menuparams = collections.OrderedDict([('view_text',"View as text"),('export','Export sequence(s)'),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "AsuContentSeq":
              menuparams = collections.OrderedDict([('view_text',"View as text"),('export','Export sequence(s)'),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "SeqDataFile":
              menuparams = collections.OrderedDict([('view_text',"View as text"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "ImportUnmerged":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "MiniMtzDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "MergeMiniMtz":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "GenericReflDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "ObsDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "PhsDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "FreeRDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "MtzDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "UnmergedDataFile":
              menuparams = collections.OrderedDict([('view_ViewHKL',"View in ViewHKL"),("export","Export"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "MapCoeffsDataFile":
              menuparams = collections.OrderedDict([('view_CCP4mg',"View in CCP4MG"),('view_Coot',"View in Coot"),('view_ViewHKL',"View in ViewHKL"),("export","Export"),("export_as_map","Export as map"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "AsuDataFile":
              menuparams = collections.OrderedDict([('view_text',"View"),("export","Export sequence(s)"),("editLabel","Edit label")])
          elif fileInfo['filetypeclass'] == "PostscriptDataFile":
             menuparams = collections.OrderedDict([('view_PostScript',"View"),("export","Export")])
          else:
             menuparams = collections.OrderedDict([('view_text',"View"),("export","Export")])

          showstr = escapeI2Quotify("show")
          textstr = escapeI2Quotify("text/plain")
          texturistr = escapeI2Quotify("text/uri-list")
          texturiLinkstr = escapeI2Quotify("file://"+filePath)
          textidstr = escapeI2Quotify("file://"+filePath)
          objid = escapeI2Quotify("menu"+params['dbFileId'])

          for k,v in menuparams.items():
             li1 =  etree.Element('li')
             a1 =  etree.Element('a')
             a1.text = v
             itemparams = dict(params)
             itemparams["action"] = k
             stringparams = escapeI2Quotify(json.dumps(itemparams))
             a1.set('onclick','document.getElementById('+objid+').classList.remove('+showstr+');window.buttonBridge.clicked('+stringparams+');')
             li1.append(a1)
             menu.append(li1)

          menu.set('onmouseout','onMouseOut(event,'+objid+')')

          command = '(function (event) {console.log('+objid+');document.getElementById('+objid+').classList.toggle('+showstr+');event.preventDefault();return false;})(event);'

          dragcommand ="(function (event) { event.dataTransfer.clearData();event.dataTransfer.effectAllowed = 'copy';event.dataTransfer.setData("+texturistr+", "+texturiLinkstr+");event.dataTransfer.setData("+textstr+", "+textidstr+");})(event)"



          launchImage.set('oncontextmenu',command)
          launchImage.set('ondragstart',dragcommand)

      outerDiv.append(obj)
      root.append(outerDiv)
      clear = etree.Element('div')
      clear.set('class','clear')
      root.append(clear)

    return root

class InputData(IODataList):

  def as_etree(self):
    from dbapi import CCP4DbApi
    root = etree.Element('root')
    anchor = etree.Element('a')
    anchor.set('name','inputData')
    root.append(anchor)
    head = etree.Element('h5')
    head.set('class','section')
    head.text = 'Input Data'
    root.append(head)
    root.append(self.as_etree0(role='inputfiles'))
    root.append(self.as_etree0(role='importedfiles'))
    return root

  def as_data_etree(self):
    root = super().as_data_etree()
    root.append(self.as_etree())
    return root

class OutputData(IODataList):

  def as_etree(self):
    from dbapi import CCP4DbApi
    root = etree.Element('root')
    anchor = etree.Element('a')
    anchor.set('name','outputData')
    root.append(anchor)
    head = etree.Element('h5')
    head.set('class','section')
    head.text = 'Output Data'
    root.append(head)
    root.append(self.as_etree0(role='outputfiles'))
    return root
    
  def as_data_etree(self):
    root = super().as_data_etree()
    root.append(self.as_etree())
    return root

class ImportedFiles(IODataList):

  def as_etree(self):
    from dbapi import CCP4DbApi
    root = etree.Element('root')
    anchor = etree.Element('a')
    anchor.set('name','importedFiles')
    root.append(anchor)
    head = etree.Element('h5')
    head.set('class','section')
    head.text = 'Imported Files'
    root.append(head)
    root.append(self.as_etree0(role='importedfiles'))
    return root

  def as_data_etree(self):
    root = super().as_data_etree()
    root.append(self.as_etree())
    return root

class Title(ReportClass):
  def __init__(self, xrtnode=None, xmlnode=None, jobInfo = {}, **kw):
    super().__init__()
    import time
    #print 'Title.__init__ jobInfo',jobInfo
    self.title0 = 'Job '+str(jobInfo['jobnumber'])+': '+ jobInfo['tasktitle']
    if jobInfo.get('jobtitle',None) is not None and len(jobInfo['jobtitle'])>0:
      self.title1 = jobInfo['jobtitle']
    else:
      self.title1 = None

    self.title2 =  time.strftime('%H:%M %d-%b-%Y',time.localtime(jobInfo['creationtime']))

  def as_data_etree(self):
    root = super().as_data_etree()
    title1 = getattr(self, 'title1', '')
    if title1 is None: title1 = ''
    root.set('title1', title1)
    title2 = getattr(self, 'title2', '')
    if title2 is None: title2 = ''
    root.set('title2', title2)
    return root

  def as_etree(self):
    root =  etree.Element('div')
    root.set('class','title')
    #for item in ['title0','title1','title2']:
    for item in ['title1','title2']:
      if getattr(self,item,None) is not None:
        h1 = etree.Element('p')
        h1.set('class',item)
        h1.text = getattr(self,item)
        root.append(h1)

    '''
    intLinks = etree.Element('p')
    intLinks.set('class','links')
    root.append(intLinks)
    '''
    
    return root
  
class JobDetails(ReportClass):
  def __init__(self, xrtnode=None, xmlnode=None, jobInfo = {},**kw):
    super().__init__()
    self.id = kw.get('id',None)
    self.class_ = kw.get('class_',None)
    self.jobInfo = {}
    self.jobInfo.update(jobInfo)

  def getI2Version(self):
    # try getting i2 version from the diagnostic.xml file
    diagfile = os.path.normpath(os.path.join(self.jobInfo['fileroot'],'diagnostic.xml'))
    #print 'JobDetails.getI2Version diagfile',diagfile
    if os.path.exists(diagfile):
      from core import CCP4File
      x = CCP4File.CI2XmlHeader()
      x.loadFromXml(diagfile)
      return str(x.ccp4iVersion)
    else:
      return 'Unknown'

  def as_data_etree(self):
    import time
    root = super().as_data_etree()
    root.set('creationtime', time.strftime('%H:%M %d-%b-%Y',time.localtime(self.jobInfo['creationtime'])))
    root.set('finishtime', time.strftime('%H:%M %d-%b-%Y',time.localtime(self.jobInfo['finishtime'])))
    root.set('status', self.jobInfo.get('status', 'Unknown'))
    return root

  def as_etree(self):
    import time
    fold = Fold(label='Job run details',brief='Run')
    tab = fold.addTable()
    tab.internalId='data_JobDetails'
    self.jobInfo['creationtime'] = time.strftime('%H:%M %d-%b-%Y',time.localtime(self.jobInfo['creationtime']))
    self.jobInfo['finishtime'] = time.strftime('%H:%M %d-%b-%Y',time.localtime(self.jobInfo['finishtime']))
    for key1,key2 in [['status','Job status'],['creationtime','Creation time'],['finishtime','Finish time']]:
      if key1 in self.jobInfo:
        tab.addData(title=key2,data=[str(self.jobInfo[key1])])
    tab.transpose=True

    return fold.as_etree()

  def makeRow(self,key,value):
    tr = etree.Element('tr')
    th = etree.Element('th')
    th.text = str(key)
    tr.append(th)
    td = etree.Element('td')
    td.text = str(value)
    tr.append(td)
    return tr

class JobLogFiles(ReportClass):
  def __init__(self, xrtnode=None, xmlnode=None, jobInfo = {},**kw):
    super().__init__()
    self.id = kw.get('id',None)
    self.class_ = kw.get('class_',None)
    self.jobInfo = {}
    self.jobInfo.update(jobInfo)

  def getI2Version(self):
    # try getting i2 version from the diagnostic.xml file
    diagfile = os.path.normpath(os.path.join(self.jobInfo['fileroot'],'diagnostic.xml'))
    #print 'JobDetails.getI2Version diagfile',diagfile
    if os.path.exists(diagfile):
      from core import CCP4File
      x = CCP4File.CI2XmlHeader()
      x.loadFromXml(diagfile)
      return str(x.ccp4iVersion)
    else:
      return 'Unknown'

  def as_data_etree(self):
    import time
    root = super().as_data_etree()
    root.set('creationtime', time.strftime('%H:%M %d-%b-%Y',time.localtime(self.jobInfo['creationtime'])))
    root.set('finishtime', time.strftime('%H:%M %d-%b-%Y',time.localtime(self.jobInfo['finishtime'])))
    root.set('status', self.jobInfo.get('status', 'Unknown'))
    return root

  def as_etree(self):

    logFold = Fold(label='Log files',brief='Logs')
    tab = logFold.addTable()
    tab.internalId='data_LogFiles'

    jobId = self.jobInfo["jobid"]
    jobDirectory = PROJECTSMANAGER().makeFileName(jobId=jobId,mode='ROOT')

    allText = ""
    for root, subFolders, files in os.walk(jobDirectory):
        for fn in files:
            if (fn.endswith(".log") or fn.endswith(".txt")) and os.path.exists(os.path.join(root,fn)):
                fileName = os.path.join(root,fn)
                if os.path.exists(fileName):
                    allText += fileName + "\n"
                    with open(fileName) as f:
                        t = f.read()
                        allText += t + "\n\n"

    download = logFold.addCopyToClipboard(text=allText,label="Copy all to clipboard")

    for root, subFolders, files in os.walk(jobDirectory):
        for fn in files:
            if (fn.endswith(".log") or fn.endswith(".txt")) and os.path.exists(os.path.join(root,fn)):
                fileName = os.path.join(root,fn)
                if os.path.exists(fileName):
                    fileFold = Fold(label=fileName,brief=os.path.basename(fileName))
                    logFold.append(fileFold)
                    t = ""
                    with open(fileName) as f:
                        t = f.read()
                    download = fileFold.addCopyToClipboard(text=t,label="Copy "+os.path.basename(fileName)+" to clipboard")
                    logPre = fileFold.addPre()
                    logPre.text = t

    return logFold.as_etree()

  def makeRow(self,key,value):
    tr = etree.Element('tr')
    th = etree.Element('th')
    th.text = str(key)
    tr.append(th)
    td = etree.Element('td')
    td.text = str(value)
    tr.append(td)
    return tr

class Help:
  def __init__(self,xrtnode=None,xmlnode=None,jobInfo={},**kw):
    self.id = kw.get('id',None)
    if xrtnode is not None:
      self.ref = xrtnode.get('ref',None)
    else:
      self.ref = kw.get('ref',None)
    if self.ref is not None and self.ref[0]=='$':
      import sys
      import re
      from core import CCP4Utils
      if sys.platform == "win32":
        tweak = CCP4Utils.getCCP4I2Dir().replace('\\','/') # This had better be sane.
        tweakref = self.ref.replace('\\','/')              # Ditto
        self.ref = re.sub(r'\$CCP4I2',tweak,tweakref)
        self.ref = os.path.normpath(self.ref)
      else:
        self.ref = re.sub(r'\$CCP4I2',CCP4Utils.getCCP4I2Dir(),self.ref)
    if xrtnode is not None:
      self.label =  xrtnode.get('label','About this '+kw.get('mode',''))
    else:
      self.label = kw.get('label','About this '+kw.get('mode',''))

  def as_etree(self):
    root = etree.Element('root')
    span = etree.Element('span')
    if self.id is not None: span.set('id',self.id)
    root.append(span)
    span.set('class','help')
    if self.ref is not None:
      a =  etree.Element('a')
      a.set('href',self.ref)
      a.text= self.label
      span.append(a)
    return root

class Launch:
  
  counter = 0
  def __init__(self,xrtnode=None,xmlnode=None,jobInfo={},**kw):

    Launch.counter += 1
    self.id = kw.get('id',None)
    #self.internalId = 'launcher_'+str(jobInfo.get('jobid','xxx'))+'_'+str(Launch.counter)
    self.jobId = jobInfo.get('jobid',None)
    self.exe=None
    self.label=None
    # This is a list - could be more than one graph 
    self.ccp4_data_id=[]
    self.sceneFile =None

    if xrtnode is not None:
      self.exe = xrtnode.get('exe',None)
      self.label = xrtnode.get('label',None)
      if xrtnode.get('ccp4_data_id',None) is not None: self.ccp4_data_id.append(xrtnode.get('ccp4_data_id'))
      self.sceneFile = xrtnode.get('sceneFile',None)
    self.exe = kw.get('exe',self.exe)
    self.label = kw.get('label',self.label)
    if kw.get('ccp4_data_id',None) is not None: self.ccp4_data_id.append(kw.get('ccp4_data_id'))
    # Use relative path in case project moved - Launcher widget will know jobId and be able to find file
    self.sceneFile = kw.get('sceneFile',self.sceneFile)
    if self.sceneFile is not None: self.sceneFile = './'+os.path.split(self.sceneFile)[-1]

  def appendDataId(self,ccp4_data_id=None):
    if self.ccp4_data_id.count(ccp4_data_id)==0:
      self.ccp4_data_id.append(ccp4_data_id)

  def as_etree(self):
    import json

    """
    Let's replace this with some js...
  <object class="qt_launch" type="x-ccp4-widget/CLauncherButton"><param name="label" value="View in CCP4mg" /><param name="exe" value="CCP4mg" /><param name="sceneFile" value="./scene_26.scene.xml" /><param name="jobId" value="de3c23abab0511eabf72820f1d307bc0" /></object>
    """

    root =etree.Element('root')

    obj = etree.Element('button')
    obj.set('style','line-height: 14pt; box-sizing: border-box;')
    if getattr(self,"label",None ) is not None:
        obj.text = getattr(self,"label")
        obj.set('title',getattr(self,"label"))
        params = {}
        if getattr(self,"exe",None ) is not None:
           params['exe'] = getattr(self,"exe")
        if getattr(self,"sceneFile",None ) is not None:
           params['sceneFile'] = getattr(self,"sceneFile")
        if self.jobId is not None:
           params['jobId'] = self.jobId
        dataId = ""
        for data_id in self.ccp4_data_id:
            dataId += data_id + ","
        if len(dataId) > 0:
           params['ccp4_data_id'] = dataId

        jsonParams = json.dumps(params)

        a = escapeI2Quotify(jsonParams)

        obj.set('onclick','window.buttonBridge.clicked('+a+')')

    root.append(obj)

    return root

class CopyToClipboard:
  def __init__(self,text="",label="Copy to clipboard",**kw):
    self.text=text
    self.label=label

  def as_etree(self):
    import json

    obj = etree.Element('button')

    obj.set('style','line-height: 14pt; box-sizing: border-box;')
    obj.text = self.label
    obj.set('title',"CopyToClipboard")

    n = 4096
    split_text = [escapeI2Quotify(self.text[i:i+n]) for i in range(0, len(self.text), n)]

    obj.set('onclick','navigator.clipboard.writeText('+"+".join(split_text)+')')

    return obj


class Download:
  
  counter = 0
  def __init__(self,xrtnode=None,xmlnode=None,jobInfo={},**kw):
    Launch.counter += 1
    self.id = kw.get('id',None)
    #self.internalId = 'download_'+str(jobInfo.get('jobid','xxx'))+'_'+str(Download.counter)
    self.jobId = jobInfo.get('jobid',None)
    self.dataName=None
    self.label=None

    if xrtnode is not None:
      self.dataName = xrtnode.get('dataName',None)
      self.label = xrtnode.get('label',None)
    self.dataName = kw.get('dataName',self.dataName)
    self.label = kw.get('label',self.label)


  def as_etree(self):
    import json

    obj = etree.Element('button')

    obj.set('style','line-height: 14pt; box-sizing: border-box;')
    obj.text = "Download"
    obj.set('title',"Download")

    if True:
        params = {}
        if self.dataName is not None:
           params['dataName'] = self.dataName
        if self.jobId is not None:
           params['jobId'] = self.jobId

        params['action'] = 'download'

        jsonParams = json.dumps(params)

        a = escapeI2Quotify(jsonParams)

        obj.set('onclick','window.buttonBridge.clicked('+a+')')

    return obj
  
class LaunchTask:
  
  counter = 0
  def __init__(self,xrtnode=None,xmlnode=None,jobInfo={},**kw):
    Launch.counter += 1
    self.id = kw.get('id',None)
    #self.internalId = 'launcher_'+str(jobInfo.get('jobid','xxx'))+'_'+str(Launch.counter)
    self.jobId = jobInfo.get('jobid',None)
    if xrtnode is not None:
      self.taskName = xrtnode.get('taskName',None)
      self.label = xrtnode.get('label',None)
      self.ccp4_data_id = xrtnode.get('ccp4_data_id',ccp4_data_id)
    
    self.taskName = kw.get('taskName',self.taskName)
    self.label = kw.get('label',self.label)
    self.ccp4_data_id = kw.get('ccp4_data_id',self.ccp4_data_id)

  def as_etree(self):

    #root =etree.Element('root')
    obj = etree.Element('object')
    obj.set('class','qt_launch_task')
    obj.set('type','x-ccp4-widget/CLaunchTaskButton')
    if self.id is not None: obj.set('id',self.id)
    #root.append(obj)

    for key in ['label','taskName','ccp4_data_id']:
      if getattr(self,key,None ) is not None:
        p = etree.Element('param')
        p.set('name',key)
        p.set('value',getattr(self,key))
        obj.append(p)
    
    if self.jobId is not None:
      p = etree.Element('param')
      p.set('name','jobId')
      p.set('value',str(self.jobId))
      obj.append(p)
  
    return obj

class Picture:

  ERROR_CODES = { 101 : { 'description' : 'Error reading picture definition' },
                  102 : { 'description' : 'Error parsing xml from scene file' },
                  103 : { 'description' : 'Error parsing xml from scene description' },
                  104 : { 'description' : 'No scene description provided' } }

  def __init__(self, xrtnode=None,xmlnode=None,jobInfo={},**kw):
    import copy
    self.id = kw.get('id',None)
    self.class_ = kw.get('class_',None)
    self.launchList = []

    bodyEle = etree.Element('ccp4i2_body')
    sceneEle = etree.Element('scene')
    bodyEle.append(sceneEle)

    sceneRoot = None
    if xrtnode is not None:
      sceneRoot = xrtnode
    elif kw.get('scene',None) is not None:
      try:
        sceneRoot = etree.fromstring( kw['scene'], PARSER() )
      except:
        raise CException(self.__class__,103, kw['scene'])
    elif kw.get('sceneFile',None) is not None:
      from core import CCP4Utils
      import os
      fileName = kw.get('sceneFile')
      if fileName[0:8] == '$CCP4I2/':
        fileName = os.path.join(CCP4Utils.getCCP4I2Dir(),fileName[8:])
      #print 'Report.Pictures fileName',fileName
      if not os.path.exists(fileName):
        raise CException(self.__class__,101,fileName)
      else:
        try:
          sceneRoot = etree.fromstring( open(fileName ).read(), PARSER() )
        except:
          raise CException(self.__class__,102,fileName)
    
    if sceneRoot is None:
      raise CException(self.__class__,104,fileName)
      
    for child in sceneRoot:
      sceneEle.append(copy.deepcopy(child))
      bodyEle = applySelect(bodyEle,xmlnode,jobInfo)
  
    #print etree.tostring(bodyEle,pretty_print=True)
    
    from core import CCP4File
    import glob
    sceneFileList = glob.glob(jobInfo.get('fileroot','')+'scene_*.scene.xml')
    indx = 0
    for sceneFile in sceneFileList:
      indx = max ( indx, int(sceneFile[0:-10].split('_')[-1]))
    #print 'Picture.__init__',sceneFileList,indx

    if 'fileroot' in jobInfo and jobInfo['fileroot'] is not None:
      self.picDefFile = CCP4File.CI2XmlDataFile(fullPath=jobInfo['fileroot']+'scene_'+str(indx+1)+'.scene.xml')
    else:
      self.picDefFile = CCP4File.CI2XmlDataFile(os.path.join(os.getcwd(),'scene_'+str(indx+1)+'.scene.xml'))
    self.picDefFile.header.setCurrent()
    self.picDefFile.header.function.set('MGSCENE')
    self.picDefFile.header.projectId.set(jobInfo.get('projectid',None))
    self.picDefFile.header.projectName.set(jobInfo.get('projectname',None))
    self.picDefFile.header.jobId.set(jobInfo.get('jobid',None))
    self.picDefFile.header.jobNumber.set(jobInfo.get('jobnumber',None))
    self.picDefFile.saveFile(bodyEtree=bodyEle,useLXML=False)

    #report.pictureQueue.append(self.picDefFile.__str__())
    if xrtnode is not None:
      self.label = xrtnode.get('label',None)
    else:
      self.label= kw.get('label',None)
    
    launchNode = etree.Element('launch')
    launchNode.set('exe','CCP4mg')
    launchNode.set('label','View in CCP4mg')
    if self.picDefFile is not None:
      launchNode.set('sceneFile',str(self.picDefFile))
    self.launchList.append(Launch(launchNode,jobInfo=jobInfo))

    launchNode = etree.Element('launch')
    launchNode.set('exe','Coot')
    launchNode.set('label','View in Coot')
    #launchNode.set('cootScript',self.cootScript)
    self.launchList.append(Launch(xrtnode=launchNode,jobInfo=jobInfo))

    
  def as_etree(self):
    import uuid
    import json
    from core import CCP4Utils
    
    root = etree.Element('div')
    if self.picDefFile is None: return root

    # Make the path relative or will be broken on exporting project
    fileRoot = os.path.split(os.path.splitext(os.path.splitext(str(self.picDefFile))[0])[0])[-1]
    picFile = './'+fileRoot+'.png'
    #print 'Picture.as_etree picFile',picFile
    
    t = etree.Element('table')
    if self.class_ is None:
      t.set('class','picture')
    else:
      t.set('class',self.class_)
    if self.id is not None: t.set('id',self.id)
    r = etree.Element('tr')
    t.append(r)
    
    d =  etree.Element('td')
    d.set('colspan',str(len(self.launchList)))
    r.append(d)

    webglDiv = etree.Element('div')
    uuid_str = uuid.uuid4().hex
    webglDiv.set('id',uuid_str)
    webglDiv.set('style','border: none; width: 350px; height: 350px; float: left;')
    d.append(webglDiv)

    table = etree.Element('div')
    d.append(table)
    tr = etree.Element('tr')
    table.append(tr)
    td = etree.Element('td')
    td.text = "Fog"
    tr.append(td)
    td = etree.Element('td')
    fog_slider_rangeDiv = etree.Element('div')
    fog_slider_range_uuid_str = uuid.uuid4().hex
    fog_slider_rangeDiv.set('id',fog_slider_range_uuid_str)
    td.append(fog_slider_rangeDiv)
    tr.append(td)
    tr = etree.Element('tr')
    table.append(tr)
    td = etree.Element('td')
    td.text = "Clip"
    tr.append(td)
    td = etree.Element('td')
    clip_slider_rangeDiv = etree.Element('div')
    clip_slider_range_uuid_str = uuid.uuid4().hex
    clip_slider_rangeDiv.set('id',clip_slider_range_uuid_str)
    td.append(clip_slider_rangeDiv)
    tr.append(td)

    tree = self.picDefFile.getEtreeRoot(useLXML=False)
    MolDatas = tree.findall("ccp4i2_body/scene/data/MolData")

    for m in MolDatas:
        fn = m.findall("filename")
        if fn[0].text is not None:
          with open(fn[0].text) as f:
              fnt = f.read()
          fd = etree.SubElement(m,"filedata")
          fd.text = fnt.replace("<","&lt;").replace(">","&gt;")
          m.remove(fn[0])
    MapDatas = tree.findall("ccp4i2_body/scene/data/MapData")

    #I think I want to put this "in a different file", for on demand loading.
    for m in MapDatas:
        fn = m.findall("filename")
        fd = etree.SubElement(m,"filedata")
        #FIXME - So how do I get these?
        fd_projid = etree.SubElement(m,"ccp4i2_project")
        fd_jobno = etree.SubElement(m,"ccp4i2_jobno")
        if fn[0].text is not None:
          b64map, mean,std_dev = MTZToB64Map(fn[0].text)
          mapName = fn[0].text[:-3]+"map"
          #fd.text = b64map
          with open(mapName,"wb+") as mapF:
              mapF.write(b64map)
          fd.text = mapName
          sigma = etree.SubElement(m,"sigma")
          sigma.text = str(std_dev)
          mean = etree.SubElement(m,"mean")
          mean.text = str(mean)
          m.remove(fn[0])

    mapLoad_uuid_str = uuid.uuid4().hex

    sceneText = etree.tostring(tree).decode("utf-8")

    script = etree.Element('script')
    script.text = """
    function webglfun(fogdiv,clipdiv,maploadButton) {

        var gl = new MGWebGL("""+'"'+uuid_str+'"'+""",true,false); 
        
        var enerLib = new EnerLib();

        gl.setBackground([1.0,1.0,1.0,1.0]);
        var contents = """+'`'+sceneText+'`'+""";
        if (window.DOMParser) {
            var parser=new DOMParser();
            xmlDoc=parser.parseFromString(contents,"text/xml");
        } else {
            xmlDoc=new ActiveXObject("Microsoft.XMLDOM");
            xmlDoc.async=false;
            xmlDoc.loadXML(contents);
        }
        var extent = doParseAndLoad(gl,enerLib,xmlDoc,maploadButton);
        gl.setShowAxes(true);
  $( function() {
    $( fogdiv ).slider({
      range: true,
      min: -extent,
      max: extent,
      values: [ -0.25*extent,0.75*extent ],
      slide: function( event, ui ) {
        gl.setFog(ui.values);
      }
    });
    $( "#amount" ).val( "$" + $( fogdiv ).slider( "values", 0 ) +
      " - $" + $( fogdiv ).slider( "values", 1 ) );
  } );
  
  $( function() {
    $( clipdiv ).slider({
      range: true,
      min: -extent,
      max: extent,
      values: [ -0.25*extent,extent*.25 ],
      slide: function( event, ui ) {
        gl.set_clip_range(ui.values[0],ui.values[1],true);
      }
    });
    $( "#amount" ).val( "$" + $( clipdiv ).slider( "values", 0 ) +
      " - $" + $( clipdiv ).slider( "values", 1 ) );
  } );
        };
    enqueue(webglfun,"#"""+fog_slider_range_uuid_str+"\",\"#"+clip_slider_range_uuid_str+"\",\""+mapLoad_uuid_str+"""\");
    """
    d.append(script)

    d =  etree.Element('td')
    r.append(d)
    if self.label is not None:
      anno = etree.Element('p')
      anno.set('class','annotation')
      anno.text = self.label
    d.append(anno)

    buttonRow = etree.Element('tr')
    t.append(buttonRow)
    root.append(t)

    model_uuid_str = uuid.uuid4().hex
    pbc =  etree.Element('td')
    buttonRow.append(pbc)
    pb = etree.Element("button")
    pb.set("type","button")
    pb.text = "Expand"
    pb.set("class","webgllaunchbutton");
    itemparams = dict()
    itemparams["action"] = "WebGL"
    itemparams["htmlBase"] = htmlBase()
    itemparams["picdef"] = str(self.picDefFile)

    stringparams = escapeI2Quotify(json.dumps(itemparams))
    pb.set("onclick",'window.buttonBridge.clicked('+stringparams+');');
    pbc.append(pb)

    pb = etree.Element("button")
    pb.set("type","button")
    pb.text = "Load maps"
    pb.set("class","webgllaunchbutton");
    pb.set("id",mapLoad_uuid_str);
    pbc.append(pb)

    """
#FIXME - This probably isn't the right thing to do anyway. The modal dialog can only be as big as visible report area. That's not big enough. Want a Qt dialog
    pb.set("onclick",'var modal = document.getElementById("'+model_uuid_str+'"); modal.style.display = "block";');
    
    myModal = etree.Element('div')
    myModal.set("id",model_uuid_str)
    myModal.set("class","modal")
    myModalContent = etree.Element('div')
    myModalContent.set("class","modal-content")
    closeButton = etree.Element("span")
    closeButton.set("class","close")
    closeButton.text = u"\u00D7"
    closeButton.set("onclick",'var modal = document.getElementById("'+model_uuid_str+'"); modal.style.display = "none";')
    myModalContent.append(closeButton)
    myModal.append(myModalContent)
    root.append(myModal)
    """

    for launch in self.launchList:
      d =  etree.Element('td')
      buttonRow.append(d)
      l = launch.as_etree()
      if l.tag == 'root':
        d.extend(l)
      else:
        d.append(l)
    

    return root

# Main program, if run from command line.
# Usage: python report.py my.xrt my.xml
if __name__ == "__main__":
  import sys
  xrt = etree.fromstring( open( sys.argv[1] ).read(), PARSER() )
  xml = etree.fromstring( open( sys.argv[2] ).read(), PARSER() )
  xreport = xrt.findall( "/report" )[0]
  report = Report( xreport, xml )
  #print report.as_html()

  tree= report.as_etree()


class GenericReport(Report):
  def __init__(self,xmlnode=None,jobInfo={},**kw):
    Report. __init__(self,xmlnode=xmlnode,jobInfo=jobInfo,**kw)
    title = jobInfo.get('tasktitle','')
    self.addText(text=title)


class Reference(ReportClass):
  ERROR_CODES = {  }

  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {}, **kw ):
    super().__init__()
    self.id = kw.get('id',None)
    if xrtnode is not None:
      data = xrtnode
    else:
      data = kw
    self.href = data.get('href',None)
    self.authorList = data.get('authorList',[])
    if data.get('author',None) is not None: self.authorList.append(data.get('author',None))
    self.source = data.get('source',None)
    self.articleTitle = data.get('articleTitle',None)
    self.articleLink = data.get('articleLink',None)

  def as_data_etree(self):
    root = super().as_data_etree()
    if self.articleTitle is not None: root.set('articleTitle', self.articleTitle)
    if self.articleLink is not None: root.set('articleLink', self.articleLink)
    if self.source is not None: root.set('source', self.source)
    if len(self.authorList) > 0:  root.set('authorList',str(self.authorList))
    return root

  def as_etree(self):
    root = etree.Element('div')
    root.set('class','bibreference')
    '''
    div = etree.SubElement(root,'div')
    div.set('style','float:left;')
    if USEQTICONS:
      icon = etree.SubElement(div,'object')
      icon.set('class','qticon')
      icon.set('type','x-ccp4-widget/CReferenceIcon')
    else: 
      icon = etree.SubElement(div,'image')
      icon.set('height','24')
      icon.set('width','24')
      icon.set('src',htmlBase()+"/book.svg")
      icon.set('alt','Bibliographic reference icon')
    div = etree.SubElement(root,'div')
    div.set('style','float:left;')
    '''
    div = root
    p = etree.SubElement(div,'p')    
    p.set('class','articletitle')
    if self.articleLink is not None:
      a = etree.SubElement(p,'a')
      a.set('href',self.articleLink)
      a.text = self.articleTitle
    else:
      p.text = self.articleTitle
    #div = etree.SubElement(root,'div')
    #div.set('style','clear:both;') 
    if len(self.authorList)>0:
      ele = etree.SubElement(div,'p')
      ele.set('class','authors')
      t = ''
      for item in self.authorList: t += item + ', '
      ele.text = t[0:-2]
    ele = etree.SubElement(div,'p')
    ele.set('class','source')
    ele.text = self.source

    return root

    
class ReferenceGroup(Container):
  ERROR_CODES = { 100 : { 'description' : 'Failed attempting to load MedLine file - file not found'  }
                  }
  def __init__( self, xrtnode=None, xmlnode=None, jobInfo = {} , **kw):
    Container.__init__( self, xrtnode=xrtnode, xmlnode=xmlnode, jobInfo=jobInfo, **kw )
    self.label='References'
    self.tag='div'
    self._class = 'bibreference_group'
    self.taskName = kw.get('taskName',None)

  def as_etree(self):

    if self.title is not None:
      title = self.title
    elif self.taskName is not None:
      from core import CCP4TaskManager
      title = CCP4TaskManager.TASKMANAGER().getTitle(taskName=self.taskName)+ ' references'
    else:
      title = 'References'
      
    root = etree.Element('div')
    root.set('class','bibreference_group')

    div = etree.SubElement(root,'div')
    div.set('style','float:left;')
    if USEQTICONS:
      icon = etree.SubElement(div,'object')
      icon.set('class','qticon')
      icon.set('type','x-ccp4-widget/CReferenceIcon')
      param = etree.SubElement(icon,'param')
      param.set('name','taskName')
      param.set('value',str(self.taskName))
    else: 
      icon = etree.SubElement(div,'image')
      icon.set('height','24')
      icon.set('width','24')
      icon.set('src',htmlBase()+"/book.svg")
      icon.set('alt','Bibliographic reference icon')
    div = etree.SubElement(root,'div')
    div.set('style','float:left;') 
    #p = etree.SubElement(div,'p')    
    div.set('class','reference_group_title')
    div.text=title
    div = etree.SubElement(root,'div')
    div.set('style','clear:both;') 
    for child in self.children:
      tree = child.as_etree()
      if tree is not None: div.append(tree)

    return root
    
  def loadFromMedLine(self,taskName=None,fileName=None):
    if fileName is None and taskName is not None:
      from core import CCP4TaskManager
      fileNameList = CCP4TaskManager.TASKMANAGER().searchReferenceFile(taskName)
      if len(fileNameList)>0:fileName=fileNameList[0]
    if fileName is None or not os.path.exists(fileName):
      self.errReport.append(self.__class__,100,'Taskname: '+str(taskName)+' Filename: '+str(fileName))
      return
    self.taskName = taskName
    import re
    from core import CCP4Utils
    try:
      text = CCP4Utils.readFile(fileName=fileName)
    except CException as e:
      self.errReport.extend(e)
      return
    textList = text.split('\nPMID- ')
    #print 'ReferenceGroup.loadFromMedLine textList',textList
    for text in textList:
      ref = Reference()
      m = re.search(r'TI  -(.*)',text)
      if m is not None: ref.articleTitle = m.groups()[0].strip()
      m = re.search(r'SO  -(.*)',text)
      if m is not None: ref.source = m.groups()[0].strip()
      m = re.findall(r'AU  -(.*)',text)
      for item in m: ref.authorList.append(item.strip())
      m = re.search(r'URL -(.*)',text)
      if m is not None: ref.articleLink = m.groups()[0].strip()
      if ref.source is not None: self.append(ref)
    #print 'ReferenceGroup.loadFromMedLine',ref



class BaublesHtml:

  ERROR_CODES = { 1 : { 'description' : 'Failed to find Baubles html file' }
                }

  def __init__(self,fileName):
    if not os.path.exists(fileName):
      raise CErrorReport(self.__class__,1,fileName)

    self.fileNode = lxml_html.parse(fileName)

  def convert(self,fileName):
    #self.extendHead()
    self.replaceApplets()
    self.saveFile(fileName)


  def extendHead(self,base=None,jsFileList=['xreport.js']):
    if base is None: base = htmlBase()
    head = self.fileNode.findall("/html/head[1]")

    for jsFile in jsFileList:
      script = etree.Element('script')
      script.set('src',base+'/'+jsFile)
      head.insert(0,script)

  def replaceApplets(self):
    appletDivList = self.fileNode.findall("//div[@class='applet']")
    #print 'appletDivList',appletDivList

    for appletDiv in appletDivList:
      parent = appletDiv.getparent()
      indx = parent.index(appletDiv)
      tableName,graphTitleList,graphTypeList,graphColumnsList,columnNameList,columnDataList = self.parseLoggraph(appletDiv)
      graphObj = FlotGraph(title=tableName)
      for n in range(0,min(len(columnNameList),len(columnDataList))):
        graphObj.addData(title=columnNameList[n],data=columnDataList[n])
      for n in range(0,len(graphTitleList)):
        plotObj = Plot(title=graphTitleList[n],description=graphTitleList[n])
        graphObj.plots.append(plotObj)
        for i in range(1,len(graphColumnsList[n])):
          plotObj.append('plotline',text=columnNameList[graphColumnsList[n][i]], xcol=str(graphColumnsList[n][0]), ycol=str(graphColumnsList[n][i]))
      
      parent.insert(indx,graphObj.as_etree())
      parent.remove(appletDiv)

  def parseLoggraph(self,appletDiv):
    import os
    graphTitleList = []
    graphTypeList = []
    graphColumnsList = []
    tableList = appletDiv.findall(".//param[@name='table']")
    #print 'parseLoggraph',appletDiv,tableList
    if len(tableList)>0:
      splitList = tableList[0].get('value').split('$$')
      dum,tabText,graphText = splitList.pop(0).split('$')
      tableName = tabText.split(':')[1].strip()
      graphSplit = graphText.split(':')
      #print 'parseLoggraph',graphSplit
      for nn in range(0,len(graphSplit)/4):
        graphTitleList.append(graphSplit[(nn*4)+1])
        graphTypeList.append(graphSplit[(nn*4)+2])
        columnText = graphSplit[(nn*4)+3].split(',')
        graphColumnsList.append([])
        for item in columnText:
          try:
            graphColumnsList[-1].append(int(item))
          except:
            print('Error interpreting columns for graph',graphTitleList[-1])
      #print 'parseLoggraph',graphTitleList,graphTypeList,graphColumnsList
      columnNameList = splitList.pop(0).split()
      #print 'parseLoggraph columnNameList',columnNameList
      columnDataList = []
      nColumns = len(splitList[1].split(os.linesep)[1].split())
      for n in range(0,nColumns): columnDataList.append([])
      for row in splitList[1].split(os.linesep):
        dataTextList = row.split()
        if len(dataTextList)>0:
          for ii in range(0,min(len(dataTextList),nColumns)):
            try:
              columnDataList[ii].append(float(dataTextList[ii]))
            except:
              columnDataList[ii].append(None)
          
      #print 'parseLoggraph',columnDataList
      return tableName,graphTitleList,graphTypeList,graphColumnsList,columnNameList,columnDataList

  def saveFile(self,fileName):
    from core import CCP4Utils
    text = lxml_html.tostring(self.fileNode,method='html')
    CCP4Utils.saveFile(fileName,text)

    #Beware testing may need
    #import sys; sys.path.append('/Users/lizp/Desktop/dev/ccp4i2-devel/utils'); startHTTPServer()

"""
$TABLE :table name:
$GRAPHS :graph1 name:graphtype:column_list: :graph2 name:graphtype:column_list:
        :graph 3 ...: ... $$
column1_name column2_name ... $$ any_characters $$ numbers $$

where:

table name, graphN name
    are arbitrary strings (without newline) 
columnN_name
    are arbitrary strings without tab, space, newline 
graphtype
    is 
A[UTO]
    for fully automatic scaling (e.g. ... :A:1,2,4,5:) 
N[OUGHT]
    for automatic y coordinate scaling, where y lowest limit is 0 (e.g. ... :N:1,2,4,5:) 
XMIN|XMAXxYMIN|YMAX
    for user defined scaling where XMIN ... are axis limits (e.g. ... :0|100x-1|1:1,2,4,5:) 
any_characters
    are treated as a comment. They can be eventually used as a human oriented table header 
numbers
    represents the table itself. (See parsing algorithm below) 
"""


#========================================================================================
def test(arg1,arg2,arg3=None):
  xrt = etree.fromstring( open( arg1 ).read(), PARSER() )
  xml = etree.fromstring( open( arg2 ).read(), PARSER() )
  #print 'text',xrt.findall( "/report" )
  standardise = False
  xreport = xrt.findall( "/report" )[0]
  #Get the jobInfo
  from report import CCP4ReportGenerator
  if arg3 is not None:
    g = CCP4ReportGenerator.CReportGenerator(jobId=arg3)
    jobInfo = g.getJobInfo(arg3)
    # Need to refer to job that is already in db
    report = Report( xreport, xml, jobInfo=jobInfo,standardise=standardise)
  else:
    report = Report( xreport, xml,jobInfo={},standardise=standardise)

  tree= report.as_etree()
  if len(report.errReport)>0:
    print('ERROR REPORT')
    print(report.errReport.report())
  text = etree.tostring(tree)
  #print text
  from core import CCP4Utils
  CCP4Utils.saveFile('report.html',text=text)
  if report.containsPictures():
    import functools
    g.runMg(report.pictureQueue,functools.partial(printMgFinished,arg3))
    print('Returned from runMg')



def printMgFinished(jobId,exit,status):
  print('MG finished',jobId,exit,status,jobId)

