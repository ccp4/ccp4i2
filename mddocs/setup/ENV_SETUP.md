# Environment Setup Guide

This project supports testing with multiple Python and CCP4 versions to help isolate version-specific issues from code regressions.

## Quick Start

```bash
# Check current environment
./switch_env.sh status

# Switch to Python 3.9 (CCP4-9)
./switch_env.sh py39

# Switch to Python 3.11 (CCP4-20251105)
./switch_env.sh py311

# Run tests (uses active .env configuration)
./run_test.sh i2run/test_parrot.py::test_parrot
```

## Available Environments

### Python 3.11 (CCP4-20251105) - Default
- **CCP4 Root**: `$CCP4`
- **Virtual env**: `.venv`
- **Config file**: `.env.py311`
- **Status**: Newer, active development

### Python 3.9 (CCP4-9)
- **CCP4 Root**: `/Applications/ccp4-9`
- **Virtual env**: `.venv.old-py39`
- **Config file**: `.env.py39`
- **Status**: Older, stable reference

## Initial Setup

### For Python 3.11 (already configured)
```bash
# Activate environment
source .venv/bin/activate

# Install dependencies
pip install autopep8 pytest django

# Symlink mrbump
ln -sf $CCP4/Frameworks/Python.framework/Versions/3.11/lib/python3.11/site-packages/mrbump \
    .venv/lib/python3.11/site-packages/mrbump
```

### For Python 3.9 (if not already set up)
```bash
# Create virtual environment using CCP4-9's Python
/Applications/ccp4-9/bin/ccp4-python -m venv .venv.old-py39

# Activate it
source .venv.old-py39/bin/activate

# Install dependencies
pip install autopep8 pytest django

# Symlink mrbump from CCP4-9
ln -sf /Applications/ccp4-9/Frameworks/Python.framework/Versions/3.9/lib/python3.9/site-packages/mrbump \
    .venv.old-py39/lib/python3.9/site-packages/mrbump
```

## How It Works

1. **`.env` file** - Active configuration read by `run_test.sh`
2. **Template files** - `.env.py39` and `.env.py311` contain preset configurations
3. **`switch_env.sh`** - Copies template to `.env` to switch environments
4. **`run_test.sh`** - Reads `.env` and sources appropriate CCP4 setup

## Configuration Variables

Each `.env` file contains:

```bash
CCP4_VERSION=ccp4-20251105      # CCP4 distribution name
CCP4_ROOT=/path/to/ccp4         # CCP4 installation directory
VENV_DIR=.venv                  # Virtual environment directory
PYTHON_VERSION=3.11             # Python version (informational)
DJANGO_SETTINGS_MODULE=ccp4i2.config.settings
CCP4I2_ROOT=$CCP4I2_ROOT
```

## Use Cases

### Compare Test Results Across Versions
```bash
# Test with Python 3.11
./switch_env.sh py311
./run_test.sh i2run/test_mrbump.py::test_mrbump 2>&1 | tee /tmp/mrbump_py311.log

# Test with Python 3.9
./switch_env.sh py39
./run_test.sh i2run/test_mrbump.py::test_mrbump 2>&1 | tee /tmp/mrbump_py39.log

# Compare results
diff /tmp/mrbump_py311.log /tmp/mrbump_py39.log
```

### Identify Regressions vs. Version Issues
If a test:
- **Passes in both**: Code is working
- **Fails in both**: Likely a code bug
- **Passes in 3.9, fails in 3.11**: Possible Python version incompatibility
- **Fails in 3.9, passes in 3.11**: May be related to CCP4 distribution changes

## Files

- `.env` - Active configuration (gitignored, generated by switch_env.sh)
- `.env.example` - Template with documentation
- `.env.py39` - Python 3.9 preset (tracked in git)
- `.env.py311` - Python 3.11 preset (tracked in git)
- `switch_env.sh` - Environment switcher utility
- `run_test.sh` - Test runner that reads `.env`

## Troubleshooting

### "CCP4 setup script not found"
- Check that `CCP4_ROOT` in your `.env` points to a valid CCP4 installation
- Verify the path contains `bin/ccp4.setup-sh`

### "Virtual environment not found"
- Check that `VENV_DIR` exists
- Run the initial setup commands for that environment

### Tests behave differently between environments
- This is expected! Document the differences to understand if they're:
  - Python version issues
  - CCP4 distribution changes
  - Environment-specific bugs
  - Code regressions

## See Also

- [CLAUDE.md](CLAUDE.md) - Full development documentation
- [run_test.sh](run_test.sh) - Test runner implementation
- [switch_env.sh](switch_env.sh) - Environment switcher implementation
