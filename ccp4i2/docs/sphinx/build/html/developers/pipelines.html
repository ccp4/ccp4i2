
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="lang:clipboard.copy" content="Copy to clipboard">
  <meta name="lang:clipboard.copied" content="Copied to clipboard">
  <meta name="lang:search.language" content="en">
  <meta name="lang:search.pipeline.stopwords" content="True">
  <meta name="lang:search.pipeline.trimmer" content="True">
  <meta name="lang:search.result.none" content="No matching documents">
  <meta name="lang:search.result.one" content="1 matching document">
  <meta name="lang:search.result.other" content="# matching documents">
  <meta name="lang:search.tokenizer" content="[\s\-]+">

  
    <link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Roboto+Mono:400,500,700|Roboto:300,400,400i,700&display=fallback" rel="stylesheet">

    <style>
      body,
      input {
        font-family: "Roboto", "Helvetica Neue", Helvetica, Arial, sans-serif
      }

      code,
      kbd,
      pre {
        font-family: "Roboto Mono", "Courier New", Courier, monospace
      }
    </style>
  

  <link rel="stylesheet" href="../_static/stylesheets/application.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-palette.css"/>
  <link rel="stylesheet" href="../_static/stylesheets/application-fixes.css"/>
  
  <link rel="stylesheet" href="../_static/fonts/material-icons.css"/>
  
  <meta name="theme-color" content="#00020a">
  <script src="../_static/javascripts/modernizr.js"></script>
  
  
  
    <title>CCP4I2 Developers: Wrappers and Pipelines &#8212; CCP4i2  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/material.css" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/contentui.css" />
    <link rel="stylesheet" type="text/css" href="https://github.com/bwithd/sphinx-material/blob/main/sphinx_material/sphinx_material/static/stylesheets/application.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/contentui.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="CCP4I2 Generating Reports" href="reports.html" />
    <link rel="prev" title="CCP4I2 Developers: Writing Task GUIs" href="task_guis.html" />
  
   

  </head>
  <body dir=ltr
        data-md-color-primary=#005BBB data-md-color-accent=yellow>
  
  <svg class="md-svg">
    <defs data-children-count="0">
      
      <svg xmlns="http://www.w3.org/2000/svg" width="500" height="500" viewBox="0 0 500 500" id="__gitlab"><path fill="currentColor" d="M93.667 473.347l90.684-279.097H2.983l90.684 279.097z" transform="translate(156.198 1.16)"/><path fill="currentColor" d="M221.333 473.345L130.649 194.25H3.557l217.776 279.095z" transform="translate(28.531 1.16)" opacity=".7"/><path fill="currentColor" d="M32 195.155L4.441 279.97a18.773 18.773 0 0 0 6.821 20.99l238.514 173.29L32 195.155z" transform="translate(.089 .256)" opacity=".5"/><path fill="currentColor" d="M2.667-84.844h127.092L75.14-252.942c-2.811-8.649-15.047-8.649-17.856 0L2.667-84.844z" transform="translate(29.422 280.256)"/><path fill="currentColor" d="M2.667 473.345L93.351 194.25h127.092L2.667 473.345z" transform="translate(247.198 1.16)" opacity=".7"/><path fill="currentColor" d="M221.334 195.155l27.559 84.815a18.772 18.772 0 0 1-6.821 20.99L3.557 474.25l217.777-279.095z" transform="translate(246.307 .256)" opacity=".5"/><path fill="currentColor" d="M130.667-84.844H3.575l54.618-168.098c2.811-8.649 15.047-8.649 17.856 0l54.618 168.098z" transform="translate(336.974 280.256)"/></svg>
      
    </defs>
  </svg>
  
  <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer">
  <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search">
  <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
  <a href="#developers/pipelines" tabindex="1" class="md-skip"> Skip to content </a>
  <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex navheader">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../index.html" title="CCP4i2  documentation"
           class="md-header-nav__button md-logo">
          
            &nbsp;
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          <span class="md-header-nav__topic">CCP4i2  documentation</span>
          <span class="md-header-nav__topic"> CCP4I2 Developers: Wrappers and Pipelines </span>
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
        
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" action="../search.html" method="get" name="search">
      <input type="text" class="md-search__input" name="q" placeholder="Search"
             autocapitalize="off" autocomplete="off" spellcheck="false"
             data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            <a href="https://gitlab.com/ccp4i2/rstdocs" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__gitlab" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    
  </div>
</a>
          </div>
        </div>
      
      
  
  <script src="../_static/javascripts/version_dropdown.js"></script>
  <script>
    var json_loc = "../"versions.json"",
        target_loc = "../../",
        text = "Versions";
    $( document ).ready( add_version_dropdown(json_loc, target_loc, text));
  </script>
  

    </div>
  </nav>
</header>

  
  <div class="md-container">
    
    
    
  <nav class="md-tabs" data-md-component="tabs">
    <div class="md-tabs__inner md-grid">
      <ul class="md-tabs__list">
          <li class="md-tabs__item"><a href="../index.html" class="md-tabs__link">CCP4i2  documentation</a></li>
          <li class="md-tabs__item"><a href="index.html" class="md-tabs__link">Developer Notes</a></li>
      </ul>
    </div>
  </nav>
    <main class="md-main">
      <div class="md-main__inner md-grid" data-md-component="container">
        
          <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../index.html" title="CCP4i2 documentation" class="md-nav__button md-logo">
      
        <img src="../_static/" alt=" logo" width="48" height="48">
      
    </a>
    <a href="../index.html"
       title="CCP4i2 documentation">CCP4i2  documentation</a>
  </label>
    <div class="md-nav__source">
      <a href="https://gitlab.com/ccp4i2/rstdocs" title="Go to repository" class="md-source" data-md-source="github">

    <div class="md-source__icon">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 24 24" width="28" height="28">
        <use xlink:href="#__gitlab" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    
  </div>
</a>
    </div>
  
  

</nav>
              </div>
            </div>
          </div>
          <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
            <div class="md-sidebar__scrollwrap">
              <div class="md-sidebar__inner">
                
<nav class="md-nav md-nav--secondary">
    <label class="md-nav__title" for="__toc">Contents</label>
  <ul class="md-nav__list" data-md-scrollfix="">
        <li class="md-nav__item"><a href="#developers-pipelines--page-root" class="md-nav__link">CCP4I2 Developers: Wrappers and Pipelines</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#introduction" class="md-nav__link">Introduction</a>
        </li>
        <li class="md-nav__item"><a href="#input-and-output-data" class="md-nav__link">Input and Output Data</a>
        </li>
        <li class="md-nav__item"><a href="#a-simple-wrapper-example-pdbset" class="md-nav__link">A Simple Wrapper Example - <em>pdbset</em></a>
        </li>
        <li class="md-nav__item"><a href="#the-main-cpluginscript-methods" class="md-nav__link">The main <em>CPluginScript</em> methods</a>
        </li>
        <li class="md-nav__item"><a href="#a-simple-pipeline-example-demo-copycell" class="md-nav__link">A Simple Pipeline Example - <em>demo_copycell</em></a>
        </li>
        <li class="md-nav__item"><a href="#pipeline-and-wrapper-file-organisation" class="md-nav__link">Pipeline and Wrapper File Organisation</a>
        </li>
        <li class="md-nav__item"><a href="#unittests-for-wrappers-and-pipelines" class="md-nav__link">Unittests for Wrappers and Pipelines</a>
        </li>
        <li class="md-nav__item"><a href="#testing-and-debugging-scripts" class="md-nav__link">Testing and Debugging Scripts</a>
        </li>
        <li class="md-nav__item"><a href="#buccaneer-a-realistic-example-wrapper" class="md-nav__link">Buccaneer - a realistic example wrapper</a>
        </li>
        <li class="md-nav__item"><a href="#handling-mini-mtzs" class="md-nav__link">Handling Mini-MTZs</a>
        </li>
        <li class="md-nav__item"><a href="#cpluginscript-class-documentation" class="md-nav__link"><em>CPluginScript</em> Class Documentation</a>
        </li>
        <li class="md-nav__item"><a href="#moving-data-between-plugins" class="md-nav__link">Moving Data Between Plugins</a>
        </li>
        <li class="md-nav__item"><a href="#asynchronous-pipelines" class="md-nav__link">Asynchronous Pipelines</a>
        </li>
        <li class="md-nav__item"><a href="#connecting-a-pipeline-with-connectsignal" class="md-nav__link">Connecting a pipeline with connectSignal()</a>
        </li>
        <li class="md-nav__item"><a href="#a-wrapper-that-does-not-run-an-external-process" class="md-nav__link">A ‘Wrapper’ that does not run an External Process</a>
        </li>
        <li class="md-nav__item"><a href="#interrupting-and-restarting-processes" class="md-nav__link">Interrupting and restarting processes</a>
        </li>
        <li class="md-nav__item"><a href="#performance-indicators" class="md-nav__link">Performance Indicators</a>
        </li>
        <li class="md-nav__item"><a href="#project-defaults" class="md-nav__link">Project Defaults</a>
        </li>
        <li class="md-nav__item"><a href="#incorporating-non-ccp4i2-pipelines" class="md-nav__link">Incorporating non-CCP4i2 pipelines</a>
        </li>
        <li class="md-nav__item"><a href="#testing-and-debugging-scripts-1" class="md-nav__link">Testing and Debugging Scripts</a>
        </li>
        <li class="md-nav__item"><a href="#exporting-a-task-as-a-compressed-file" class="md-nav__link">Exporting a task as a compressed file</a>
        </li>
        <li class="md-nav__item"><a href="#exporting-files-from-a-job" class="md-nav__link">Exporting files from a job</a>
        </li>
        <li class="md-nav__item"><a href="#temporary-files-and-file-cleanup" class="md-nav__link">Temporary files and file cleanup</a>
        </li>
        <li class="md-nav__item"><a href="#appendix" class="md-nav__link">Appendix</a><nav class="md-nav">
              <ul class="md-nav__list">
        <li class="md-nav__item"><a href="#parents" class="md-nav__link">Parents</a>
        </li>
        <li class="md-nav__item"><a href="#file-organisation" class="md-nav__link">File Organisation</a>
        </li>
        <li class="md-nav__item"><a href="#the-process-manager" class="md-nav__link">The Process Manager</a>
        </li>
        <li class="md-nav__item"><a href="#xml-files" class="md-nav__link">XML Files</a>
        </li></ul>
            </nav>
        </li></ul>
            </nav>
        </li>
    
<li class="md-nav__item"><a class="md-nav__extra_link" href="../_sources/developers/pipelines.rst.txt">Show Source</a> </li>

<li id="searchbox" class="md-nav__item"></li>

  </ul>
</nav>
              </div>
            </div>
          </div>
        
        <div class="md-content">
          <article class="md-content__inner md-typeset" role="main">
            
  <section id="ccp4i2-developers-wrappers-and-pipelines">
<h1 id="developers-pipelines--page-root">CCP4I2 Developers: Wrappers and Pipelines<a class="headerlink" href="#developers-pipelines--page-root" title="Permalink to this heading">¶</a></h1>
<section id="introduction">
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permalink to this heading">¶</a></h2>
<p>To make a program or script available in CCP4i2 it must be ‘wrapped’ in
a Python script that is a sub-class of the <em>CPluginScript</em> class.
<em>CPluginScript</em> provides methods to handle parameters, run programs,
maintain an error report and record progress to a database so writing a
simple script requires very minimal lines of code. We usually call a
script that runs just one program a ‘wrapper’; and a ‘pipeline’ is a
script that calls two or more wrappers in order to run multiple
programs. We also refer to either wrappers or pipelines as ‘plugins’. We
hope that developers will contribute wrappers to the <em>ccp4i2/wrappers</em>
directory to be available to all pipeline developers and the GUI. This
is the place to look for examples to follow. There is a separate
<em>ccp4i2/pipelines</em> directory for contributed pipelines.</p>
<p>For each script we need to clearly define the interface (i.e. the
parameters that are passed into the script); this is vital both for
communication with the GUI and for enabling the database to track the
provenance of crystallographic data. The parameters of the script
interface must follow the CCP4i2 data model that has classes for all the
common crystallographic data (well we are working on it!). These
parameters are listed in a <em>DEF</em> file; this is an XML file (see
<a class="reference external" href="#xml_files">appendix</a>) and there is one for each <em>CPluginScript</em>
script file. The <em>DEF</em> can be created by hand-editing but can more
easily be created by the developer using the <em>defEd</em> GUI that provides a
list and documentation for all the classes of the CCP4i2 data model.
Note that the <em>DEF</em> file is a definition of the parameters; it does not
contain the actual values for parameters.</p>
<p>Most <em>CPluginScript</em> scripts are made accessible in the CCP4i2 GUI. The
GUI uses the same data model as the scripts and has widgets to represent
each data class so a GUI for the script can be auto-generated from the
<em>DEF</em> file. The auto-generated GUI is useful for testing purposes; a
better structured and more attractive GUI can be written based on the
<em>DEF</em> file. When a job is run the GUI writes an <em>input_params</em> file that
contains the values of parameters that are passed to the script.</p>
<p>The biggest job in creating a wrapper script is usually generating an
input command file to the program that is correctly formatted and
interprets the parameters passed to the script. The easiest way to do
this is to write a template for the program command file and then use
the <em>CComTemplate</em> class to interpret the template and the script
parameters to create a program command file.</p>
<p>In the CCP4i2 GUI the scripts are referred to as ‘tasks’ and every time
the user runs a task it is called a ‘job’. If a <em>CPluginScript</em> calls
another <em>CPluginScript</em> then this is called a ‘sub-job’. The CCP4I2
database records all jobs and any sub-jobs and the input and output data
for each job. This input and output data is mostly in the form of
references to PDB and MTZ files but other data (usually referred to as
‘extra’ data) is also recorded. The database is notified when a job is
started and when it finishes. When a job starts from the GUI the
database is notified automatically. When a <em>CPluginScript</em> script calls
other scripts it should use the <em>makePluginObject()</em> method that
instantiates the new <em>CPluginScript</em>, passes necessary ‘database’
information to the new object and notifies the database that a sub-job
is started. The completion of jobs is notified by the <em>reportStatus()</em>
method that is called by the base class <em>postProcess()</em> method. The
<em>reportStatus()</em> method also saves the script’s parameters to a <em>PARAMS</em>
file that is read automatically to load the appropriate data to the
database. The <em>PARAMS</em> file has the same format and mostly the same
content as the <em>input_params</em> file but may contain additional ‘output’
information.</p>
<p><em>CPluginScript</em> maintains a list of all errors or warnings generated
within the class or by functions called from the class. This serves as a
complete log - note that it is possible to add ‘error’ reports that are
not an error (severity is SEVERITY_OK).</p>
</section>
<section id="input-and-output-data">
<h2 id="input-and-output-data">Input and Output Data<a class="headerlink" href="#input-and-output-data" title="Permalink to this heading">¶</a></h2>
<p>Firstly to sort out a naming convention. There are two sorts of xml file
that are relvant here: the ‘def’ file is a definition of the parameters
and the ‘params’ file contain actual data for a particular job. I used
to call the ‘params’ file a ‘data’ file but that is confusing with the
real data files such as PDB/MTX.</p>
<p>The contents of a def file are split into three or four sub-containers.
It is very important that data is put in the right sub-container. The
<em>inputData</em> and <em>outputData</em> containers are for the input and output
experimental data and model data. This is usually the PDB and MTZ files
but is also the ‘extra’ data such as NCS and domains which are an
essential part of the description of the model. The <em>controlParameters</em>
subcontainer should contain just about everything else. Parameters
relevant for implementation of the gui go in the <em>guiAdmin</em>
sub-container.</p>
<p>The contents of the <em>inputData</em> and <em>outputData</em> define the <em>signature</em>
of a script and is vital for the correct management of the data in the
overall i2 system. Many programs can have alternative input and output
dependent on the exact function. As a general principle we could say
that the different signatures ought to be treated as different tasks in
CCP4i2 and so should have different wrappers. There are probably good
reasons for not totally enforcing that principle and writing multiple
wrappers is inefficient. See how it goes.</p>
<p>The GUI automatically populates the input data based on the previous
jobs but the user can override this and select files or data. The task
interfaces do not allow the user to set output data - the user can
export (i.e. copy) files after the job is finished. The GUI will write a
params file, <em>whatever.input_params.def.xml</em> that is read by the wrapper
(this is done automatically as the wrapper is instatiated). The names of
output files are set automatically by <em>CPluginScript.checkOutputData()</em>
method that is called as part of the base class <em>process()</em> method and
if you reimplement this then you must ensure that <em>checkOutputData()</em> is
called before <em>makeCommandAndScript()</em>. The <em>makeCommandAndScript()</em>
will pass-on the names of ouput files to the program arguments or input
file. The ouput data that does not go into a file, i.e. the ‘extra’ data
must be handled by the script. What needs doing will depend on the data
and the program but typically files might need to be copied to the
‘correct’ path specified by the <em>outputDta</em> params and other data might
be read from the program log file and loaded into the appropriate
<em>outputData</em> parameters. The updated version of the parameters are
written to a file <em>whatever.params.xml</em> by the
<em>CPluginScript.saveParams()</em> method that is called as part of
<em>CPluginScript.postProcess()</em>. The main GUI process extracts the ouput
data from this file and saves to the database.</p>
<p>It is obviously important to identify the ‘extra’ data that is passed
between programs and to use a standard data model.</p>
</section>
<section id="a-simple-wrapper-example-pdbset">
<h2 id="a-simple-wrapper-example-pdbset">A Simple Wrapper Example - <em>pdbset</em><a class="headerlink" href="#a-simple-wrapper-example-pdbset" title="Permalink to this heading">¶</a></h2>
<p>This wrapper changes the cell parameter in a PDB file using the <em>pdbset</em>
program. (A better way to do this now would use Python interface to
<em>mmdb</em> library). The input to the script is a PDB file name and cell
values. The output is another PDB file name. The DEF file to define the
script parameters is
<a class="reference external" href="../../wrappers/pdbset/script/pdbset.def.xml">$CCP4I2/wrappers/pdbset/script/pdbset.def.xml</a>
which contains (excluding the meta-data header):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">container</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"inputData"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">content</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"XYZIN"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">className</span><span class="o">&gt;</span><span class="n">CPdbDataFile</span><span class="o">&lt;/</span><span class="n">className</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">qualifiers</span><span class="o">&gt;</span>
       <span class="o">&lt;</span><span class="n">mustExist</span><span class="o">&gt;</span><span class="kc">True</span><span class="o">&lt;/</span><span class="n">mustExist</span><span class="o">&gt;</span>
    <span class="o">&lt;/</span><span class="n">qualifiers</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">content</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">content</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"CELL"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">className</span><span class="o">&gt;</span><span class="n">CCell</span><span class="o">&lt;/</span><span class="n">className</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">content</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">container</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">container</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"outputData"</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">content</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"XYZOUT"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">className</span><span class="o">&gt;</span><span class="n">CPdbDataFile</span><span class="o">&lt;/</span><span class="n">className</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">content</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">container</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">container</span> <span class="nb">id</span><span class="o">=</span><span class="s2">"controlParameters"</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">container</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The two important types of element in this XML are &lt;container&gt; and
&lt;content&gt;. The <em>container</em> is used to group together the parameters into
three groups: <em>inputData</em>, <em>controlParameters</em> and <em>outputData</em> (this
example does not have any <em>controlParameters</em>). The <em>content</em> elements
specify the name (as the id attribute), data class (as <em>className</em>
element), and <em>qualifiers</em> for each parameter. So, for example, the
<em>XYZIN</em> parameter is class <em>CPdbDataFile</em> and has a qualifier
<em>mustExist</em> that is <em>True</em> (which means the file must exist for the the
<em>CPdbDataFile</em> to be valid). A file like this can be created using the
<em>defEd</em> GUI.</p>
<p>When a script is run from CCP4i2 a <em>input_params</em> parameter file is
created by the GUI and for <em>pdbset</em> has the form (excluding the
meta-data header):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">inputData</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">XYZIN</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">project</span><span class="o">&gt;</span><span class="n">my_project</span><span class="o">&lt;/</span><span class="n">project</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">baseName</span><span class="o">&gt;</span><span class="n">broken</span><span class="o">.</span><span class="n">pdb</span><span class="o">&lt;/</span><span class="n">baseName</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">relPath</span><span class="o">/&gt;</span>
  <span class="o">&lt;/</span><span class="n">XYZIN</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">CELL</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">a</span><span class="o">&gt;</span><span class="mf">64.897</span><span class="o">&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">b</span><span class="o">&gt;</span><span class="mf">78.323</span><span class="o">&lt;/</span><span class="n">b</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">c</span><span class="o">&gt;</span><span class="mf">38.792</span><span class="o">&lt;/</span><span class="n">c</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">alpha</span><span class="o">&gt;</span><span class="mf">90.0</span><span class="o">&lt;/</span><span class="n">alpha</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">beta</span><span class="o">&gt;</span><span class="mf">90.0</span><span class="o">&lt;/</span><span class="n">beta</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">gamma</span><span class="o">&gt;</span><span class="mf">90.0</span><span class="o">&lt;/</span><span class="n">gamma</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">CELL</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">inputData</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">outputData</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">XYZOUT</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">project</span><span class="o">&gt;&lt;/</span><span class="n">project</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">baseName</span><span class="o">&gt;&lt;/</span><span class="n">baseName</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">relPath</span><span class="o">&gt;&lt;/</span><span class="n">relPath</span><span class="o">&gt;</span>
  <span class="o">&lt;/</span><span class="n">XYZOUT</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">outputData</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">controlParameters</span><span class="o">/&gt;</span>
</pre></div>
</div>
<p>This file follows the structure specified in the DEF file with
containers <em>&lt;inputData&gt;</em>and <em>&lt;outputData&gt;</em>, and parameters XYZIN, CELL
and XYZOUT. Note that no value has been given for XYZOUT.</p>
<p>The actual script to run <em>pdbset</em> is in the file
<a class="reference external" href="../../wrappers/pdbset/script/pdbset.py">$CCP4I2/wrappers/pdbset/script/pdbset.py</a>
and is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">core.CCP4PluginScript</span> <span class="kn">import</span> <span class="n">CPluginScript</span>

<span class="k">class</span> <span class="nc">pdbset</span><span class="p">(</span><span class="n">CPluginScript</span><span class="p">):</span>

    <span class="n">TASKMODULE</span> <span class="o">=</span> <span class="s1">'utility'</span>
    <span class="n">TASKTITLE</span> <span class="o">=</span> <span class="s1">'PDBSet'</span>
    <span class="n">TASKNAME</span> <span class="o">=</span> <span class="s1">'pdbset'</span>
    <span class="n">TASKCOMMAND</span> <span class="o">=</span> <span class="s1">'pdbset'</span>
    <span class="n">TASKVERSION</span><span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">COMLINETEMPLATE</span> <span class="o">=</span> <span class="s1">'''1 XYZIN $XYZIN XYZOUT $XYZOUT'''</span>
    <span class="n">COMTEMPLATE</span> <span class="o">=</span> <span class="s1">'''1 CELL $CELL.a $CELL.b $CELL.c $CELL.alpha $CELL.beta $CELL.gamma</span>
<span class="s1">1 END'''</span>
</pre></div>
</div>
<p>The <em>pdbset</em> class is a sub-class of <em>CPluginScript</em> and requires only
that some class attributes are set for the base class methods to do the
all the work. The class attribute TASKMODULE and TASKTITLE specify how
the script appears in the GUI and TASKVERSION is a version for the
script. Information to run the program is: TASKCOMMAND - the name of the
executable; COMLINETEMPLATE - a template for the command line;
COMTEMPLATE - a template for the program command file. The templates are
described in more detail <a class="reference external" href="./command_templates.html">here</a> but two
important point:</p>
<ul class="simple">
<li><p>The first word on a line is evaluated (it could be a parameter or a
short Python script) and if it is true then the line is written to
the command file.</p></li>
<li><p>Any word beginning with $ is substituted by the value of the
parameter.</p></li>
</ul>
</section>
<section id="the-main-cpluginscript-methods">
<h2 id="the-main-cpluginscript-methods">The main <em>CPluginScript</em> methods<a class="headerlink" href="#the-main-cpluginscript-methods" title="Permalink to this heading">¶</a></h2>
<p>The <em>CPluginScript.__init__()</em> method creates a container (a
<a class="reference external" href="./data_classes.html#containers">CContainer</a> object) and reads the
script’s DEF file to specify the allowed contents of the container; note
that this does not specify the actual parameter values. The parameter
values can be passed to the container programmatically (if the script is
been run from another pipeline script) or are read from a file. When a
script is run from CCP4i2 a PARAMS file (<em>input_params.xml</em>) is created
by the GUI and loaded by the <em>CPluginScript.__init__()</em> method.</p>
<p>The <em>CPluginScript.process()</em> method does most of the work. It calls the
following methods:</p>
<ul class="simple">
<li><p><em>checkInputData()</em> - checks that data in the <em>inputData</em> container is
valid and will cause the script to fail if it is not so. Particularly
this checks that the input files exist and return a list of invalid
file parameters.</p></li>
<li><p><em>checkOutputData()</em> - checks that output files have valid names.
Usually the GUI does not provide output file names and this method
will set appropriate file names. This method is expected to fix
things and not cause the script to fail.</p></li>
<li><p><em>processInputFiles()</em> - The base class method does nothing but many
scripts will need to reimplement this method - see below.</p></li>
<li><p><em>makeCommandAndScript()</em> - The base class method uses the
COMLINETEMPLATE and COMTEMPLATE templates to generate the program
command line and command file. As an alternative to providing these
templates a script developer can reimplement the
<em>makeCommandAndScript()</em> method.</p></li>
<li><p><em>startProcess()</em> - uses the PROCESSMANAGER module to start the
program executable specified by TASKCOMMAND in another process. The
command line and file create by <em>makeCommandAndScript()</em> are
used.This is reimplemented for classes that do not run an external
process.</p></li>
</ul>
<p>When the program run is finished the <em>postProcess()</em> method is called.
This calls three other methods:</p>
<ul class="simple">
<li><p><em>postProcessCheck()</em> - retrieves information from the PROCESSMANAGER
to find out if the program process ran successfully. It returns
CPluginScript.SUCCEEDED or CPluginScript.FAILED.</p></li>
<li><p><em>processOutputFiles()</em> - The base class method does nothing but many
scripts will need to reimplement this method - see below.</p></li>
<li><p><em>reportStatus()</em> - this does three things:</p>
<ul>
<li><p>Saves the parameters from the container to a PARAMS file. These
parameters will be similar to the <em>input_params</em> file, if it
exists, but could include output file names added by
<em>checkOutputData()</em> or any changes to parameters made by more
sophisticated scripts.</p></li>
<li><p>Reports the jobs completion to the database.</p></li>
<li><p>Emits a signal to say it has finished that may be received by a
controlling pipeline script.</p></li>
</ul>
</li>
</ul>
<p>Normally a wrapper may need to reimplement:</p>
<ul class="simple">
<li><p><em>processInputFiles()</em> to perform any manipulations on input data or
files before calling the main program</p></li>
<li><p><em>processOutputFiles()</em> to perform any manipulations on output data or
files after the program has run</p></li>
<li><p><em>makeCommandAndScript()</em> to create the command line and script that
will run the program</p></li>
</ul>
<p>All of these methods must return either <em>CPluginScript.SUCCEEDED</em> or
<em>CPluginScript.FAILED</em> which will determine whether the script will
continue running or will abort. There is a third possible return status
for <em>processOutputFiles()</em>: <em>CPluginScript.UNSATISFACTORY</em> for when the
job has run without error but not produced a useful result. This return
flag leads to an ‘Unsatisifactory’ database status for the job and the
job is presented differently in the GUI: the icon on the Job List
indicates it is unsatisfactory but the normal job report is presented
(rather than the generic failed job report.). The job report creation
code is initialised with the status flag ‘Unsatisfactory’ and should
provide an appropriate report.</p>
<p>For pipelines it is necessary to reimplement the <em>process()</em> method to
call the sub-tasks but it should not be necessary to re-implement
<em>process()</em> or <em>postProcess()</em> methods for wrappers. If you have a
wrapper issue that can not be addressed with the three methods above
please talk to Liz.</p>
<p>The CPluginScript process handling will handle the case of an externally
run program clearly failing (i.e. the Process Manager has a ‘failed’
error code - see <a class="reference external" href="#process_manager">the Process Manager appendix</a> but
does not check the exit status of the external process as the output
from differnt programs is unpredictable. The task implementer can do
this in the <em>processOutputFiles()</em> method and should make an error
report before returning a CPluginScipt.FAILED:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">core.CCP4Modules</span> <span class="kn">import</span> <span class="n">PROCESSMANAGER</span>

<span class="k">class</span> <span class="nc">myPluginScript</span><span class="p">(</span><span class="n">CPluginScript</span><span class="p">):</span>
  <span class="n">ERROR_CODES</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">201</span> <span class="p">:</span> <span class="p">{</span><span class="s1">'description'</span> <span class="p">:</span> <span class="s1">'My program failed with error code'</span> <span class="p">}</span> <span class="p">}</span>

  <span class="o">...</span>

  <span class="k">def</span> <span class="nf">processOutputFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">exitStatus</span> <span class="o">=</span> <span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">getJobData</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">getProcessId</span><span class="p">(),</span><span class="n">attribute</span><span class="o">=</span><span class="s1">'exitStatus'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">exitStatus</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>     <span class="c1">#Beware what is expect from given program and os?</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">appendErrorReport</span><span class="p">(</span><span class="mi">201</span><span class="p">,</span><span class="s1">'Exit status: '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exitStatus</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">CPluginScipt</span><span class="o">.</span><span class="n">FAILED</span>

    <span class="o">....</span>
</pre></div>
</div>
<p>See also the <a class="reference external" href="./error_handling.html#plugins">error handling in
plugins</a>.</p>
</section>
<section id="a-simple-pipeline-example-demo-copycell">
<h2 id="a-simple-pipeline-example-demo-copycell">A Simple Pipeline Example - <em>demo_copycell</em><a class="headerlink" href="#a-simple-pipeline-example-demo-copycell" title="Permalink to this heading">¶</a></h2>
<p>This is a demo of the usual <em>mtzdump</em> and <em>pdbset</em> pipeline that uses
<em>mtzdump</em> to extract the cell parameters from an MTZ file and <em>pdbset</em>
to set these cell parameters in a PDB file. This would not be the
recommended way to achieve this result - there are much simpler Python
tools! To run this script from the gui tick the preferences check-box:
<code class="docutils literal notranslate"><span class="pre">Preferences</span> <span class="pre">-&gt;</span> <span class="pre">Advanced</span> <span class="pre">-&gt;</span> <span class="pre">Show</span> <span class="pre">testing/development</span> <span class="pre">tasks</span></code>
so the <em>Demo copy
cell</em> task is displayed in the <em>Test code for developers only</em> module at
the bottom of the <em>Task menu</em>. Note this script does not have a good
report generator so there is no report.</p>
<p>The code is in
<a class="reference external" href="../../wrappers2/demo_copycell/script/demo_copycell.py">$CCP4I2/wrappers2/demo_copycell/script/demo_copycell.py</a>
and looks like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">demo_copycell</span><span class="p">(</span><span class="n">CPluginScript</span><span class="p">):</span>

    <span class="n">TASKMODULE</span> <span class="o">=</span> <span class="s1">'utility'</span>
    <span class="n">TASKTITLE</span> <span class="o">=</span> <span class="s1">'Demo copy cell'</span>
    <span class="n">TASKNAME</span> <span class="o">=</span> <span class="s1">'demo_copycell'</span>
    <span class="n">TASKVERSION</span><span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ASYNCHRONOUS</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

      <span class="c1"># Check all input files exist</span>
      <span class="n">nonExFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkInputData</span><span class="p">()</span>
      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonExFiles</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">)</span>
        <span class="k">return</span>

      <span class="c1"># Provide default output file names if necessary</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">checkOutputData</span><span class="p">()</span>

      <span class="c1"># Create instance of mtzdump class (and get it registered with the database)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePluginObject</span><span class="p">(</span><span class="s1">'mtzdump'</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">HKLIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">HKLIN</span>
      <span class="c1"># Run mtzdump to get the cell parameters</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">connectSignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="p">,</span><span class="s1">'finished'</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">process_1</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
<p>The TASKMODULE and TASKTITLE attributes are provided so the script can
be placed in the GUI but there are no TASKCOMMAND, COMTEMPLATE or
COMLINETEMPLATE attributes defined. The <em>process()</em> method calls
<em>checkInputData()</em> and <em>checkOutputData()</em>. <em>checkInputData()</em> returns a
list of names of non-existant input files. If this list has length
greater than zero then <em>reportStatus()</em> is called with a failed status
and the method returns. An instance of <em>mtzdump</em> is created using the
<em>makePluginObject()</em> method. The only data <em>mtzdump</em> needs is the input
MTZ file, HKLIN; this parameter value is copied from the <em>demo_copycell</em>
container to the <em>mtzdump</em> container. Before running <em>mtzdump.process()</em>
the <em>self.connectSignal()</em> method is called to ensure that when
<em>mtzdump</em> finishes (and emits a finished signal) the next method in the
pipeline (<em>process_1()</em>) is called.</p>
<p>When mtzdump finishes (by calling <em>postProcess()</em>) it emits a signal
with an additional status parameter that is either
<em>CPluginScript.SUCCEEDED</em> or <em>CPluginScript.FAILED</em>. The
<em>demo_copycell.process_1</em> has an argument for the status:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">self</span><span class="o">.</span><span class="n">process_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">status</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">return</span>

  <span class="c1"># Create an instance of pdbset and copy parameters</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePluginObject</span><span class="p">(</span><span class="s1">'pdbset'</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">XYZIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">XYZIN</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">CELL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">CELL</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">XYZOUT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">XYZOUT</span>

  <span class="c1"># run pdbset</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">connectSignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="p">,</span><span class="s1">'finished'</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">postProcessWrapper</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
</pre></div>
</div>
<p><em>process_1()</em> first checks the wrapper exit status and finishes if the
wrapper failed. It then creates an instance of the <em>pdbset</em> wrapper and
copies the appropriate parameter values to the pdbset container. It then
runs the <em>pdbset.process()</em> method after connecting the finish signal to
the <em>CPluginScript.postProcessWrapper()</em> method. <em>postProcessWrapper()</em>
accepts the exit status from the wrapper and finishes the pipeline
appropriately.</p>
<p>The above script runs asynchronously - after the <em>mtzdump</em> and pdbset
sub-tasks are started by calling <em>process()</em> it does not wait for then
to complete. This is discussed further <a class="reference external" href="#running%20processes">below</a>.
The alternative approach of would lead to simpler code with only one
<em>process()</em> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ASYNCHRONOUS</span><span class="o">=</span><span class="kc">False</span>

<span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

  <span class="c1"># Check all input files exist</span>
  <span class="n">nonExFiles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkInputData</span><span class="p">()</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonExFiles</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">)</span>
    <span class="k">return</span>

  <span class="c1"># Provide default output file names if necessary</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">checkOutputData</span><span class="p">()</span>

  <span class="c1"># Create instance of mtzdump class (and get it registered with the database)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePluginObject</span><span class="p">(</span><span class="s1">'mtzdump'</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">HKLIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">HKLIN</span>
  <span class="c1"># Run mtzdump to get the cell parameters</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">return</span>

  <span class="c1"># Create an instance of pdbset and copy parameters</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePluginObject</span><span class="p">(</span><span class="s1">'pdbset'</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">XYZIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">XYZIN</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">CELL</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mtzdump</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">CELL</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">XYZOUT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">XYZOUT</span>

  <span class="c1"># run pdbset</span>
  <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
    <span class="k">return</span>

  <span class="k">return</span> <span class="n">CPluginScript</span><span class="o">.</span><span class="n">SUCEEDED</span>
</pre></div>
</div>
<p>Here the <em>ASYNCHRONOUS</em> attribute is set <em>False</em> to inform the core
system how to run this and there is not need for calls to
<em>connectSignal()</em>. The sub-task <em>process()</em> method returns a status
flag, either <em>FAILED</em> or <em>SUCCEEDED</em> and if this is <em>FAILED</em> then the
pipeline should either handle the problem or terminate itself by calling
<em>self.reportStatus(status)</em>. The <em>process()</em> method itself should return
<em>SUCCEEDED</em> or <em>FAILED</em>.</p>
</section>
<section id="pipeline-and-wrapper-file-organisation">
<h2 id="pipeline-and-wrapper-file-organisation">Pipeline and Wrapper File Organisation<a class="headerlink" href="#pipeline-and-wrapper-file-organisation" title="Permalink to this heading">¶</a></h2>
<p>The CCP4I2 directory has a <em>wrapper</em> sub-directory to which can be added
wrapper scripts. Each script has its own directory with <em>script</em> and
<em>test_data</em> sub-directories. The script directory should contain a
<em>wrapper</em>.py file containing the <em>CPluginScript</em> script and a
<em>wrapper</em>.def.xml file. There is a <em>test_data</em> directory for any data
needed to test the script. So the part of the <em>wrapper</em> directory for
the two demo wrappers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ccp4i2</span> <span class="o">-</span> <span class="n">wrappers</span> <span class="o">-</span> <span class="n">mtzdump</span> <span class="o">-</span> <span class="n">script</span> <span class="o">----</span> <span class="n">mtzdump</span><span class="o">.</span><span class="n">py</span>
                 <span class="o">|</span>         <span class="o">|</span>        <span class="o">|</span>
                 <span class="o">|</span>         <span class="o">|</span>         <span class="o">----</span> <span class="n">mtzdump</span><span class="o">.</span><span class="n">def</span><span class="o">.</span><span class="n">xml</span>
                 <span class="o">|</span>         <span class="o">|</span>
                 <span class="o">|</span>          <span class="o">-</span> <span class="n">test_data</span> <span class="o">-</span> <span class="n">gere_nat</span><span class="o">.</span><span class="n">mtz</span>
                 <span class="o">|</span>                     <span class="o">|</span>
                 <span class="o">|</span>                      <span class="o">-</span> <span class="n">mtzdump</span><span class="o">.</span><span class="n">xml</span>
                 <span class="o">|</span>
                  <span class="o">--</span> <span class="n">pdbset</span> <span class="o">-</span> <span class="n">script</span> <span class="o">----</span> <span class="n">pdbset</span><span class="o">.</span><span class="n">py</span>
                           <span class="o">|</span>        <span class="o">|</span>
                           <span class="o">|</span>         <span class="o">----</span> <span class="n">pdbset</span><span class="o">.</span><span class="n">def</span><span class="o">.</span><span class="n">xml</span>
                           <span class="o">|</span>
                             <span class="o">-</span> <span class="n">test_data</span> <span class="o">-</span> <span class="mi">1</span><span class="n">df7</span><span class="o">.</span><span class="n">pdb</span>
</pre></div>
</div>
<p>There is a slightly more complicated directory structure for pipelines
which should allow for developers’ more varied requirements when
developing a pipeline. The <em>defEd</em> utility will create the directory
structure for a new wrapper or pipeline (look under the <em>Tools</em> menu).</p>
<p>There is no technical difference between the <em>wrappers</em> and <em>pipelines</em>
directories but the understanding that developers are encouraged to use
code in <em>wrappers</em> and extend its functionality if necessary. There is
also a <em>wrappers2</em> directory for some unconventional wrappers used by
the core system.</p>
</section>
<section id="unittests-for-wrappers-and-pipelines">
<h2 id="unittests-for-wrappers-and-pipelines">Unittests for Wrappers and Pipelines<a class="headerlink" href="#unittests-for-wrappers-and-pipelines" title="Permalink to this heading">¶</a></h2>
<p>Unittests are useful for testing the non-graphical scripts particularly
while in development but <a class="reference external" href="./project_based_testing.html">project based
testing</a> is now preferred.</p>
<p>The CCP4i2 core code uses the standard Python <em>unittest</em> module for
testing (see the <a class="reference external" href="http://docs.python.org/release/2.6.6/library/unittest.html">Python
documentation</a>).
There are currently a couple of issues to running a <em>CPluginScript</em>s
in <em>unittest</em>:</p>
<ul class="simple">
<li><p><em>CPluginScript</em> requires that Qt <em>QApplication</em> is created</p></li>
<li><p>The default mode for the PROCESSMANAGER running a process is
asynchronously - this does not play nicely with <em>unittest</em> so it must
be set to ‘wait for finish’ mode.</p></li>
</ul>
<p>These issues can be addressed by using the <em>unittest.TestCase.setUp()</em>
and <em>unittest.TestCase.tearDown()</em> methods thus:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
 <span class="c1"># Create a Qt application</span>
 <span class="kn">from</span> <span class="nn">core.CCP4Modules</span> <span class="kn">import</span> <span class="n">QTAPPLICATION</span><span class="p">,</span><span class="n">PROCESSMANAGER</span>
 <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">QTAPPLICATION</span><span class="p">()</span>
 <span class="c1"># make all background jobs wait for completion</span>
 <span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">setWaitForFinished</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
 <span class="kn">from</span> <span class="nn">core.CCP4Modules</span> <span class="kn">import</span> <span class="n">PROCESSMANAGER</span>
 <span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">setWaitForFinished</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>To ensure portability of the tests you need to avoid any fixed filepaths
in your tests. Please use a ‘standard’ temporary work directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Utils</span>
<span class="n">workDirectory</span> <span class="o">=</span> <span class="n">CCP4Utils</span><span class="o">.</span><span class="n">getTestTmpDir</span><span class="p">()</span>
</pre></div>
</div>
<p>This will set <em>workDirectory</em> to your $HOME/ccp4i2_test. If this
directory does not exist then it will be created. If you do not like
this choice of directory then edit your local copy of CCP4Utils.</p>
<p>Typically the test code at the bottom of a pipeline module will look
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span><span class="o">,</span><span class="nn">os</span>

<span class="k">class</span> <span class="nc">test_my_pipeline</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

   <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Modules</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">QTAPPLICATION</span><span class="p">()</span>
    <span class="c1"># make all background jobs wait for completion</span>
    <span class="c1"># this is essential for unittest to work</span>
    <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">setWaitForFinished</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Modules</span>
    <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">setWaitForFinished</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

   <span class="k">def</span> <span class="nf">test_1</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Modules</span><span class="p">,</span> <span class="n">CCP4Utils</span>
     <span class="kn">import</span> <span class="nn">os</span>

     <span class="n">workDirectory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CCP4Utils</span><span class="o">.</span><span class="n">getTestTmpDir</span><span class="p">(),</span><span class="s1">'test1'</span><span class="p">)</span>
     <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">workDirectory</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">workDirectory</span><span class="p">)</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span> <span class="o">=</span> <span class="n">my_pipeline</span><span class="p">(</span><span class="n">parent</span><span class="o">=</span><span class="n">CCP4Modules</span><span class="o">.</span><span class="n">QTAPPLICATION</span><span class="p">(),</span><span class="n">name</span><span class="o">=</span><span class="s1">'test1'</span><span class="p">,</span><span class="n">workDirectory</span><span class="o">=</span><span class="n">workDirectory</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">loadDataFromXml</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">CCP4Utils</span><span class="o">.</span><span class="n">getCCP4I2Dir</span><span class="p">(),</span><span class="s1">'pipelines'</span><span class="p">,</span><span class="s1">'my_pipeline'</span><span class="p">,</span><span class="s1">'test_data'</span><span class="p">,</span><span class="s1">'test1.data.xml'</span><span class="p">))</span>

     <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">setWaitForFinished</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span>
     <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">setWaitForFinished</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">errorReport</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span> <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">errorReport</span><span class="o">.</span><span class="n">report</span><span class="p">()</span>
     <span class="c1">#test exit status correct</span>
     <span class="n">exitStatus</span> <span class="o">=</span> <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">getJobData</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span><span class="s1">'exitStatus'</span><span class="p">)</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">exitStatus</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s1">'Process exit status non-zero: '</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">exitStatus</span><span class="p">))</span>
     <span class="c1">#test if output file created</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">HKLOUT</span><span class="p">)</span> <span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="s1">'Failed to create copied pdb file '</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wrapper</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">HKLOUT</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">TESTSUITE</span><span class="p">():</span>
  <span class="n">suite</span> <span class="o">=</span> <span class="n">unittest</span><span class="o">.</span><span class="n">TestLoader</span><span class="p">()</span><span class="o">.</span><span class="n">loadTestsFromTestCase</span><span class="p">(</span><span class="n">test_my_pipeline</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">suite</span>

<span class="k">def</span> <span class="nf">testModule</span><span class="p">():</span>
  <span class="n">suite</span> <span class="o">=</span> <span class="n">TESTSUITE</span><span class="p">()</span>
  <span class="n">unittest</span><span class="o">.</span><span class="n">TextTestRunner</span><span class="p">(</span><span class="n">verbosity</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">suite</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>unittest</em> sub-class <em>test_my_pipeline</em> has one or more methods
called <em>test_*</em> which each perform one test. They do this by
instantiating a plugin, loading suitable test data, calling the
<em>process()</em> method to run the plugin and then testing that the plugin
has run sucessfully. In this example the input data for <em>test_1</em> come
from a ‘PARAMS’ xml file (called ..my_pipeline/test_data/test1.data.xml
in the example code) that is loaded into the wrapper container by the
<em>loadDataFromXml()</em> method. Typically such a file could be set up by
using the GUI to run <em>my_pipeline</em> and then looking in the job directory
for the <em>input_params.xml</em> file and copying it (along with any input
data files) to the wrapper/pipeline <em>test_data</em> directory. The ‘PARAMS’
xml file will probably need to be editted to set the appropriate paths
for input and output files. An input file will be in the CCP4I2 source
code tree and should have <em>project</em> set to <em>CCP4I2</em> (which will find the
the CCP4I2 root directory) and <em>relpath</em> set to the path to the
<em>test_data</em> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">HKLIN</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">project</span><span class="o">&gt;</span><span class="n">CCP4I2</span><span class="o">&lt;/</span><span class="n">project</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">relPath</span><span class="o">&gt;</span><span class="n">pipelines</span><span class="o">/</span><span class="n">my_pipeline</span><span class="o">/</span><span class="n">test_data</span><span class="o">&lt;/</span><span class="n">relPath</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">baseName</span><span class="o">&gt;</span><span class="n">whatsit</span><span class="o">.</span><span class="n">mtz</span><span class="o">&lt;/</span><span class="n">baseName</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">HKLIN</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>And for an output files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">HKLOUT</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">project</span><span class="o">&gt;</span><span class="n">CCP4I2_TEST</span><span class="o">&lt;/</span><span class="n">project</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="n">baseName</span><span class="o">&gt;</span><span class="n">whatsit</span><span class="o">.</span><span class="n">mtz</span><span class="o">&lt;/</span><span class="n">baseName</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">HKLOUT</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>CCP4I2_TEST is the ‘temporary’ directory returned by
CCP4Utils.getTestTmpDir().</p>
<p>The <em>unittest</em> documentation describes the test methods such as
<em>assertEqual()</em> and typically a plugin test could check the return codes
from the process and check that output files exist.</p>
<p>The sub-class of <em>unittest</em> (<em>test_my_pipeline</em> in the example above)
does the real work but in the code above there are two extra functions:
<strong>TESTSUITE()</strong> which should return the suite of tests and is used by
the CCP4i2 overall test mechanism to find the test suite for that
module. You could possibly have additional tests that are not returned
by <em>TESTSUITE()</em> but those that are returned are part of CCP4i2 release
tests. <strong>testModule()</strong> is a non-essential utility that can make running
the module test from the Python prompt very quick:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;</span> <span class="kn">import</span> <span class="nn">my_pipeline</span>
<span class="o">&gt;</span> <span class="n">my_pipeline</span><span class="o">.</span><span class="n">testModule</span><span class="p">()</span>
</pre></div>
</div>
<p>The script to run all the CCP4i2 module tests is <em>$CCP4I2/bin/runtest</em>
which will search all of the <em>wrappers</em> and <em>pipeline</em> directories for
<em>TESTSUITE()</em> functions and run them. The <em>runtest</em> script ignores
scripts which specify their <em>TASKMODULE</em> as <em>demo</em> or <em>test</em> but reports
any other module that does not have a <em>TESTSUITE()</em> function.</p>
</section>
<section id="testing-and-debugging-scripts">
<h2 id="testing-and-debugging-scripts">Testing and Debugging Scripts<a class="headerlink" href="#testing-and-debugging-scripts" title="Permalink to this heading">¶</a></h2>
<p>If a job fails when run from the gui the key diagnostic should be
presented in a report page; otherwise check in the <em>Project directory</em>
view on the gui where you can see the job directory and should look at
the <em>stout.txt</em>, <em>stderr.txt</em> and <em>diagnostic.xml</em> files. The
<em>diagnostic.xml</em> file lists all Python exceptions from the script.</p>
<p>It is possible to run scripts and external programs from the console.
After you have attempted to run a script from the gui there will be a
job directory in the project directory (<em>project_path/CCP4_JOBS/job_nnn</em>
where nnn is the job number listed in the gui) and this contains an
input params file (<em>input_params.xml</em>). To rerun the script with these
input parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; $CCP4I2_TOP/bin/runTask project_path/CCP4_JOBS/job_nnn/input_params.xml
</pre></div>
</div>
<p>Note that as this script is run it will update the database and progress
will be shown if the gui is open. Beware that rerunning jobs may have
the potential for confusing the database so avoid doing this in
important projects.</p>
<p>It is also possible to start the external process (i.e. running the
program) from a Python console. The stdout from the script will list
calls to the PROCESSMANAGER().startProcess() method that runs the
wrapped program as an external process. The stdout output is formatted
so that you can just cut-n-paste to rerun the external process from the
ccp4i2 Python prompt, <em>ccp4i2/bin/pyi2</em> (see <a class="reference external" href="./introduction.html#console">Console
mode</a>). The command will look something
like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">startProcess</span><span class="p">(</span><span class="s2">"cbuccaneer"</span><span class="p">,</span> <span class="p">[</span><span class="s2">"-stdin"</span><span class="p">],</span> <span class="s2">"/Users/lizp/Desktop/test_projects/t3/CCP4_JOBS/job_127/com.txt"</span><span class="p">,</span> <span class="s2">"/Users/lizp/Desktop/test_projects/t3/CCP4_JOBS/job_127/log.txt"</span><span class="p">)</span>
</pre></div>
</div>
<p>The arguments to startProcess() are:</p>
<p><strong>executable</strong> - the executable to run</p>
<p><strong>args</strong> - the command line arguments as a Python list of single words</p>
<p><strong>inputFile</strong> - a command file</p>
<p><strong>logFile</strong> - the output log file</p>
</section>
<section id="buccaneer-a-realistic-example-wrapper">
<h2 id="buccaneer-a-realistic-example-wrapper">Buccaneer - a realistic example wrapper<a class="headerlink" href="#buccaneer-a-realistic-example-wrapper" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">See the <a class="reference external" href="../../wrappers/buccaneer/script/buccaneer.py">buccaneer
script</a>. This
re-implements three methods (in the order that they are called):</div>
<div class="line"><em>processInputFiles()</em> which convert the input data files into a form
suitable for the wrapped program particularly using <em>makeHklin()</em> to
convert mini-MTZs to a single input MTZ</div>
<div class="line"><em>makeCommandAndScript()</em> creates the command line and command file for
the program</div>
<div class="line"><em>processOutputFiles()</em> converts the files output by the program to the
standard forms of CCP4i2. It should also add appropriate default
<em>CDataFile.annotation</em> (i.e. the label for a file that is seen in the
gui) and appropriate <em>contentFlag</em> and <em>subType</em> attributes to the
output mini-MTZ data objects.</div>
</div>
<p>Note that it should be unnecessary to re-implement the more generic and
complex <em>process()</em> and <em>postProcess()</em> methods for wrappers. If you
have a wrapper issue that can not be addressed with these three methods
please talk to Liz. But pipelines do need the <em>process()</em> method
re-implementing.</p>
<p>Also note that all of these methods must return either
<em>CPluginScript.SUCCEEDED</em> or <em>CPluginScript.FAILED</em> which will determine
whether the script will continue running or will abort.</p>
</section>
<section id="handling-mini-mtzs">
<h2 id="handling-mini-mtzs">Handling Mini-MTZs<a class="headerlink" href="#handling-mini-mtzs" title="Permalink to this heading">¶</a></h2>
<p>Please read the user’s introduction to mini-MTZs
<a class="reference external" href="../general/miniMTZs.html">here</a>. Each mini-MTZ contains 1 to 4 data
columns to provide one consistent group of data and should never contain
anything else. The columns in the mini-MTZ always have the same
conventional names and types.</p>
<p>There is a CCP4XtalData.CMiniMtzDataFile sub-class of CCP4File.CDataFile
to handle mini-MTZs. This is further subclassed to <em>CObsDataFile</em>
(observed SFs or intensities), <em>CPhsDataFile</em> (phases represented as HL
or phi/fom), <em>CMapCoeffsDataFile</em> (F/phi map coeficients) and
<em>CFreeRDataFile</em>.</p>
<p>Two additional parameters have been added to the <em>CDataFile</em> class to
keep track of the content of miniMTZs:</p>
<ul class="simple">
<li><p><em>contentFlag</em> flags the representation and currently only applies to
<em>CObsDataFile</em> and <em>CPhsDataFile</em> and the allowed values are listed
in those classes (see below).</p></li>
<li><p><em>subType</em> (not yet fully implemented) flags the provenance of the
data (e.g. observed or calculated) and will be used to guide
appropriate use of the data.</p></li>
</ul>
<p>Note that other, non-MTZ files also have these parameters which might be
put to use some time in the future. There are also two additional
columns in the <em>Files</em> table of the database holding the same
information.</p>
<div class="line-block">
<div class="line">These CMiniMtzDataFile classes also have several attributes that
wrapper developers may need to access:</div>
<div class="line"><em>CONTENT_FLAG_xxxx</em> An allowed value for CMiniMtzDataFile.contentFlag
parameter indicating a particular representation in the file</div>
<div class="line"><em>CONTENT_SIGNATURE_LIST</em> a list of the conventional column names</div>
<div class="line"><em>SUBTYPE_xxxx</em>An allowed value for CMiniMtzDataFile.subType
parameter which has slightly different meaning for the different data
types but generally indicates the provenance of the data.</div>
</div>
<p>CCP4 intends to move to using mini-MTZs but as few programs currently
support this way of working it is necessary for program wrappers to
convert multiple mini-MTZs to and from a single MTZ that is the usual
input to or output from a program. This should be done in the wrappers
re-implementation of <em>CPluginScript.processInputFiles()</em> and
<em>CPluginScript.processOutputFiles()</em>. There are two methods to help with
this conversion:</p>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>CPluginScript method</p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>makeHklin</p></td>
<td></td>
<td><p>Merge two or more
mini-MTZs to make an
‘HKLIN’ file</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>miniMtzsIn</p></td>
<td><p>A list of either: the
names of
<em>CMiniMtzDataFile</em>
objects in the
<em>c
ontainer.inputParams</em>
or a sub-list of the
<em>CMiniMtzDataFile</em>
name and the required
representation type
(i.e. a
<em>CONTENT_FLAG_xxxx</em>
value).</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>hklin</p></td>
<td><p>The basename of the
output mtz - default
‘hklin’</p></td>
</tr>
<tr class="row-odd"><td><p>splitHklout</p></td>
<td></td>
<td><p>Split an ‘HKLOUT’
file to multiple
mini-MTZs</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>miniMtzsOut</p></td>
<td><p>A list of the names
of <em>CMiniMtzDataFile</em>
objects in the
<em>co
ntainer.outputParams</em></p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>programColumnNames</p></td>
<td><p>A list of lists of
column names in the
‘’HKLOUT’ file
specifying the
columns to copy to
the files in
<em>miniMtzsOut</em> list</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>inFile</p></td>
<td><p>Name of the ‘HKLOUT’
file - defaults to
<em>working
Directory/hklout.mtz</em></p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>logFile</p></td>
<td><p>Name of the log file
for program runs -
defaults to
<em>workingDi
rectory/splitmtz.log</em></p></td>
</tr>
<tr class="row-even"><td><p>splitHkloutList</p></td>
<td></td>
<td><p>Split a list of
‘HKLOUT’ files to
mini-MTZs (see
phaser_mr.py for
example)</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>miniMtzsOut</p></td>
<td><p>A list of the names
of <em>CMiniMtzDataFile</em>
objects in the
<em>co
ntainer.outputParams</em></p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>programColumnNames</p></td>
<td><p>A list of lists of
column names in the
‘’HKLOUT’ file
specifying the
columns to copy to
the files in
<em>miniMtzsOut</em> list</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>outputBaseName</p></td>
<td><p>base name for output
files to which a
numerical index and
filetype
specification will be
appended</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>outputContentFlags</p></td>
<td><p>a list mapping to
splitHkloutList with
the content flag
parameters to be set
in the output
mini-MTZs</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>inFileList</p></td>
<td><p>A list of the
‘HKLOUT’ files to be
processed to miniMTZs</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>logFile</p></td>
<td><p>Name of the log file
for program runs -
defaults to
<em>workingDi
rectory/splitmtz.log</em></p></td>
</tr>
</tbody>
</table>
</section>
<section id="cpluginscript-class-documentation">
<h2 id="cpluginscript-class-documentation"><em>CPluginScript</em> Class Documentation<a class="headerlink" href="#cpluginscript-class-documentation" title="Permalink to this heading">¶</a></h2>
<p>The following class-wide attributes can be set in a <em>CPluginScript</em>
sub-class. Examples of their use are given above. These parameters will
usually be overruled by the same paramter if it appears in the gui
definition <em>CTaskWidget</em> sub-class. Note that it is also possible to
have the <em>TASKTITLE</em> defined in the <em>def</em> file (actually called
<em>PLUGINTITLE</em> as part of the file header) but this should not normally
be used except possibly if there is more than one <em>def</em> file associated
with the script and you need to distinguish them.</p>
<table>
<tbody>
<tr class="row-odd"><td><p><strong>CPluginScript Class
Attributes</strong></p></td>
<td><p><strong>Description</strong></p></td>
</tr>
<tr class="row-even"><td><p>TASKNAME</p></td>
<td><p>The obligatory name of the
script essential for
cross-refererence to other files</p></td>
</tr>
<tr class="row-odd"><td><p>TASKVERSION</p></td>
<td><p>A version number for the script.
Please give one!</p></td>
</tr>
<tr class="row-even"><td><p>TASKMODULE</p></td>
<td><p>Refers to where the task should
appear in the task menu, can be
list of multiple modules see
<a class="reference external" href="./task_guis.html#taskmenu">Task
Men
u</a></p></td>
</tr>
<tr class="row-odd"><td><p>TASKTITLE</p></td>
<td><p>The name for the task to appear
in the GUI see <a class="reference external" href="./task_guis.html#taskmenu">Task
Men
u</a></p></td>
</tr>
<tr class="row-even"><td><p>DESCRIPTION</p></td>
<td><p>More details to appear in the
GUI see <a class="reference external" href="./task_guis.html#taskmenu">Task
Men
u</a></p></td>
</tr>
<tr class="row-odd"><td><p>MAINTAINER</p></td>
<td><p>Email address of first-call
maintainer of this code</p></td>
</tr>
<tr class="row-even"><td><p>TASKCOMMAND</p></td>
<td><p>The name of the executable that
the script will run</p></td>
</tr>
<tr class="row-odd"><td><p>SUBTASKS</p></td>
<td><p>List of main sub-tasks that
might be run by a pipeline
script - currently used for
<a class="reference external" href="./extras.html#bibliographic_references">bibliographic
references</a></p></td>
</tr>
<tr class="row-even"><td><p>COMTEMPLATE</p></td>
<td><p>A template for the program
command file</p></td>
</tr>
<tr class="row-odd"><td><p>COMTEMPLATEFILE</p></td>
<td><p>The name of a file containing a
program command template</p></td>
</tr>
<tr class="row-even"><td><p>COMLINETEMPLATE</p></td>
<td><p>A template for the program
command line</p></td>
</tr>
<tr class="row-odd"><td><p>INTERRUPTABLE</p></td>
<td><p>true/false can the script be
interrupted?</p></td>
</tr>
<tr class="row-even"><td><p>RESTARTABLE</p></td>
<td><p>true/false - can the script be
restatred</p></td>
</tr>
<tr class="row-odd"><td><p>INTERRUPTLABEL</p></td>
<td><p>Text label to appear on button
for interruptable sub-job</p></td>
</tr>
<tr class="row-even"><td><p>DBOUTPUTDATA</p></td>
<td><p>A list of the output files to be
saved to database - leave
undefined for all to be saved</p></td>
</tr>
<tr class="row-odd"><td><p>ASYNCHRONOUS</p></td>
<td><p>Boolean flag if the script, or
any of its children, run
external processes
asynchronously</p></td>
</tr>
<tr class="row-even"><td><p>PERFORMANCECLASS</p></td>
<td><p>Name of class (in
core/CCP4PerformanceData.py)
that is used as the performance
indicator for this plugin</p></td>
</tr>
<tr class="row-odd"><td><p>RUNEXTERNALPROCESS</p></td>
<td><p>Boolean flag (default True)
indicating that an external
program will be run</p></td>
</tr>
<tr class="row-even"><td><p>CLONEABLE</p></td>
<td><p>Boolean flag (default True)
indicating if the task can be
cloned</p></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br/></div>
</div>
<table>
<tbody>
<tr class="row-odd"><td><p><strong>CPluginScript Attributes</strong></p></td>
<td><p><strong>Description</strong></p></td>
</tr>
<tr class="row-even"><td><p>command</p></td>
<td><p>The name of ‘executable’ that the
script will run.</p></td>
</tr>
<tr class="row-odd"><td><p>container</p></td>
<td><p>A <em>CContainer</em> that contains the
parameters for a script. it is
initialised by the DEF file in the
plugin script directory</p></td>
</tr>
<tr class="row-even"><td><p>workDirectory</p></td>
<td><p>The directory for files produced by
the script</p></td>
</tr>
<tr class="row-odd"><td><p>errorReport</p></td>
<td><p>A <em>CErrorReport</em> containing a log of
script run</p></td>
</tr>
<tr class="row-even"><td><p>commandLine</p></td>
<td><p>A Python list of the words in the
command line to the ‘executable’.
Should normally only be accessed
using methods below.</p></td>
</tr>
<tr class="row-odd"><td><p>commandScript</p></td>
<td><p>A Python list of strings - one item
for each line of a command file.
Should normally only be accessed
using methods below.</p></td>
</tr>
<tr class="row-even"><td><p>async</p></td>
<td><p>Flag if external processes should be
run asynchronously. Default False.</p></td>
</tr>
<tr class="row-odd"><td><p>timeout</p></td>
<td><p>Timeout period for an external
process run in blocking mode.</p></td>
</tr>
<tr class="row-even"><td><p>_db*</p></td>
<td><p>Parameters for interface to database
and default directory and file
names. Do NOT mess with these!</p></td>
</tr>
<tr class="row-odd"><td><p>runningProcessId</p></td>
<td><p>An i2-specific id for the last
external process started by this
plugin. This can be used to access
info in the <em>PROCESSMANAGER</em></p></td>
</tr>
<tr class="row-even"><td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="line-block">
<div class="line"><br/></div>
</div>
<table>
<thead>
<tr class="row-odd"><th class="head"><p>CPluginScript method</p></th>
<th class="head"><p>Argument</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>__init__</p></td>
<td></td>
<td></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>parent</p></td>
<td><p>A parent class. Use
<em>CCP4M
odule.QTAPPLICATION()</em>
if nothing else is
appropriate.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>name</p></td>
<td><p>A unique name for the
instance of the class.
If
<em>makePluginObject()</em>
is used to instantiate
object then it will
create a name
dependent on the
project and job id.</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>workDirectory</p></td>
<td><p>A directory for
‘temporary’ files.</p></td>
</tr>
<tr class="row-even"><td><p>makePluginObject</p></td>
<td></td>
<td><p>Create an instance of
a CPluginScript
sub-class - should be
used rather than
instantiating directly</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>pluginName</p></td>
<td><p>Name of
wrapper/pipeline
CPluginScript
sub-class</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>reportToDatabase</p></td>
<td><p>Report the new plugin
instance (i.e. job) to
the database - default
<em>True</em></p></td>
</tr>
<tr class="row-odd"><td><p>loadContentsFromXml</p></td>
<td></td>
<td><p>Set the contents of
the container from the
DEF file in the plugin
directory.</p></td>
</tr>
<tr class="row-even"><td><p>checkInputData</p></td>
<td></td>
<td><p>The base class
implementation checks
that all files
specified in the
<em>container.inputData</em>
actually exist and
returns a list of
non-existant file
(this is wrong - it
should return a
CErrorReport)</p></td>
</tr>
<tr class="row-odd"><td><p>checkOutputData</p></td>
<td></td>
<td><p>Provide output file
names if missing</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>container</p></td>
<td><p><em>CContainer</em> to check
- default <em>None</em> will
check <em>self.container</em></p></td>
</tr>
<tr class="row-odd"><td><p>appendErrorReport</p></td>
<td></td>
<td><p>Append an error
description to the
overall plugin error
report.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>code</p></td>
<td><p>An error code number
unique for the class -
must be key in the
class ERROR_CODES
dictionary</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>details</p></td>
<td><p>A Python string
containing further
information (e.g. name
of file that you could
not read). Default
<em>None</em></p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>name</p></td>
<td><p>A Python string with
an identifier for the
data object.
<em>CData.objectPath()</em>
gives suitable value
for this.Default
<em>None</em></p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>cls</p></td>
<td><p>The class reporting
the error. Default
<em>None</em> will be
interpreted as current
class.</p></td>
</tr>
<tr class="row-even"><td><p>extendErrorReport</p></td>
<td></td>
<td><p>Append errors from
another <em>CErrorReport</em>
object to this object</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>other</p></td>
<td><p>A <em>CErrorReport</em> or
<em>CException</em></p></td>
</tr>
<tr class="row-even"><td><p>appendCommandLine</p></td>
<td></td>
<td><p>Append words to the
command line to run an
‘executable’</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>*args</p></td>
<td><p>Arguments can be
Python strings,
<em>CData</em> object, or a
list (Python list or
<em>CList</em>) of these.</p></td>
</tr>
<tr class="row-even"><td><p>appendCommandScript</p></td>
<td></td>
<td><p>Add a line to the
command script</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>text</p></td>
<td><p>A Python string or
object with __str__()
method or a list
(Python or CList) of
these.</p></td>
</tr>
<tr class="row-even"><td><p>writeCommandFile</p></td>
<td></td>
<td><p>Write text from the
comand script to a
file (the name is
determined
automatically).</p></td>
</tr>
<tr class="row-odd"><td><p>makeFileName</p></td>
<td></td>
<td><p>Generate an
appropriate file name
based on the work
directory and unique
plugin name.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>format</p></td>
<td><p>The file format -
either
‘COM’,’LOG’,’PARAMS’
or ‘PRORAMXML’</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>ext</p></td>
<td><p>Optional file
extension - overrides
the extension implied
by the format</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>baseName</p></td>
<td><p>Optional base filename
that overrides the
plugin name.</p></td>
</tr>
<tr class="row-odd"><td><p>process</p></td>
<td></td>
<td><p>Default method to run
an executable. Runs
<em>checkInputData</em>,
<em>makeCommandAndScript</em>
and <em>startProcess</em></p></td>
</tr>
<tr class="row-even"><td><p>makeCommandAndScript</p></td>
<td></td>
<td><p>Creates command line
and script from
COMTEMPLATE or
COMTEMPLATEFILE and
COMLINETEMPLATE. Or
may be reimplemented
in sub-classes</p></td>
</tr>
<tr class="row-odd"><td><p>startProcess</p></td>
<td></td>
<td><p>Call
<em>PROCESSMAN
AGER().startProcess()</em>
to start external
process. Returns job
status
C
PluginScript.SUCCEEDED
or
CPluginScript.FAILED.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>command</p></td>
<td><p>The external
‘executable’.</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>reportStatus</p></td>
<td><p>Boolean, default True.
If True startProcess
calls reportStatus
when complete.</p></td>
</tr>
<tr class="row-even"><td><p>postProcess</p></td>
<td></td>
<td><p>Called after an
external process
started by
<em>startProcess</em>
finishes.Can be
reimplemented but must
call <em>reportStatus()</em></p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>processId</p></td>
<td></td>
</tr>
<tr class="row-even"><td></td>
<td><p>data</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>postProcessWrapper</p></td>
<td></td>
<td><p>Can be called at end
of pipeline script
instead of
<em>postProcess</em> to clean
up after last wrapper
plugin</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>finishStatus</p></td>
<td><p>Finish status of last
wrapper -
<em>CP
luginScript.SUCCEEDED</em>
or
*
CPluginScript.FAILED*.</p></td>
</tr>
<tr class="row-odd"><td><p>reportStatus</p></td>
<td></td>
<td><p>Reports completion to
database, writes
PARAMS file, emits a
‘finished’ signal with
an job status.</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>finishStatus</p></td>
<td><p>Finish status of job -
<em>CP
luginScript.SUCCEEDED</em>
or
*
CPluginScript.FAILED*.</p></td>
</tr>
<tr class="row-odd"><td><p>postProcessCheck</p></td>
<td></td>
<td><p>Query the process
manager to find out if
the external job
succeeded. Returns
<em>CPluginScript.FAILED</em>
or
<em>CP
luginScript.SUCCEEDED</em></p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>processId</p></td>
<td><p>The process id - as
returned by
<em>startProcess()</em></p></td>
</tr>
<tr class="row-odd"><td><p>logFileText</p></td>
<td></td>
<td><p>Return the text of a
log file created by
the external process.</p></td>
</tr>
<tr class="row-even"><td><p>updateJobStatus</p></td>
<td></td>
<td><p>Report job status to
database - provide
<em>status</em> or
<em>finishStatus</em></p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>status</p></td>
<td><p>A CCP4DbApi
<a href="#id2"><span class="problematic" id="id3">JOBSTATUS_</span></a>*</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>finishStatus</p></td>
<td><p><em>CP
luginScript.SUCCEEDED</em>
or
<em>CPluginScript.FAILED</em></p></td>
</tr>
<tr class="row-odd"><td><p>saveParams</p></td>
<td></td>
<td><p>Save the content of
self.container to a
file
<em>baseName.params.xml</em></p></td>
</tr>
<tr class="row-even"><td><p>getProcessId</p></td>
<td></td>
<td><p>Return the processId
which can be used to
query
PROCES
SMANAGER()getJobData()</p></td>
</tr>
<tr class="row-odd"><td><p>joinMtz</p></td>
<td></td>
<td><p>Join multiple MTZs
into one MTZ</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>outFile</p></td>
<td><p>Full path name of the
output file</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>inFiles</p></td>
<td><p>A list, each element
is a list of two
elements: the full
path name of a input
file and a text string
of comma-separated
column names.</p></td>
</tr>
<tr class="row-even"><td><p>splitMtz</p></td>
<td></td>
<td><p>Split one MTZ into
multiple MTZs</p></td>
</tr>
<tr class="row-odd"><td></td>
<td><p>inFile</p></td>
<td><p>Full path name of the
input file</p></td>
</tr>
<tr class="row-even"><td></td>
<td><p>outFiles</p></td>
<td><p>A list, each element
is a list of three
elements: the full
path name of a output
file, the input
columns and the
corresponding output
columns. Thr input and
output columns are a
text string of
comma-separated column
names.</p></td>
</tr>
</tbody>
</table>
</section>
<section id="moving-data-between-plugins">
<h2 id="moving-data-between-plugins">Moving Data Between Plugins<a class="headerlink" href="#moving-data-between-plugins" title="Permalink to this heading">¶</a></h2>
<p>Data is held in a <em>CContainer</em> which is described
<a class="reference external" href="./data_classes.html#containers">here</a>. Pipeline scripts usually need
to copy data from their own container to to wrapper containers or
between wrapper containers. Single items of data can be copied simply by
equivalencing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">XYZIN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">XYZIN</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">If you need to copy more data between plugins then use
<em>CContainer.copyData()</em> which copies data into the container. There
are two arguments:</div>
<div class="line">   <em>otherContainer</em> - container to copy from</div>
<div class="line">   <em>dataList</em> - list of items to copy. If no list is provided it will
copy all items with the same name (use with care!).</div>
<div class="line">For example:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">pdbset</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">copyData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="p">,[</span><span class="s1">'XYZIN'</span><span class="p">])</span>
</pre></div>
</div>
</section>
<section id="asynchronous-pipelines">
<h2 id="asynchronous-pipelines">Asynchronous Pipelines<a class="headerlink" href="#asynchronous-pipelines" title="Permalink to this heading">¶</a></h2>
<p>The <em>CPluginScript</em> method uses <em>PROCESSMAMANGER().startProcess()</em> to
start the programs in a separate process. By default external processes
are run in blocking mode i.e. the script does not continue until after
the external program has completed. This is fine for single wrappers or
pipelines performing a series of consecutive steps but for some
pipelines you may want to have several program runs start concurrently
and then process the result for each run as it completes. There is a
trivial example of how to do this in the pipeline
<a class="reference external" href="../../pipelines/demo_multi_mtzdump/script/demo_multi_mtzdump.py/">demo_multi_mtzdump</a>
that runs multiple instances of the <em>mtzdump</em> program that extracts data
from an MTZ file. The <a class="reference external" href="../../wrappers/mtzdump/script/mtzdump.py/">mtzdump
wrapper</a> is a simple
wrapper requiring no specific features to support this functionality.
The <em>demo_multi_mtzdump.process()</em> method makes a list of mtz files and
then creates one instance of the <em>mtzdump</em> wrapper for each file using
the usual <em>makePluginObject()</em> method. In this example the call to
<em>makePluginObject()</em> has the <em>reportToDatabase</em> argument set False to
prevent the individual tasks being saved to the database but this is not
at all a requirement for plugins that are run asynchronously. The name
of the input mtz is set in <em>mtzdump</em> object and then the code that is
specific for asynchronous running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set to run asynchronously and set a callback</span>
<span class="n">mtzdump</span><span class="o">.</span><span class="k">async</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">mtzdump</span><span class="o">.</span><span class="n">setFinishHandler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">handleDone</span><span class="p">)</span>
<span class="c1">#Start process</span>
<span class="n">rv</span> <span class="o">=</span> <span class="n">mtzdump</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
<span class="c1">#The mtzdump instance must be saved to keep it in scope and everything else can be got from that.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">subProcessList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mtzdump</span><span class="p">)</span>
</pre></div>
</div>
<p>The <em>mtzdump.async</em> parameter is set <em>True</em> and callback is set to
<em>self.handleDone</em> a method defined later in the script. The <em>mtzdump</em> is
started by calling <em>mtzdump.process()</em> and the mtzdump object is saved
to a list; this is essential to ensure it does not go out of scope when
the <em>demo_multi_mtzdump.process()</em> method returns. The <em>handleDone()</em>
method is called as each mtzdump process finishes and is passed the
<em>jobId</em> and a <em>processId</em> from the completed run. The <em>jobId</em> will be
None if the script is run in a context without the CCP4i2 database or if
(as here) the <em>reportToDatabase</em> is False. So it is best, as in this
example, to use the pid to find which mtzdump instances has finished:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get the exit status and if successful get the CELL from the outputData</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">postProcessCheck</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="o">==</span> <span class="n">CPluginScript</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">:</span>
  <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">subProcessList</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">processId</span> <span class="o">==</span> <span class="n">pid</span><span class="p">:</span>
      <span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">inputData</span><span class="o">.</span><span class="n">HKLIN</span><span class="p">,</span><span class="n">p</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">CELL</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">subProcessList</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
<p>In this trivial example a result is printed out and the finished mtzdump
instance is removed from the list of sub-processes. It is also very
important that this callback method tests for when all sub-processes are
finished and calls <em>CPluginScript.reportStatus()</em> with a suitable status
flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subProcessList</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">CPluginScript</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">)</span>
</pre></div>
</div>
<p>One other essential feature is that the <em>demo_multi_mtzdump</em> class has
an attribute <em>ASYNCHRONOUS</em> set to True at the top of the class
definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">demo_multi_mtzdump</span><span class="p">(</span><span class="n">CPluginScript</span><span class="p">):</span>
  <span class="n">TASKTITLE</span> <span class="o">=</span> <span class="s1">'Demo multi MTZ dump'</span>
  <span class="n">TASKNAME</span> <span class="o">=</span> <span class="s1">'demo_multi_mtzdump'</span>
  <span class="n">ASYNCHRONOUS</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>This is a flag to the infrastructure running the task to ensure that the
necessary event loops and threads are set up before creating an instance
of the class.</p>
</section>
<section id="connecting-a-pipeline-with-connectsignal">
<h2 id="connecting-a-pipeline-with-connectsignal">Connecting a pipeline with connectSignal()<a class="headerlink" href="#connecting-a-pipeline-with-connectsignal" title="Permalink to this heading">¶</a></h2>
<p>An alternative approach to running pipelines asynchronously is after
creating the first subtask but before calling its <em>process()</em> method,
use <em>connectSignal()</em> to connect the ‘finished’ signal from that first
subtask to a target function that will start the second subtask. This is
shown below in an extract from <em>aimless_pipe.py</em> where the first
<em>pointless</em> plugin is created and then a <em>connectSignal()</em> call ensures
that the ‘finish’ signal will invoke <em>process_aimless()</em> method. The
<em>process_aimless()</em> method first checks the finish status of the
<em>pointless</em> subtask and then runs <em>aimless</em> and calls <em>connectSignal()</em>
to get <em>process_cycle_ctruncate()</em> called when the <em>aimless</em> plugin
finishes .. and so on.</p>
<p>One issue with using <em>connectSignal()</em> is that the target function can
crash without any exception being passed up to a calling function so
there is no evidence of what happened and no call to <em>reportStatus()</em> to
cleanup and ensure that the job is recognised to have failed. So for the
user the job appears to be still running. The way to handle this is to
wrap all of the functionality in the target method in a <em>try..except</em>
statement with the <em>except</em> body calling <em>appendErrorReport()</em> and
<em>self.reportStatus(CPluginScript.FAILED)</em>. This gets the exception shown
in the job’s diagnostic and ensures that the pipeline is correctly
reported as failed. The <em>CPluginScript</em> error code 39 is a generic
‘Unknown error’. It would be better to have several <em>try..except</em>
statements and to append more informative <em>CException</em> (ie ccp4i2
exception) to the pipeline error log using <em>appendErrorReport()</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">"### Starting aimless pipeline ###"</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">process_pointless</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">process_pointless</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="nb">print</span> <span class="s2">"### Running pointless ###"</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pointless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePluginObject</span><span class="p">(</span><span class="s1">'pointless'</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">connectSignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pointless</span><span class="p">,</span><span class="s1">'finished'</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">process_aimless</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pointless</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">process_aimless</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">status</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">status</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'finishStatus'</span><span class="p">)</span> <span class="o">==</span> <span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">:</span>
       <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
       <span class="k">return</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="nb">print</span> <span class="s2">"### Running aimless ###"</span>
      <span class="n">crash</span> <span class="c1">#Test the fail mechanism</span>

      <span class="c1"># Run aimless to edit model</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">aimless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">makePluginObject</span><span class="p">(</span><span class="s1">'aimless'</span><span class="p">)</span>
      <span class="o">...</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">connectSignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">aimless</span><span class="p">,</span><span class="s1">'finished'</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">process_cycle_ctruncate</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">aimless</span><span class="o">.</span><span class="n">process</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="nb">print</span> <span class="n">e</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">appendErrorReport</span><span class="p">(</span><span class="n">CPluginScript</span><span class="p">,</span><span class="mi">39</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">reportStatus</span><span class="p">(</span><span class="n">CPluginScript</span><span class="o">.</span><span class="n">FAILED</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="a-wrapper-that-does-not-run-an-external-process">
<h2 id="a-wrapper-that-does-not-run-an-external-process">A ‘Wrapper’ that does not run an External Process<a class="headerlink" href="#a-wrapper-that-does-not-run-an-external-process" title="Permalink to this heading">¶</a></h2>
<p>It is possible that a wrapper might do the processing itself without
running another program in another external process. In this case the
developer should reimplement the <em>startProcess()</em> method to do the
necessary processing and should set the class parameter
<em>RUNEXTERNALPROCESS</em> to <em>False</em>. An example of a script which does this
is <a class="reference external" href="../../wrappers/mergeMtz/script/mergeMtz.py">mergeMtz</a> which just
calls the utility <em>CPluginScript.joinMtz()</em> to perform its
functionality. Note that <em>startProcess()</em> should return
<em>CPluginScipt.SUCCEEDED</em> or <em>CPluginScipt.FAILED</em>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">mergeMtz</span><span class="p">(</span><span class="n">CPluginScript</span><span class="p">):</span>

    <span class="n">TASKTITLE</span> <span class="o">=</span> <span class="s1">'Merge experimental data objects to MTZ'</span>     <span class="c1"># A short title for gui menu</span>
    <span class="n">TASKNAME</span> <span class="o">=</span> <span class="s1">'mergeMtz'</span>                                    <span class="c1"># Task name - should be same as class name</span>
    <span class="n">RUNEXTERNALPROCESS</span> <span class="o">=</span> <span class="kc">False</span>                               <span class="c1"># There is no external process</span>

    <span class="k">def</span> <span class="nf">startProcess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">command</span><span class="p">,</span><span class="o">**</span><span class="n">kw</span><span class="p">):</span>

      <span class="sd">'''</span>
<span class="sd">          Some data preparation</span>
<span class="sd">      '''</span>

      <span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">joinMtz</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">outputData</span><span class="o">.</span><span class="n">HKLOUT</span><span class="o">.</span><span class="n">fullPath</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span><span class="n">inFiles</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">status</span>
</pre></div>
</div>
</section>
<section id="interrupting-and-restarting-processes">
<h2 id="interrupting-and-restarting-processes">Interrupting and restarting processes<a class="headerlink" href="#interrupting-and-restarting-processes" title="Permalink to this heading">¶</a></h2>
<p>For an example see
<em>pipelines/buccaneer_build_refine/scripts/buccaneer_build_refine.py</em>
which will stop at the end of a buccaneer-refmac cycle if it receives an
interrupt signal. The pipeline can test if there is an interrupt signal
at a suitable break point by calling <em>CPluginScript.testForInterrupt()</em>
which will return True if an interrupt request has been made. At this
point the script should:</p>
<p>do whatever to terminate the script cleanly with meaningful results</p>
<p>if the script supports restart it should save any necessary parameters -
e.g. buccaneer_build_refine has an extra <em>interruptStatus</em> container in
the def file to hold these parameters.</p>
<p>call <em>self.reportStatus(CPluginScript.INTERRUPTED)</em> to register with the
database that the job is interrupted</p>
<p><em>return</em> from the script</p>
<p>If the script supports restart then the start of the script should check
the saved parameters (e.g. in the <em>interruptStatus</em> container and set
the starting parameters appropriately. To notify the system that a
script supports interrupt or restart the class attributes
<em>INTERRUPTABLE</em> and <em>RESTARTABLE</em> should be set to True.</p>
<p>There is an alternative mechanism to support stopping a sub-job in a
pipeline so that the pipeline can continue. This is best seen in the
CRANK2 pipeline. The interruptable task should have the task attribute
INTERRUPTLABEL set to a text string that is a label to appear on button
underneath the task report. If the user clicks this button then there is
a signal that can be checked for with the
<em>CPluginScript.testForInterrupt()</em> method as described above. The
pipeline should have a mechanism to continue to the next step when it
gets this signal. To make this tool usable the job report should be
showing the progress of the sub-job so the user can make a sensible
decision when to interrupt it and the subsequent report should probably
contain a note that the job was interrupted.</p>
<p>The sub-job interrupt was implemented for the benefit of CRANK2 and has
some obvious limitations - if a task has INTERRUPTLABEL attribute then
it applies in all pipelines that run the task - subclassing the task
class could be used to get around this. The system currently only
suuports interrupting the immediate children of a pipeline task.</p>
</section>
<section id="performance-indicators">
<h2 id="performance-indicators">Performance Indicators<a class="headerlink" href="#performance-indicators" title="Permalink to this heading">¶</a></h2>
<p>A performance indicator is one or more simple parameters that give an
indication of the effectiveness of a job - for example R-factors and
free R-factors can be performance indicators for refinement. CCP4i2’s
use of performance indicators is currently in development but the basic
approach is that a plugin script saves the key parameters in the
<em>outputData</em> section of the <em>def</em> file and they will be picked up from
here by the CCP4i2 system and saved to the database. These parameters
are then displayed in the project window. In future the parameters
stored in the database might help to guide automated structure solution.</p>
<p>The file
<a class="reference external" href="../../core/CCP4PerformanceData.py">core/CCP4PerformanceData.py</a>
contains the definitions of performance indicator classes that are
sub-classed from <em>CPerformanceIndicator</em>. It is expected that there
should be one performance indicator class for each stage in structure
solution so tasks that perform a similar function should use the same
performance indicator class (the classes will provide interconversion of
different representations and whatever else is necessary to make this
work). The currently defined classes hold several parameters that are
all either floats or strings and the mechanism to save data to the
database currently only handles floats (or integers converted to floats)
or strings (255 character limit) but this convention could be changed if
necessary. The parameters in each class are up for discussion.</p>
<p>To use a performance indicator a plugin class should set the class
variable PERFORMANCECLASS to the name of the performance class used
(this is there to help in efficiently generating the display in the
project window). In the <em>def</em> file <em>outputData</em> section a variable
(usually called <em>PERFORMANCEINDICATOR</em> but that is optional) is declared
with the appropriate class. At the end of the process, the plugin script
should set the parameters in the performnce indicator object. To see an
example of this look for ‘PERFORMANCE’ in
<a class="reference external" href="../../pipelines/bucref/script/buccaneer_build_refine.def.xml">../../pipelines/bucref/script/buccaneer_build_refine.def.xml</a>
and
<a class="reference external" href="../../pipelines/bucref/script/buccaneer_build_refine.py">../../pipelines/bucref/script/buccaneer_build_refine.py</a></p>
</section>
<section id="project-defaults">
<h2 id="project-defaults">Project Defaults<a class="headerlink" href="#project-defaults" title="Permalink to this heading">¶</a></h2>
<p>This is a mechanism to set some parameter(s) for a given task for every
time that task is run within a project. Typically it might be used to
control restraints in Refmac runs when these need customising for the
particular coordinate data in the project. A task that wants to set some
default parameters (for subsequent runs of the same task or for another
task) creates a fragment of the <em>params</em> file for the task containing
only the required parameters and saves this file to the
<em>CCP4_PROJECT_FILES</em> sub-directory of the project directory. When the
task plugin is created the appropriate <em>default params</em> file is
automatically loaded.</p>
<p>The implementation of this feature is under development but presently
there are two <em>CPluginScript</em> methods to enable a developer to create or
edit a <em>default params</em> file. For example to set the <em>WEIGHT</em> parameter
for a Refmac wrapper.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">defaultsContainer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">getProjectDefaultParameters</span><span class="p">(</span><span class="n">taskName</span><span class="o">=</span><span class="s1">'refmac_martin'</span><span class="p">,</span><span class="n">paramsList</span><span class="o">=</span><span class="p">[</span><span class="s1">'WEIGHT'</span><span class="p">])</span>
<span class="k">if</span> <span class="n">defaultsContainer</span><span class="o">.</span><span class="n">controlParameters</span><span class="o">.</span><span class="n">WEIGHT</span> <span class="o">!=</span> <span class="mf">2.0</span><span class="p">:</span>
  <span class="n">defaultsContainer</span><span class="o">.</span><span class="n">controlParameters</span><span class="o">.</span><span class="n">WEIGHT</span> <span class="o">=</span> <span class="mf">2.0</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">saveProjectDefaultParameters</span><span class="p">(</span><span class="n">defaultsContainer</span><span class="p">)</span>
</pre></div>
</div>
<p>Here <em>CPluginScript.getProjectDefaultParameters()</em> has been called with
the name of a task and a list of the parameters that will be set. This
method returns a ‘top-level’ container with the usual sub-containers
(<em>inputData</em>,<em>controlParameters</em> and <em>outputData</em>) but only the listed
parameters. Except if there is already a <em>default params</em> file for this
task then the contents of that file plus the listed parameters are
returned. You should check that the required defaults have not already
being set (this is to avoid unnecessary extra versions of the defaults
file), set the required defaults and then save the edited defaults using
<em>CPluginScript.saveProjectDefaultParameters()</em>. Note that the defaults
file is saved with the header containing the jobId and jobNumber of the
job that created it and the <em>default params</em> files are versioned with
file names of the form <em>CCP4_PROJECT_FILES/refmac_martin_001.params.xml</em></p>
<p>The defaults file is read and loaded by
<em>CPluginScript.loadProjectDefaults()</em> called from
<em>CPluginScript.process()</em> (currently commented out - Dec 2014).</p>
<p>There are several issues with this mechanism - please discuss with Liz
before using it.</p>
</section>
<section id="incorporating-non-ccp4i2-pipelines">
<h2 id="incorporating-non-ccp4i2-pipelines">Incorporating non-CCP4i2 pipelines<a class="headerlink" href="#incorporating-non-ccp4i2-pipelines" title="Permalink to this heading">¶</a></h2>
<p>It is possible to get a pipeline not written with CCP4I2 <em>CPluginScript</em>
to appear in the i2 database and GUI. This could avoid writing wrappers
for every program called by the pipeline but does require following some
I2 conventions:</p>
<p>The pipeline ‘top’ script must be a CPluginScript</p>
<p>The pipeline must place its output files (data file, log files) in the
specified directory ( CPluginScript.workDirectory)</p>
<p>Each sub-process that you want to be visible to i2 must have output and
log files placed in the i2 specified directory</p>
<p>For each sub-process a dummy <em>CPluginScript</em> must by created and its
data container loaded with info on input and output data.</p>
<p>The <em>dummy</em> pipeline (<em>dumMee</em> in the <em>test</em> folder of the GUI) has a
script <em>$CCP4I2_TOP/pipelines/dummy/script/dummy.py</em> that demonstates
how to do this.</p>
<p>The CRANK2 pipeline is an example of this.</p>
</section>
<section id="testing-and-debugging-scripts-1">
<span id="id1"></span><h2 id="testing-and-debugging-scripts-1">Testing and Debugging Scripts<a class="headerlink" href="#testing-and-debugging-scripts-1" title="Permalink to this heading">¶</a></h2>
<p>It is possible to run scripts and external programs from the console.
After you have attempted to run a script from the gui there will be a
job directory in the project directory (<em>project_path/CCP4_JOBS/job_nnn</em>
where nnn is the job number listed in the gui) and this contains an
input params file (<em>input_params.xml</em>). To rerun the script with these
input parameters:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt; $CCP4I2_TOP/bin/Python $CCP4I2_TOP/bin/runTask.py &gt;project_path/CCP4_JOBS/job_nnn/input_params.xml
</pre></div>
</div>
</section>
<section id="exporting-a-task-as-a-compressed-file">
<h2 id="exporting-a-task-as-a-compressed-file">Exporting a task as a compressed file<a class="headerlink" href="#exporting-a-task-as-a-compressed-file" title="Permalink to this heading">¶</a></h2>
<p>This is a mechanism to create a compressed file (currently a zip) to
make available to a limited number of users as an alternative to
checking code into the normal CCP4i2 repository for general
distribution. The code to export must be a sub-directory of the
<em>pipelines</em> directory and should be cleaned of <em>.pyc</em> and other
superfluous files. The <em>Export task</em> option is on the <em>Developer tools</em>
sub-menu of the <em>Utilities</em> menu. You will be asked to choose the
directory to export and the compressed file will be placed in the
<em>pipelines</em> directory. The user can import the task via the <em>Import
task</em> option on the <em>Utitlities</em> menu.</p>
</section>
<section id="exporting-files-from-a-job">
<h2 id="exporting-files-from-a-job">Exporting files from a job<a class="headerlink" href="#exporting-files-from-a-job" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">In the project window job list the job context menu can include an
option to export files from the job. This is likely to be particularly
useful for exporting ‘monster’ MTZ files for use outside CCP4i2 but it
could work for any file that either exists in the job directory or
sub-directory or can be created from the data there. The task script
module should provide two functions (note functions not methods of the
CPluginScript class):</div>
<div class="line"><strong>exportJobFileMenu( jobId )</strong> - is called when the user opens the job
context menu and should return details of items to appear on an
‘Export’ menu. The function is passed the jobId of the job chosen by
the user and should return a list where each item is a sub-list of
three strings:</div>
<div class="line">    an identifier that will be <em>mode</em> input to <em>exportJobFile()</em></div>
<div class="line">    the text string that will appear on the <em>Export</em> sub-menu - should
inform the user exactly what will be exported</div>
<div class="line">    the mime type of the exported file (see CCP4CustomMimeTypes) -
used by the file selection dialog for file extensions etc.</div>
<div class="line"><strong>exportJobFile( jobId , mode)</strong> - is called when the user selects one
of the options from the <em>Export</em> sub-menu. The function is passed the
jobId of the selected job and the identifier from the sub-menu item.
The function should return the filename of the file to export - it may
need to create a temporary file. There is an example of this in the
aimless_pipe script. A code fragment that might be useful in this
context:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Modules</span>
<span class="n">childJobs</span> <span class="o">=</span><span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROJECTSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">db</span><span class="p">()</span><span class="o">.</span><span class="n">getChildJobs</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">jobId</span><span class="p">,</span><span class="n">details</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">decendents</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">for</span> <span class="n">jobNo</span><span class="p">,</span><span class="n">jobId</span><span class="p">,</span><span class="n">taskName</span>  <span class="ow">in</span> <span class="n">childJobs</span><span class="p">:</span>
  <span class="k">if</span> <span class="n">taskName</span> <span class="o">==</span> <span class="s1">'ctruncate'</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span> <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROJECTSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">jobDirectory</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">jobId</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span><span class="s1">'HKLOUT.mtz'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">f</span><span class="p">):</span> <span class="k">return</span> <span class="n">f</span>
</pre></div>
</div>
<p>Here the <em>CDbApi.getChildJobs()</em> returns a list of the subJobs for the
<em>jobId</em> with the job number, jobId and taskname for each sub-job
returned. The <em>CProjectsMaanger.jobDirectory()</em> returns the job
directory for any job or sub-job.</p>
<div class="line-block">
<div class="line">A likely requirement to create suitable export files is merging two or
more MTZs. The usual CCP4i2 approach using <em>cmtzjoin</em> expects to work
with column groups corresponding to i2 data objects and may not work
for the ‘old style’ MTZs that are being exported. There is a simple
interface to the CAD program via <em>CMtzDataFile.runCad()</em>. This has
arguments:</div>
<div class="line">  <em>hklout</em> - output file name</div>
<div class="line">  <em>hklinList</em> - list of mtz to be merged with the file referenced by
<em>CMtzDataFile</em></div>
<div class="line">  <em>comLines</em> - list of strings to go into command file (END not
necessary)</div>
<div class="line">If <em>comLines</em> is zero length then the compulsary LABIN input will be
set to ‘ALL’ for all input files. If you require anything other than
all the files merging you should set <em>comLines</em> to the necessary CAD
command lines. This return hklout(str),err(CErrorReport).</div>
</div>
<p>The <em>hklout</em> should be set to something like ‘export.mtz’ in the job
directory and <em>runCad()</em> will create this file and <em>export_cad.com</em> and
<em>export_cad.log</em> in the job directory.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">exportJobFile</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">os</span>
    <span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Modules</span>
    <span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4XtalData</span>

    <span class="n">jobDir</span> <span class="o">=</span> <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROJECTSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">jobDirectory</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">jobId</span><span class="p">,</span><span class="n">create</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">exportFile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">jobDir</span><span class="p">,</span><span class="s1">'exportMtz.mtz'</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">exportFile</span><span class="p">):</span> <span class="k">return</span> <span class="n">exportFile</span>

    <span class="o">...</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">CCP4XtalData</span><span class="o">.</span><span class="n">CMtzDataFile</span><span class="p">(</span><span class="n">truncateOut</span><span class="p">)</span>
    <span class="c1">#print m.runCad.__doc__   #Print out docs for the function</span>
    <span class="n">outfile</span><span class="p">,</span><span class="n">err</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">runCad</span><span class="p">(</span><span class="n">exportFile</span><span class="p">,[</span> <span class="n">freerflagOut</span> <span class="p">]</span> <span class="p">)</span>
    <span class="k">return</span>   <span class="n">outfile</span>
</pre></div>
</div>
</section>
<section id="temporary-files-and-file-cleanup">
<h2 id="temporary-files-and-file-cleanup">Temporary files and file cleanup<a class="headerlink" href="#temporary-files-and-file-cleanup" title="Permalink to this heading">¶</a></h2>
<div class="line-block">
<div class="line">Considerations:</div>
<div class="line">Ideally wrappers and task guis should put intermediate files in the
appropriate job directory so they can be found and (potentially)
bundled in when a job or project is exported. Or found and deleted.</div>
<div class="line">There is a need to limit the size of job and project directories since
users may want to export them and compressing and moving large files
is slow.</div>
<div class="line">Many programs create large intermediate files. Many pipelines have
little used intermediate data files.</div>
</div>
<p>In order to limit disk usage and user information overload some ‘scratch
files’ or little used files are deleted. At the end of a job run the
core system automatically applies a file cleanup and there are user
interface options to cleanup files from an individual job or whole
project. To support this the core system keeps a list of files that can
be deleted and individual tasks should have a list of files specific to
the task. The <em>CCP4ProjectsManager.CPurgeProject</em> class handles this and
the parameters shown below come from that class. The multi-step process
of assigning files to a catagory and then deleting certain catagories in
a given context allows for user customisation and the inevitable change
of requirements.</p>
<p>The deletable files are assigned to a catagory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PURGECODES</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span> <span class="p">:</span> <span class="s1">'Scratch file'</span><span class="p">,</span>
               <span class="mi">2</span> <span class="p">:</span> <span class="s1">'Scratch file potentially useful diagnotic'</span><span class="p">,</span>
               <span class="mi">3</span> <span class="p">:</span> <span class="s1">'Diagnostic file'</span><span class="p">,</span>
               <span class="mi">4</span> <span class="p">:</span> <span class="s1">'File redundant after report created'</span><span class="p">,</span>
               <span class="mi">5</span> <span class="p">:</span> <span class="s1">'Intermediate data file'</span><span class="p">,</span>
               <span class="mi">6</span> <span class="p">:</span> <span class="s1">'Redundant on project completion'</span><span class="p">,</span>
               <span class="mi">7</span> <span class="p">:</span> <span class="s1">'Large file that could be deleted'</span><span class="p">,</span>
               <span class="mi">0</span> <span class="p">:</span> <span class="s1">'Retained file - used to override default'</span> <span class="p">}</span>
</pre></div>
</div>
<p>In any context the catagories of file that can be deleted are specified
(e.g. [1,2] on completion of a job). The <em>CPurgeProject</em> class has a
list of the contexts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CONTEXTLOOKUP</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'script_finish'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                  <span class="s1">'script_finish_fail'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                  <span class="s1">'script_finish_remote'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                  <span class="s1">'temporary'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                  <span class="s1">'intermediate'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                  <span class="s1">'extended_intermediate'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                  <span class="s1">'project_complete'</span> <span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="p">}</span>
</pre></div>
</div>
<p>The <em>CPurgeProject</em> class also has
a default list of files and purge catagories that specify files created
by many or all tasks. This currently is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SEARCHLIST</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">'*-coordinates_*.*'</span><span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'report.previous_*.html'</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'report_tmp.previous_*.html'</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'params.previous_*.xml'</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'diagnostic.previous_*.xml'</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'hklin.mtz'</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'hklout.mtz'</span><span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*mtzsplit.log'</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'log_mtz*.txt'</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'sftools'</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'ctruncate'</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'scratch'</span><span class="p">,</span> <span class="mi">2</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'stderr.txt'</span> <span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
               <span class="p">[</span> <span class="s1">'stdout.txt'</span> <span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
               <span class="p">[</span> <span class="s1">'diagnostic.xml'</span> <span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
               <span class="p">[</span> <span class="s1">'report_tmp.html'</span> <span class="p">,</span> <span class="mi">4</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'program.xml'</span> <span class="p">,</span> <span class="mi">4</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'XMLOUT.xml'</span> <span class="p">,</span> <span class="mi">4</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'log.txt'</span><span class="p">,</span> <span class="mi">4</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*.scene.xml'</span> <span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*observed_data_as*'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*phases_as*'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*%*/report.html'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*%*/tables_as_csv_files'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*%*/tables_as_xml_files'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'*%*/params.xml'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">],</span>
               <span class="p">[</span> <span class="s1">'com.txt'</span><span class="p">,</span> <span class="mi">6</span> <span class="p">]</span> <span class="p">]</span>
</pre></div>
</div>
<p>So, for example, <em>hklin.mtz</em> is catagory 1, a scratch file that is
liable to be deleted in many context. But many tasks have either
addition files suitable for deletion or perhaps some that require saving
despite appearing on the above list. Particularly pipelines might have
sub-job files suitable for deletion. The task-specific files should be
listed as an attribute of the plugin class - for example for the
<em>import_merged</em> task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PURGESEARCHLIST</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">'HKLIN*.mtz'</span> <span class="p">,</span> <span class="mi">1</span> <span class="p">],</span>
                    <span class="p">[</span><span class="s1">'aimless_pipe%*/HKLOUT*.mtz'</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                   <span class="p">]</span>
</pre></div>
</div>
<p><em>PURGESEARCHLIST</em> is a list of filename and purge catagory pairs. Here
intermediate input mtz files and the output from <em>aimless_pipe</em> (run
just for the analysis) are catagorised at scratch files (catagory 1).
Note that ‘*’ can be used as a wildcard in filenames and that files in
sub-jobs are specified by <em>taskname</em>%<em>subjob_number</em>/<em>filename</em>. The
<em>taskname</em> or <em>subjob_number</em> can have ‘*’ as wildcard. The sub-jobs can
be nested. A more complex example is for <em>buccaneer_build_refine_mr</em>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PURGESEARCHLIST</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="s1">'buccaneer_mr%*/XYZOUT.*'</span> <span class="p">,</span> <span class="mi">5</span> <span class="p">,</span> <span class="s1">'XYZOUT'</span> <span class="p">],</span>
                  <span class="p">[</span> <span class="s1">'refmac%*/ABCDOUT.mtz'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'ABCDOUT'</span> <span class="p">],</span>
                  <span class="p">[</span> <span class="s1">'refmac%*/FPHIOUT.mtz'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'FPHIOUT'</span> <span class="p">],</span>
                  <span class="p">[</span> <span class="s1">'refmac%*/DIFFPHIOUT.mtz'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'DIFFPHIOUT'</span> <span class="p">]</span>
 <span class="o">....</span>
                  <span class="p">[</span> <span class="s1">'prosmart_refmac%*/refmac%*/XYZOUT.pdb'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'XYZOUT'</span> <span class="p">],</span>
                  <span class="p">[</span> <span class="s1">'prosmart_refmac%*/refmac%*/COOTSCRIPTOUT.scm'</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">'COOTSCRIPTOUT'</span> <span class="p">]</span> <span class="p">]</span>
</pre></div>
</div>
<p>Here the files being catagorised are the intermediate sub-job data files
from <em>buccaneer_mr</em> and <em>refmac</em> subtasks which by default the sub-tasks
record in the project database. When these files are deleted they must
also be removed from the database and the list above also gives the
sub-job parameter name for each file so it can be found in the database
and removed.</p>
<p>The purge mechanism builds a search list for a job by first creating a
search list for sub-jobs composed of the program-wide default list
overridden by the specific purge list for the sub-job task and then
overidden by the parent task purge list. Then, for all items on the
search list in the right catagories for the context, the mechanism looks
for files matching the filename and deletes them.</p>
</section>
<section id="appendix">
<h2 id="appendix">Appendix<a class="headerlink" href="#appendix" title="Permalink to this heading">¶</a></h2>
<section id="parents">
<h3 id="parents">Parents<a class="headerlink" href="#parents" title="Permalink to this heading">¶</a></h3>
<p>For Qt signals to work <em>CPluginScript</em> is sub-classed from a <em>QObject</em>.
All <em>QObject</em>s must have a parent which is another <em>QObject</em> or the
<em>QApplication</em> (the top-level Qt object). If you are instantiating a
pipeline with no obvious parent, such as in the unittest code, then the
function <em>CCP4Modules.QTAPPLICATION()</em> can be used to get the
<em>QApplication</em> that can be used as a parent.</p>
</section>
<section id="file-organisation">
<h3 id="file-organisation">File Organisation<a class="headerlink" href="#file-organisation" title="Permalink to this heading">¶</a></h3>
<p>The objective is to have everything for one project in one place and to
allow the pipeline developer as much flexibility as possible but to have
some minimal organisation so ‘the system’ can find the ‘plugins’ and
other developers can use the resources.</p>
<div class="line-block">
<div class="line">I suggest the following (but this is totally up for discussion):</div>
<div class="line">The wrappers for individual programs are in the <em>wrappers</em> directory
where they are a resource for all developers and we avoid duplication
of effort.</div>
<div class="line">The ‘pipelines’ go in a separate <em>pipelines</em> directory that should
contain sub-directories such as ‘MrBump’, ‘CRANK’ etc. Each of these
projects contain the sub-directories:</div>
<div class="line"><em>script</em>: analogous to the <em>wrappers</em> directory this should contain,
for example, a ‘MrBump.py’ file containing the MrBump class that is a
sub-class of <em>CPluginScript</em>. The <em>script</em> directory could contain
more than one script module - it is likely one pipeline development
group might contribute more than one top level script.</div>
<div class="line"><em>utils</em> containing utility code that is part of the project but
hopefully is available to other developers</div>
<div class="line"><em>test_data</em> please provide all test data (er.. within reason)</div>
<div class="line"><em>gui</em> containing (by analogy with the <em>tasks</em> directory) a file
CTaskMrBump.py containing a CTaskMrBump class that is a sub-class of
<em>CTaskWidget</em>.</div>
<div class="line"><em>docs</em> containing documentation</div>
</div>
<p>There is an alternative approach to this organisation: the project could
provide a function or perhaps a ‘resources’ file that lists what
resources (scripts, guis, docs) it wants to have ‘published’ in the
overall ccp4i2 system. But, if it is not too onerous on pipeline
developers, I think some standard organisation would help us to work
together.</p>
</section>
<section id="the-process-manager">
<h3 id="the-process-manager">The Process Manager<a class="headerlink" href="#the-process-manager" title="Permalink to this heading">¶</a></h3>
<p>The process manager currently just starts jobs on the local mchine but
is intended in future to be the interface to access batch queues and
remote resources etc.. There is one instance of a process manager for
each Python process but note that if that process is a pipeline there
may be many different plugins (instances of <em>CPluginScript</em>) run in that
one Python process. The developer implementing a plugin should not
normally need to access the process manager directly but the method
<em>PROCESSMANAGER().getJobData()</em> may be used to retrieve information on a
running job:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Modules</span>
<span class="n">status</span> <span class="o">=</span> <span class="n">CCP4Modules</span><span class="o">.</span><span class="n">PROCESSMANAGER</span><span class="p">()</span><span class="o">.</span><span class="n">getJobData</span><span class="p">(</span><span class="n">pid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">runningProcessId</span><span class="p">,</span><span class="n">attribute</span><span class="o">=</span><span class="s1">'exitStatus'</span><span class="p">)</span>
</pre></div>
</div>
<p>The pid is an integer and is i2’s internal unique id for a process.
<em>CPluginScript.runningProcessId</em> is the pid of the last process run by
the plugin. The attributes are listed below - a value of None will be
returned if the attribute is not set.</p>
<table>
<tbody>
<tr class="row-odd"><td><p>command</p></td>
<td><p>string</p></td>
<td><p>The name of the
executable</p></td>
</tr>
<tr class="row-even"><td><p>arglist</p></td>
<td><p>list of strings</p></td>
<td><p>The arguments to the
external program</p></td>
</tr>
<tr class="row-odd"><td><p>handler</p></td>
<td><p>Python command</p></td>
<td><p>Callback to be run after
external process
completed</p></td>
</tr>
<tr class="row-even"><td><p>jobId</p></td>
<td><p>string</p></td>
<td><p>The i2 database job id
(if provided)</p></td>
</tr>
<tr class="row-odd"><td><p>jobNumber</p></td>
<td><p>string</p></td>
<td><p>The i2 job number in the
form n[.m[.i]] (if
provided)</p></td>
</tr>
<tr class="row-even"><td><p>ifAsync</p></td>
<td><p>Boolean</p></td>
<td><p>Flag if process is to
run asynchronously</p></td>
</tr>
<tr class="row-odd"><td><p>timeout</p></td>
<td><p>float</p></td>
<td><p>The number of seconds to
wait for completion of a
job run in blocking mode</p></td>
</tr>
<tr class="row-even"><td><p>editEnv</p></td>
<td><p>list of list of strings</p></td>
<td><p>A list of edits to
subprocess environment</p></td>
</tr>
<tr class="row-odd"><td><p>inputFile</p></td>
<td><p>string</p></td>
<td><p>path to input command
file</p></td>
</tr>
<tr class="row-even"><td><p>logFile</p></td>
<td><p>string</p></td>
<td><p>path to ouput log file</p></td>
</tr>
<tr class="row-odd"><td><p>exitStatus</p></td>
<td><p>integer</p></td>
<td><p>0=OK,1=crashed</p></td>
</tr>
<tr class="row-even"><td><p>exitCode</p></td>
<td><p>integer</p></td>
<td><p>exit code of the last
process finished</p></td>
</tr>
<tr class="row-odd"><td><p>errorReport</p></td>
<td><p>CErrorReport</p></td>
<td><p>list of exceptions
caught in running the
process</p></td>
</tr>
<tr class="row-even"><td><p>startTime</p></td>
<td><p>float</p></td>
<td><p>The machine processor
time that process
started</p></td>
</tr>
<tr class="row-odd"><td><p>finishTime</p></td>
<td><p>float</p></td>
<td><p>The machine processor
time that process
finished</p></td>
</tr>
<tr class="row-even"><td><p>qprocess</p></td>
<td><p>Qt object</p></td>
<td><p>The QProcess that
supported the external
process (if this is used
rather than subprocess)</p></td>
</tr>
</tbody>
</table>
<p>By default external processes are run in blocking mode,
(<em>PROCESSMANAGER().startProcess()</em> does not return until the external
process has completed. The <em>ifAsync</em> flag is set from the
<em>CPluginScript.async</em> flag and if that is True then
<em>PROCESSMANAGER().startProcess()</em> will return immediately and the
pipieline could possible start more jobs. The Process Manager will only
start a limited number of asyncronous jobs at one time and will queue
any excess requests to start when other processes finish. The maximum
number of processes is set in the file
<em>$HOME/.CCP4I2/configs/ccp4i2_configs.params.xml</em> as
<em>maxRunningprocesses</em> parameter. (If the parameter is not in your file
then delete the file so a new one is created.) Note that if the user
starts multiple tasks then there could be many more running processes.</p>
<p>The <em>editEnv</em> argument is a list of edits applied to the current
environemnt. Each item in the list is a list. The first item in the
sub-list is an environment variable name. If the sub-list is length 1
(just the environment variable name) then that environment variable is
deleted; if the sublist is length 2 then the environment variable is set
to the second item in the list.</p>
</section>
<section id="xml-files">
<h3 id="xml-files">XML Files<a class="headerlink" href="#xml-files" title="Permalink to this heading">¶</a></h3>
<p>All of the XML files used by CCP4i2 have the same basic structure, for
example a parameter file..</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;?xml version='1.0' encoding='ASCII'?&gt;
&lt;ccp4:ccp4i2 xmlns:ccp4="http://www.ccp4.ac.uk/ccp4ns"&gt;
  &lt;ccp4i2_header&gt;
    &lt;function&gt;PARAMS&lt;/function&gt;
    &lt;ccp4iVersion&gt;0.0.5&lt;ccp4iVersion&gt;
    &lt;comment/&gt;
    &lt;hostName&gt;bilbo.chem.york.ac.uk&lt;/hostName&gt;
    &lt;userId&gt;lizp&lt;/userId&gt;
    &lt;creationTime&gt;11:06 20/Jun/14&lt;/creationTime&gt;
    &lt;projectName&gt;whokshop2&lt;/projectName&gt;
    &lt;jobId&gt;82d6e44af86211e39b3a3c0754185dfb&lt;/jobId&gt;
    &lt;jobNumber&gt;60&lt;/jobNumber&gt;
    &lt;projectId&gt;3a3041bdf16b11e38aeb3c0754185dfb&lt;/projectId&gt;
    &lt;pluginName&gt;prosmart_refmac&lt;/pluginName&gt;
    &lt;pluginTitle&gt;Refine with Prosmart-restrained Refmac&lt;/pluginTitle&gt;
  &lt;/ccp4i2_header&gt;
  &lt;ccp4i2_body&gt;
    &lt;inputData&gt;
      &lt;XYZIN&gt;
          ....
  &lt;/ccp4i2_body&gt;
&lt;/ccp4:ccp4i2&gt;
</pre></div>
</div>
<p>Here the root element is <em>ccp4i2</em> with an <em>xmlns</em> attribute that gives
the namespace as “<a class="reference external" href="http://www.ccp4.ac.uk/ccp4ns">http://www.ccp4.ac.uk/ccp4ns</a>”. The <em>ccp4i2</em> element
has two sub-elements: <em>ccp4i2_header</em> which contains metadata and
<em>ccp4i2_body</em> whose contents will depend of the type of file which is
specified by the <em>function</em> element in the header. The header usually
contains details of the program version and source of the file
(host,user, creation time) and, where appropriate, details of the
project and job that the file is associated with. The header is usually
written or read automatically by the <em>CCP4File.CI2XmlHeader</em> class and
developers should have little need to work directly with it.</p>
<p>There are some tools for handling XML files in CCP4i2. The Python
library for <em>lxml</em> is included and has many tools which are described at
<a class="reference external" href="http://lxml.de/index.html">lxml website</a>. The internal
representation of XML is as an <a class="reference external" href="lxml.de/tutorial.html">etree.Element</a>
for which there is brief (but likely enough for ccp4i2 developers)
documentation within the Python documentation
<a class="reference external" href="http://docs.python.org/2/library/xml.etree.elementtree.html#module-xml.etree.ElementTree">here</a>
(scroll down for Element). See also the comments in the CCP4i2
documentation for <a class="reference external" href="./reports.html#xml">Reports</a>. The <em>etree</em>
functionality is used to build up an internal representation of XML
which can be written to a file with the <em>CCP4Utils.saveEtreeToFile()</em>
module. An example to create a ‘program’ XML file in a CPluginScript:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">lxml</span> <span class="kn">import</span> <span class="n">etree</span>
<span class="kn">from</span> <span class="nn">core</span> <span class="kn">import</span> <span class="n">CCP4Utils</span>
<span class="c1"># Create a 'root' element and add a 'mode' subElement</span>
<span class="n">rootEle</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">Element</span><span class="p">(</span><span class="s1">'MYPROGRAM'</span><span class="p">)</span>
<span class="n">modeEle</span> <span class="o">=</span> <span class="n">etree</span><span class="o">.</span><span class="n">SubElement</span><span class="p">(</span><span class="n">rootEle</span><span class="p">,</span><span class="s1">'mode'</span><span class="p">)</span>
<span class="n">modeEle</span><span class="o">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">myMode</span>

<span class="c1"># Load data from another XML file and append it to our tree</span>
<span class="k">try</span><span class="p">:</span>
  <span class="n">otherXmlTree</span> <span class="o">=</span> <span class="n">CCP4Utils</span><span class="o">.</span><span class="n">openFileToEtree</span><span class="p">(</span><span class="o">..</span><span class="n">other</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">name</span><span class="o">..</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
  <span class="c1"># Report failure to read file</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">appendErrorReport</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span><span class="n">other</span><span class="o">-</span><span class="n">file</span><span class="o">-</span><span class="n">name</span><span class="p">,</span><span class="n">stack</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">rootEle</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">otherXmlTree</span><span class="p">)</span>

<span class="c1"># Save the xml tree to the 'PROGRAMXML' file</span>
<span class="n">CCP4Utils</span><span class="o">.</span><span class="n">saveEtreeToFile</span><span class="p">(</span><span class="n">rootEle</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">makeFileName</span><span class="p">(</span><span class="s1">'PROGRAMXML'</span><span class="p">))</span>
</pre></div>
</div>
<hr class="docutils"/>
<p>Last modified: Tue Sep 13 14:03:56 BST 2016</p>
</section>
</section>
</section>


          </article>
        </div>
      </div>
    </main>
  </div>
  <footer class="md-footer">
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
          
            <a href="task_guis.html" title="CCP4I2 Developers: Writing Task GUIs"
               class="md-flex md-footer-nav__link md-footer-nav__link--prev"
               rel="prev">
              <div class="md-flex__cell md-flex__cell--shrink">
                <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
              </div>
              <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
                <span class="md-flex__ellipsis">
                  <span
                      class="md-footer-nav__direction"> Previous </span> CCP4I2 Developers: Writing Task GUIs </span>
              </div>
            </a>
          
          
            <a href="reports.html" title="CCP4I2 Generating Reports"
               class="md-flex md-footer-nav__link md-footer-nav__link--next"
               rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title"><span
                class="md-flex__ellipsis"> <span
                class="md-footer-nav__direction"> Next </span> CCP4I2 Generating Reports </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink"><i
                class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          
        </a>
        
      </nav>
    </div>
    <div class="md-footer-meta md-typeset">
      <div class="md-footer-meta__inner md-grid">
        <div class="md-footer-copyright">
          <div class="md-footer-copyright__highlight">
              &#169; Copyright 2020, CCP4.
              
          </div>
            Created using
            <a href="http://www.sphinx-doc.org/">Sphinx</a> 5.2.2.
             and
            <a href="https://github.com/bashtage/sphinx-material/">Material for
              Sphinx</a>
        </div>
      </div>
    </div>
  </footer>
  <script src="../_static/javascripts/application.js"></script>
  <script>app.initialize({version: "1.0.4", url: {base: ".."}})</script>
  </body>
</html>